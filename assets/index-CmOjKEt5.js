(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const Fr="/api";let dn=null;function Oi(e){dn=e}function Ur(){dn=null}async function ne(e,t={}){const n={"Content-Type":"application/json",...t.headers};dn&&(n.Authorization=`Bearer ${dn}`);const r=await fetch(`${Fr}${e}`,{headers:n,credentials:"include",...t});if(!r.ok){const o=await r.json().catch(()=>({detail:"Unknown error"}));throw r.status===401&&Ur(),new Error(o.detail||`HTTP ${r.status}`)}return r.status===204?null:r.json()}const K={health:()=>ne("/health"),user:()=>ne("/user"),auth:{register:async e=>await ne("/auth/register",{method:"POST",body:JSON.stringify(e)}),login:async(e,t)=>{const n=await ne("/auth/login/json",{method:"POST",body:JSON.stringify({username:e,password:t})});return n.access_token&&Oi(n.access_token),n},logout:async()=>(Ur(),ne("/auth/logout",{method:"POST"})),me:()=>ne("/auth/me"),updateProfile:e=>ne("/auth/me",{method:"PUT",body:JSON.stringify(e)}),changePassword:(e,t)=>ne("/auth/change-password",{method:"POST",body:JSON.stringify({current_password:e,new_password:t})}),listUsers:(e=0,t=100,n=null)=>{const r=new URLSearchParams({skip:e,limit:t});return n&&r.append("search",n),ne(`/auth/users?${r}`)},createUser:e=>ne("/auth/users",{method:"POST",body:JSON.stringify(e)}),getUser:e=>ne(`/auth/users/${e}`),updateUser:(e,t)=>ne(`/auth/users/${e}`,{method:"PUT",body:JSON.stringify(t)}),deleteUser:e=>ne(`/auth/users/${e}`,{method:"DELETE"}),resetPassword:(e,t)=>ne(`/auth/users/${e}/reset-password?new_password=${encodeURIComponent(t)}`,{method:"POST"}),googleEnabled:()=>ne("/auth/google/enabled"),googleLogin:()=>{window.location.href=`${Fr}/auth/google/login`}},bibmaps:{list:()=>ne("/bibmaps/"),create:e=>ne("/bibmaps/",{method:"POST",body:JSON.stringify(e)}),get:e=>ne(`/bibmaps/${e}`),getPublic:e=>ne(`/bibmaps/public/${e}`),update:(e,t)=>ne(`/bibmaps/${e}`,{method:"PUT",body:JSON.stringify(t)}),delete:e=>ne(`/bibmaps/${e}`,{method:"DELETE"}),publish:e=>ne(`/bibmaps/${e}/publish`,{method:"PUT"}),unpublish:e=>ne(`/bibmaps/${e}/unpublish`,{method:"PUT"})},nodes:{create:e=>ne("/nodes/",{method:"POST",body:JSON.stringify(e)}),get:e=>ne(`/nodes/${e}`),update:(e,t)=>ne(`/nodes/${e}`,{method:"PUT",body:JSON.stringify(t)}),delete:e=>ne(`/nodes/${e}`,{method:"DELETE"}),updatePosition:(e,t,n)=>ne(`/nodes/${e}/position?x=${t}&y=${n}`,{method:"PUT"}),updateSize:(e,t,n)=>ne(`/nodes/${e}/size?width=${t}&height=${n}`,{method:"PUT"}),getReferences:e=>ne(`/nodes/${e}/references`),getMedia:e=>ne(`/nodes/${e}/media`),getPublicReferences:e=>ne(`/nodes/public/${e}/references`),getPublicMedia:e=>ne(`/nodes/public/${e}/media`)},connections:{create:e=>ne("/connections/",{method:"POST",body:JSON.stringify(e)}),get:e=>ne(`/connections/${e}`),update:(e,t)=>ne(`/connections/${e}`,{method:"PUT",body:JSON.stringify(t)}),delete:e=>ne(`/connections/${e}`,{method:"DELETE"})},taxonomies:{list:()=>ne("/taxonomies/"),create:e=>ne("/taxonomies/",{method:"POST",body:JSON.stringify(e)}),get:e=>ne(`/taxonomies/${e}`),update:(e,t)=>ne(`/taxonomies/${e}`,{method:"PUT",body:JSON.stringify(t)}),delete:e=>ne(`/taxonomies/${e}`,{method:"DELETE"}),getReferences:e=>ne(`/taxonomies/${e}/references`),getNodes:e=>ne(`/taxonomies/${e}/nodes`)},references:{list:(e=null)=>{const t=e?`?taxonomy_id=${e}`:"";return ne(`/references/${t}`)},create:e=>ne("/references/",{method:"POST",body:JSON.stringify(e)}),get:e=>ne(`/references/${e}`),update:(e,t)=>ne(`/references/${e}`,{method:"PUT",body:JSON.stringify(t)}),updateBibtex:(e,t)=>ne(`/references/${e}/bibtex`,{method:"PUT",body:JSON.stringify({bibtex_content:t})}),delete:e=>ne(`/references/${e}`,{method:"DELETE"}),import:(e,t=[],n=null)=>ne("/references/import",{method:"POST",body:JSON.stringify({bibtex_content:e,taxonomy_ids:t,legend_category:n})})},media:{list:(e=null)=>{const t=e?`?taxonomy_id=${e}`:"";return ne(`/media/${t}`)},create:e=>ne("/media/",{method:"POST",body:JSON.stringify(e)}),get:e=>ne(`/media/${e}`),update:(e,t)=>ne(`/media/${e}`,{method:"PUT",body:JSON.stringify(t)}),delete:e=>ne(`/media/${e}`,{method:"DELETE"})},settings:{get:()=>ne("/settings"),update:e=>ne("/settings",{method:"PUT",body:JSON.stringify(e)}),reset:()=>ne("/settings/reset",{method:"POST"})}};var Pi={value:()=>{}};function En(){for(var e=0,t=arguments.length,n={},r;e<t;++e){if(!(r=arguments[e]+"")||r in n||/[\s.]/.test(r))throw new Error("illegal type: "+r);n[r]=[]}return new nn(n)}function nn(e){this._=e}function Ri(e,t){return e.trim().split(/^|\s+/).map(function(n){var r="",o=n.indexOf(".");if(o>=0&&(r=n.slice(o+1),n=n.slice(0,o)),n&&!t.hasOwnProperty(n))throw new Error("unknown type: "+n);return{type:n,name:r}})}nn.prototype=En.prototype={constructor:nn,on:function(e,t){var n=this._,r=Ri(e+"",n),o,a=-1,i=r.length;if(arguments.length<2){for(;++a<i;)if((o=(e=r[a]).type)&&(o=Fi(n[o],e.name)))return o;return}if(t!=null&&typeof t!="function")throw new Error("invalid callback: "+t);for(;++a<i;)if(o=(e=r[a]).type)n[o]=mr(n[o],e.name,t);else if(t==null)for(o in n)n[o]=mr(n[o],e.name,null);return this},copy:function(){var e={},t=this._;for(var n in t)e[n]=t[n].slice();return new nn(e)},call:function(e,t){if((o=arguments.length-2)>0)for(var n=new Array(o),r=0,o,a;r<o;++r)n[r]=arguments[r+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(a=this._[e],r=0,o=a.length;r<o;++r)a[r].value.apply(t,n)},apply:function(e,t,n){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var r=this._[e],o=0,a=r.length;o<a;++o)r[o].value.apply(t,n)}};function Fi(e,t){for(var n=0,r=e.length,o;n<r;++n)if((o=e[n]).name===t)return o.value}function mr(e,t,n){for(var r=0,o=e.length;r<o;++r)if(e[r].name===t){e[r]=Pi,e=e.slice(0,r).concat(e.slice(r+1));break}return n!=null&&e.push({name:t,value:n}),e}var Rn="http://www.w3.org/1999/xhtml";const pr={svg:"http://www.w3.org/2000/svg",xhtml:Rn,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function kn(e){var t=e+="",n=t.indexOf(":");return n>=0&&(t=e.slice(0,n))!=="xmlns"&&(e=e.slice(n+1)),pr.hasOwnProperty(t)?{space:pr[t],local:e}:e}function Ui(e){return function(){var t=this.ownerDocument,n=this.namespaceURI;return n===Rn&&t.documentElement.namespaceURI===Rn?t.createElement(e):t.createElementNS(n,e)}}function Hi(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function Hr(e){var t=kn(e);return(t.local?Hi:Ui)(t)}function ji(){}function er(e){return e==null?ji:function(){return this.querySelector(e)}}function Wi(e){typeof e!="function"&&(e=er(e));for(var t=this._groups,n=t.length,r=new Array(n),o=0;o<n;++o)for(var a=t[o],i=a.length,s=r[o]=new Array(i),l,u,h=0;h<i;++h)(l=a[h])&&(u=e.call(l,l.__data__,h,a))&&("__data__"in l&&(u.__data__=l.__data__),s[h]=u);return new Ce(r,this._parents)}function Zi(e){return e==null?[]:Array.isArray(e)?e:Array.from(e)}function qi(){return[]}function jr(e){return e==null?qi:function(){return this.querySelectorAll(e)}}function Xi(e){return function(){return Zi(e.apply(this,arguments))}}function Yi(e){typeof e=="function"?e=Xi(e):e=jr(e);for(var t=this._groups,n=t.length,r=[],o=[],a=0;a<n;++a)for(var i=t[a],s=i.length,l,u=0;u<s;++u)(l=i[u])&&(r.push(e.call(l,l.__data__,u,i)),o.push(l));return new Ce(r,o)}function Wr(e){return function(){return this.matches(e)}}function Zr(e){return function(t){return t.matches(e)}}var Gi=Array.prototype.find;function Ji(e){return function(){return Gi.call(this.children,e)}}function Vi(){return this.firstElementChild}function Ki(e){return this.select(e==null?Vi:Ji(typeof e=="function"?e:Zr(e)))}var Qi=Array.prototype.filter;function ea(){return Array.from(this.children)}function ta(e){return function(){return Qi.call(this.children,e)}}function na(e){return this.selectAll(e==null?ea:ta(typeof e=="function"?e:Zr(e)))}function ra(e){typeof e!="function"&&(e=Wr(e));for(var t=this._groups,n=t.length,r=new Array(n),o=0;o<n;++o)for(var a=t[o],i=a.length,s=r[o]=[],l,u=0;u<i;++u)(l=a[u])&&e.call(l,l.__data__,u,a)&&s.push(l);return new Ce(r,this._parents)}function qr(e){return new Array(e.length)}function ia(){return new Ce(this._enter||this._groups.map(qr),this._parents)}function un(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}un.prototype={constructor:un,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}};function aa(e){return function(){return e}}function oa(e,t,n,r,o,a){for(var i=0,s,l=t.length,u=a.length;i<u;++i)(s=t[i])?(s.__data__=a[i],r[i]=s):n[i]=new un(e,a[i]);for(;i<l;++i)(s=t[i])&&(o[i]=s)}function sa(e,t,n,r,o,a,i){var s,l,u=new Map,h=t.length,g=a.length,b=new Array(h),m;for(s=0;s<h;++s)(l=t[s])&&(b[s]=m=i.call(l,l.__data__,s,t)+"",u.has(m)?o[s]=l:u.set(m,l));for(s=0;s<g;++s)m=i.call(e,a[s],s,a)+"",(l=u.get(m))?(r[s]=l,l.__data__=a[s],u.delete(m)):n[s]=new un(e,a[s]);for(s=0;s<h;++s)(l=t[s])&&u.get(b[s])===l&&(o[s]=l)}function la(e){return e.__data__}function ca(e,t){if(!arguments.length)return Array.from(this,la);var n=t?sa:oa,r=this._parents,o=this._groups;typeof e!="function"&&(e=aa(e));for(var a=o.length,i=new Array(a),s=new Array(a),l=new Array(a),u=0;u<a;++u){var h=r[u],g=o[u],b=g.length,m=da(e.call(h,h&&h.__data__,u,r)),w=m.length,p=s[u]=new Array(w),v=i[u]=new Array(w),y=l[u]=new Array(b);n(h,g,p,v,y,m,t);for(var E=0,f=0,_,I;E<w;++E)if(_=p[E]){for(E>=f&&(f=E+1);!(I=v[f])&&++f<w;);_._next=I||null}}return i=new Ce(i,r),i._enter=s,i._exit=l,i}function da(e){return typeof e=="object"&&"length"in e?e:Array.from(e)}function ua(){return new Ce(this._exit||this._groups.map(qr),this._parents)}function ha(e,t,n){var r=this.enter(),o=this,a=this.exit();return typeof e=="function"?(r=e(r),r&&(r=r.selection())):r=r.append(e+""),t!=null&&(o=t(o),o&&(o=o.selection())),n==null?a.remove():n(a),r&&o?r.merge(o).order():o}function fa(e){for(var t=e.selection?e.selection():e,n=this._groups,r=t._groups,o=n.length,a=r.length,i=Math.min(o,a),s=new Array(o),l=0;l<i;++l)for(var u=n[l],h=r[l],g=u.length,b=s[l]=new Array(g),m,w=0;w<g;++w)(m=u[w]||h[w])&&(b[w]=m);for(;l<o;++l)s[l]=n[l];return new Ce(s,this._parents)}function ma(){for(var e=this._groups,t=-1,n=e.length;++t<n;)for(var r=e[t],o=r.length-1,a=r[o],i;--o>=0;)(i=r[o])&&(a&&i.compareDocumentPosition(a)^4&&a.parentNode.insertBefore(i,a),a=i);return this}function pa(e){e||(e=ga);function t(g,b){return g&&b?e(g.__data__,b.__data__):!g-!b}for(var n=this._groups,r=n.length,o=new Array(r),a=0;a<r;++a){for(var i=n[a],s=i.length,l=o[a]=new Array(s),u,h=0;h<s;++h)(u=i[h])&&(l[h]=u);l.sort(t)}return new Ce(o,this._parents).order()}function ga(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function ya(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this}function _a(){return Array.from(this)}function ba(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var r=e[t],o=0,a=r.length;o<a;++o){var i=r[o];if(i)return i}return null}function va(){let e=0;for(const t of this)++e;return e}function wa(){return!this.node()}function xa(e){for(var t=this._groups,n=0,r=t.length;n<r;++n)for(var o=t[n],a=0,i=o.length,s;a<i;++a)(s=o[a])&&e.call(s,s.__data__,a,o);return this}function Ea(e){return function(){this.removeAttribute(e)}}function ka(e){return function(){this.removeAttributeNS(e.space,e.local)}}function Ia(e,t){return function(){this.setAttribute(e,t)}}function Ba(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}function Ca(e,t){return function(){var n=t.apply(this,arguments);n==null?this.removeAttribute(e):this.setAttribute(e,n)}}function Sa(e,t){return function(){var n=t.apply(this,arguments);n==null?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,n)}}function La(e,t){var n=kn(e);if(arguments.length<2){var r=this.node();return n.local?r.getAttributeNS(n.space,n.local):r.getAttribute(n)}return this.each((t==null?n.local?ka:Ea:typeof t=="function"?n.local?Sa:Ca:n.local?Ba:Ia)(n,t))}function Xr(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function $a(e){return function(){this.style.removeProperty(e)}}function Aa(e,t,n){return function(){this.style.setProperty(e,t,n)}}function Ta(e,t,n){return function(){var r=t.apply(this,arguments);r==null?this.style.removeProperty(e):this.style.setProperty(e,r,n)}}function za(e,t,n){return arguments.length>1?this.each((t==null?$a:typeof t=="function"?Ta:Aa)(e,t,n??"")):pt(this.node(),e)}function pt(e,t){return e.style.getPropertyValue(t)||Xr(e).getComputedStyle(e,null).getPropertyValue(t)}function Na(e){return function(){delete this[e]}}function Ma(e,t){return function(){this[e]=t}}function Da(e,t){return function(){var n=t.apply(this,arguments);n==null?delete this[e]:this[e]=n}}function Oa(e,t){return arguments.length>1?this.each((t==null?Na:typeof t=="function"?Da:Ma)(e,t)):this.node()[e]}function Yr(e){return e.trim().split(/^|\s+/)}function tr(e){return e.classList||new Gr(e)}function Gr(e){this._node=e,this._names=Yr(e.getAttribute("class")||"")}Gr.prototype={add:function(e){var t=this._names.indexOf(e);t<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};function Jr(e,t){for(var n=tr(e),r=-1,o=t.length;++r<o;)n.add(t[r])}function Vr(e,t){for(var n=tr(e),r=-1,o=t.length;++r<o;)n.remove(t[r])}function Pa(e){return function(){Jr(this,e)}}function Ra(e){return function(){Vr(this,e)}}function Fa(e,t){return function(){(t.apply(this,arguments)?Jr:Vr)(this,e)}}function Ua(e,t){var n=Yr(e+"");if(arguments.length<2){for(var r=tr(this.node()),o=-1,a=n.length;++o<a;)if(!r.contains(n[o]))return!1;return!0}return this.each((typeof t=="function"?Fa:t?Pa:Ra)(n,t))}function Ha(){this.textContent=""}function ja(e){return function(){this.textContent=e}}function Wa(e){return function(){var t=e.apply(this,arguments);this.textContent=t??""}}function Za(e){return arguments.length?this.each(e==null?Ha:(typeof e=="function"?Wa:ja)(e)):this.node().textContent}function qa(){this.innerHTML=""}function Xa(e){return function(){this.innerHTML=e}}function Ya(e){return function(){var t=e.apply(this,arguments);this.innerHTML=t??""}}function Ga(e){return arguments.length?this.each(e==null?qa:(typeof e=="function"?Ya:Xa)(e)):this.node().innerHTML}function Ja(){this.nextSibling&&this.parentNode.appendChild(this)}function Va(){return this.each(Ja)}function Ka(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Qa(){return this.each(Ka)}function eo(e){var t=typeof e=="function"?e:Hr(e);return this.select(function(){return this.appendChild(t.apply(this,arguments))})}function to(){return null}function no(e,t){var n=typeof e=="function"?e:Hr(e),r=t==null?to:typeof t=="function"?t:er(t);return this.select(function(){return this.insertBefore(n.apply(this,arguments),r.apply(this,arguments)||null)})}function ro(){var e=this.parentNode;e&&e.removeChild(this)}function io(){return this.each(ro)}function ao(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function oo(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function so(e){return this.select(e?oo:ao)}function lo(e){return arguments.length?this.property("__data__",e):this.node().__data__}function co(e){return function(t){e.call(this,t,this.__data__)}}function uo(e){return e.trim().split(/^|\s+/).map(function(t){var n="",r=t.indexOf(".");return r>=0&&(n=t.slice(r+1),t=t.slice(0,r)),{type:t,name:n}})}function ho(e){return function(){var t=this.__on;if(t){for(var n=0,r=-1,o=t.length,a;n<o;++n)a=t[n],(!e.type||a.type===e.type)&&a.name===e.name?this.removeEventListener(a.type,a.listener,a.options):t[++r]=a;++r?t.length=r:delete this.__on}}}function fo(e,t,n){return function(){var r=this.__on,o,a=co(t);if(r){for(var i=0,s=r.length;i<s;++i)if((o=r[i]).type===e.type&&o.name===e.name){this.removeEventListener(o.type,o.listener,o.options),this.addEventListener(o.type,o.listener=a,o.options=n),o.value=t;return}}this.addEventListener(e.type,a,n),o={type:e.type,name:e.name,value:t,listener:a,options:n},r?r.push(o):this.__on=[o]}}function mo(e,t,n){var r=uo(e+""),o,a=r.length,i;if(arguments.length<2){var s=this.node().__on;if(s){for(var l=0,u=s.length,h;l<u;++l)for(o=0,h=s[l];o<a;++o)if((i=r[o]).type===h.type&&i.name===h.name)return h.value}return}for(s=t?fo:ho,o=0;o<a;++o)this.each(s(r[o],t,n));return this}function Kr(e,t,n){var r=Xr(e),o=r.CustomEvent;typeof o=="function"?o=new o(t,n):(o=r.document.createEvent("Event"),n?(o.initEvent(t,n.bubbles,n.cancelable),o.detail=n.detail):o.initEvent(t,!1,!1)),e.dispatchEvent(o)}function po(e,t){return function(){return Kr(this,e,t)}}function go(e,t){return function(){return Kr(this,e,t.apply(this,arguments))}}function yo(e,t){return this.each((typeof t=="function"?go:po)(e,t))}function*_o(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var r=e[t],o=0,a=r.length,i;o<a;++o)(i=r[o])&&(yield i)}var Qr=[null];function Ce(e,t){this._groups=e,this._parents=t}function Ft(){return new Ce([[document.documentElement]],Qr)}function bo(){return this}Ce.prototype=Ft.prototype={constructor:Ce,select:Wi,selectAll:Yi,selectChild:Ki,selectChildren:na,filter:ra,data:ca,enter:ia,exit:ua,join:ha,merge:fa,selection:bo,order:ma,sort:pa,call:ya,nodes:_a,node:ba,size:va,empty:wa,each:xa,attr:La,style:za,property:Oa,classed:Ua,text:Za,html:Ga,raise:Va,lower:Qa,append:eo,insert:no,remove:io,clone:so,datum:lo,on:mo,dispatch:yo,[Symbol.iterator]:_o};function Le(e){return typeof e=="string"?new Ce([[document.querySelector(e)]],[document.documentElement]):new Ce([[e]],Qr)}function vo(e){let t;for(;t=e.sourceEvent;)e=t;return e}function Re(e,t){if(e=vo(e),t===void 0&&(t=e.currentTarget),t){var n=t.ownerSVGElement||t;if(n.createSVGPoint){var r=n.createSVGPoint();return r.x=e.clientX,r.y=e.clientY,r=r.matrixTransform(t.getScreenCTM().inverse()),[r.x,r.y]}if(t.getBoundingClientRect){var o=t.getBoundingClientRect();return[e.clientX-o.left-t.clientLeft,e.clientY-o.top-t.clientTop]}}return[e.pageX,e.pageY]}const wo={passive:!1},At={capture:!0,passive:!1};function Nn(e){e.stopImmediatePropagation()}function ht(e){e.preventDefault(),e.stopImmediatePropagation()}function ei(e){var t=e.document.documentElement,n=Le(e).on("dragstart.drag",ht,At);"onselectstart"in t?n.on("selectstart.drag",ht,At):(t.__noselect=t.style.MozUserSelect,t.style.MozUserSelect="none")}function ti(e,t){var n=e.document.documentElement,r=Le(e).on("dragstart.drag",null);t&&(r.on("click.drag",ht,At),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in n?r.on("selectstart.drag",null):(n.style.MozUserSelect=n.__noselect,delete n.__noselect)}const Wt=e=>()=>e;function Fn(e,{sourceEvent:t,subject:n,target:r,identifier:o,active:a,x:i,y:s,dx:l,dy:u,dispatch:h}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},subject:{value:n,enumerable:!0,configurable:!0},target:{value:r,enumerable:!0,configurable:!0},identifier:{value:o,enumerable:!0,configurable:!0},active:{value:a,enumerable:!0,configurable:!0},x:{value:i,enumerable:!0,configurable:!0},y:{value:s,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:u,enumerable:!0,configurable:!0},_:{value:h}})}Fn.prototype.on=function(){var e=this._.on.apply(this._,arguments);return e===this._?this:e};function xo(e){return!e.ctrlKey&&!e.button}function Eo(){return this.parentNode}function ko(e,t){return t??{x:e.x,y:e.y}}function Io(){return navigator.maxTouchPoints||"ontouchstart"in this}function gr(){var e=xo,t=Eo,n=ko,r=Io,o={},a=En("start","drag","end"),i=0,s,l,u,h,g=0;function b(_){_.on("mousedown.drag",m).filter(r).on("touchstart.drag",v).on("touchmove.drag",y,wo).on("touchend.drag touchcancel.drag",E).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function m(_,I){if(!(h||!e.call(this,_,I))){var N=f(this,t.call(this,_,I),_,I,"mouse");N&&(Le(_.view).on("mousemove.drag",w,At).on("mouseup.drag",p,At),ei(_.view),Nn(_),u=!1,s=_.clientX,l=_.clientY,N("start",_))}}function w(_){if(ht(_),!u){var I=_.clientX-s,N=_.clientY-l;u=I*I+N*N>g}o.mouse("drag",_)}function p(_){Le(_.view).on("mousemove.drag mouseup.drag",null),ti(_.view,u),ht(_),o.mouse("end",_)}function v(_,I){if(e.call(this,_,I)){var N=_.changedTouches,A=t.call(this,_,I),U=N.length,M,W;for(M=0;M<U;++M)(W=f(this,A,_,I,N[M].identifier,N[M]))&&(Nn(_),W("start",_,N[M]))}}function y(_){var I=_.changedTouches,N=I.length,A,U;for(A=0;A<N;++A)(U=o[I[A].identifier])&&(ht(_),U("drag",_,I[A]))}function E(_){var I=_.changedTouches,N=I.length,A,U;for(h&&clearTimeout(h),h=setTimeout(function(){h=null},500),A=0;A<N;++A)(U=o[I[A].identifier])&&(Nn(_),U("end",_,I[A]))}function f(_,I,N,A,U,M){var W=a.copy(),ee=Re(M||N,I),B,R,c;if((c=n.call(_,new Fn("beforestart",{sourceEvent:N,target:b,identifier:U,active:i,x:ee[0],y:ee[1],dx:0,dy:0,dispatch:W}),A))!=null)return B=c.x-ee[0]||0,R=c.y-ee[1]||0,function S(D,z,J){var P=ee,q;switch(D){case"start":o[U]=S,q=i++;break;case"end":delete o[U],--i;case"drag":ee=Re(J||z,I),q=i;break}W.call(D,_,new Fn(D,{sourceEvent:z,subject:c,target:b,identifier:U,active:q,x:ee[0]+B,y:ee[1]+R,dx:ee[0]-P[0],dy:ee[1]-P[1],dispatch:W}),A)}}return b.filter=function(_){return arguments.length?(e=typeof _=="function"?_:Wt(!!_),b):e},b.container=function(_){return arguments.length?(t=typeof _=="function"?_:Wt(_),b):t},b.subject=function(_){return arguments.length?(n=typeof _=="function"?_:Wt(_),b):n},b.touchable=function(_){return arguments.length?(r=typeof _=="function"?_:Wt(!!_),b):r},b.on=function(){var _=a.on.apply(a,arguments);return _===a?b:_},b.clickDistance=function(_){return arguments.length?(g=(_=+_)*_,b):Math.sqrt(g)},b}function nr(e,t,n){e.prototype=t.prototype=n,n.constructor=e}function ni(e,t){var n=Object.create(e.prototype);for(var r in t)n[r]=t[r];return n}function Ut(){}var Tt=.7,hn=1/Tt,ft="\\s*([+-]?\\d+)\\s*",zt="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",He="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Bo=/^#([0-9a-f]{3,8})$/,Co=new RegExp(`^rgb\\(${ft},${ft},${ft}\\)$`),So=new RegExp(`^rgb\\(${He},${He},${He}\\)$`),Lo=new RegExp(`^rgba\\(${ft},${ft},${ft},${zt}\\)$`),$o=new RegExp(`^rgba\\(${He},${He},${He},${zt}\\)$`),Ao=new RegExp(`^hsl\\(${zt},${He},${He}\\)$`),To=new RegExp(`^hsla\\(${zt},${He},${He},${zt}\\)$`),yr={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};nr(Ut,Nt,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:_r,formatHex:_r,formatHex8:zo,formatHsl:No,formatRgb:br,toString:br});function _r(){return this.rgb().formatHex()}function zo(){return this.rgb().formatHex8()}function No(){return ri(this).formatHsl()}function br(){return this.rgb().formatRgb()}function Nt(e){var t,n;return e=(e+"").trim().toLowerCase(),(t=Bo.exec(e))?(n=t[1].length,t=parseInt(t[1],16),n===6?vr(t):n===3?new we(t>>8&15|t>>4&240,t>>4&15|t&240,(t&15)<<4|t&15,1):n===8?Zt(t>>24&255,t>>16&255,t>>8&255,(t&255)/255):n===4?Zt(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|t&240,((t&15)<<4|t&15)/255):null):(t=Co.exec(e))?new we(t[1],t[2],t[3],1):(t=So.exec(e))?new we(t[1]*255/100,t[2]*255/100,t[3]*255/100,1):(t=Lo.exec(e))?Zt(t[1],t[2],t[3],t[4]):(t=$o.exec(e))?Zt(t[1]*255/100,t[2]*255/100,t[3]*255/100,t[4]):(t=Ao.exec(e))?Er(t[1],t[2]/100,t[3]/100,1):(t=To.exec(e))?Er(t[1],t[2]/100,t[3]/100,t[4]):yr.hasOwnProperty(e)?vr(yr[e]):e==="transparent"?new we(NaN,NaN,NaN,0):null}function vr(e){return new we(e>>16&255,e>>8&255,e&255,1)}function Zt(e,t,n,r){return r<=0&&(e=t=n=NaN),new we(e,t,n,r)}function Mo(e){return e instanceof Ut||(e=Nt(e)),e?(e=e.rgb(),new we(e.r,e.g,e.b,e.opacity)):new we}function Un(e,t,n,r){return arguments.length===1?Mo(e):new we(e,t,n,r??1)}function we(e,t,n,r){this.r=+e,this.g=+t,this.b=+n,this.opacity=+r}nr(we,Un,ni(Ut,{brighter(e){return e=e==null?hn:Math.pow(hn,e),new we(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=e==null?Tt:Math.pow(Tt,e),new we(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new we(rt(this.r),rt(this.g),rt(this.b),fn(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:wr,formatHex:wr,formatHex8:Do,formatRgb:xr,toString:xr}));function wr(){return`#${nt(this.r)}${nt(this.g)}${nt(this.b)}`}function Do(){return`#${nt(this.r)}${nt(this.g)}${nt(this.b)}${nt((isNaN(this.opacity)?1:this.opacity)*255)}`}function xr(){const e=fn(this.opacity);return`${e===1?"rgb(":"rgba("}${rt(this.r)}, ${rt(this.g)}, ${rt(this.b)}${e===1?")":`, ${e})`}`}function fn(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function rt(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function nt(e){return e=rt(e),(e<16?"0":"")+e.toString(16)}function Er(e,t,n,r){return r<=0?e=t=n=NaN:n<=0||n>=1?e=t=NaN:t<=0&&(e=NaN),new Ne(e,t,n,r)}function ri(e){if(e instanceof Ne)return new Ne(e.h,e.s,e.l,e.opacity);if(e instanceof Ut||(e=Nt(e)),!e)return new Ne;if(e instanceof Ne)return e;e=e.rgb();var t=e.r/255,n=e.g/255,r=e.b/255,o=Math.min(t,n,r),a=Math.max(t,n,r),i=NaN,s=a-o,l=(a+o)/2;return s?(t===a?i=(n-r)/s+(n<r)*6:n===a?i=(r-t)/s+2:i=(t-n)/s+4,s/=l<.5?a+o:2-a-o,i*=60):s=l>0&&l<1?0:i,new Ne(i,s,l,e.opacity)}function Oo(e,t,n,r){return arguments.length===1?ri(e):new Ne(e,t,n,r??1)}function Ne(e,t,n,r){this.h=+e,this.s=+t,this.l=+n,this.opacity=+r}nr(Ne,Oo,ni(Ut,{brighter(e){return e=e==null?hn:Math.pow(hn,e),new Ne(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=e==null?Tt:Math.pow(Tt,e),new Ne(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+(this.h<0)*360,t=isNaN(e)||isNaN(this.s)?0:this.s,n=this.l,r=n+(n<.5?n:1-n)*t,o=2*n-r;return new we(Mn(e>=240?e-240:e+120,o,r),Mn(e,o,r),Mn(e<120?e+240:e-120,o,r),this.opacity)},clamp(){return new Ne(kr(this.h),qt(this.s),qt(this.l),fn(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const e=fn(this.opacity);return`${e===1?"hsl(":"hsla("}${kr(this.h)}, ${qt(this.s)*100}%, ${qt(this.l)*100}%${e===1?")":`, ${e})`}`}}));function kr(e){return e=(e||0)%360,e<0?e+360:e}function qt(e){return Math.max(0,Math.min(1,e||0))}function Mn(e,t,n){return(e<60?t+(n-t)*e/60:e<180?n:e<240?t+(n-t)*(240-e)/60:t)*255}const ii=e=>()=>e;function Po(e,t){return function(n){return e+n*t}}function Ro(e,t,n){return e=Math.pow(e,n),t=Math.pow(t,n)-e,n=1/n,function(r){return Math.pow(e+r*t,n)}}function Fo(e){return(e=+e)==1?ai:function(t,n){return n-t?Ro(t,n,e):ii(isNaN(t)?n:t)}}function ai(e,t){var n=t-e;return n?Po(e,n):ii(isNaN(e)?t:e)}const Ir=function e(t){var n=Fo(t);function r(o,a){var i=n((o=Un(o)).r,(a=Un(a)).r),s=n(o.g,a.g),l=n(o.b,a.b),u=ai(o.opacity,a.opacity);return function(h){return o.r=i(h),o.g=s(h),o.b=l(h),o.opacity=u(h),o+""}}return r.gamma=e,r}(1);function Ve(e,t){return e=+e,t=+t,function(n){return e*(1-n)+t*n}}var Hn=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Dn=new RegExp(Hn.source,"g");function Uo(e){return function(){return e}}function Ho(e){return function(t){return e(t)+""}}function jo(e,t){var n=Hn.lastIndex=Dn.lastIndex=0,r,o,a,i=-1,s=[],l=[];for(e=e+"",t=t+"";(r=Hn.exec(e))&&(o=Dn.exec(t));)(a=o.index)>n&&(a=t.slice(n,a),s[i]?s[i]+=a:s[++i]=a),(r=r[0])===(o=o[0])?s[i]?s[i]+=o:s[++i]=o:(s[++i]=null,l.push({i,x:Ve(r,o)})),n=Dn.lastIndex;return n<t.length&&(a=t.slice(n),s[i]?s[i]+=a:s[++i]=a),s.length<2?l[0]?Ho(l[0].x):Uo(t):(t=l.length,function(u){for(var h=0,g;h<t;++h)s[(g=l[h]).i]=g.x(u);return s.join("")})}var Br=180/Math.PI,jn={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function oi(e,t,n,r,o,a){var i,s,l;return(i=Math.sqrt(e*e+t*t))&&(e/=i,t/=i),(l=e*n+t*r)&&(n-=e*l,r-=t*l),(s=Math.sqrt(n*n+r*r))&&(n/=s,r/=s,l/=s),e*r<t*n&&(e=-e,t=-t,l=-l,i=-i),{translateX:o,translateY:a,rotate:Math.atan2(t,e)*Br,skewX:Math.atan(l)*Br,scaleX:i,scaleY:s}}var Xt;function Wo(e){const t=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(e+"");return t.isIdentity?jn:oi(t.a,t.b,t.c,t.d,t.e,t.f)}function Zo(e){return e==null||(Xt||(Xt=document.createElementNS("http://www.w3.org/2000/svg","g")),Xt.setAttribute("transform",e),!(e=Xt.transform.baseVal.consolidate()))?jn:(e=e.matrix,oi(e.a,e.b,e.c,e.d,e.e,e.f))}function si(e,t,n,r){function o(u){return u.length?u.pop()+" ":""}function a(u,h,g,b,m,w){if(u!==g||h!==b){var p=m.push("translate(",null,t,null,n);w.push({i:p-4,x:Ve(u,g)},{i:p-2,x:Ve(h,b)})}else(g||b)&&m.push("translate("+g+t+b+n)}function i(u,h,g,b){u!==h?(u-h>180?h+=360:h-u>180&&(u+=360),b.push({i:g.push(o(g)+"rotate(",null,r)-2,x:Ve(u,h)})):h&&g.push(o(g)+"rotate("+h+r)}function s(u,h,g,b){u!==h?b.push({i:g.push(o(g)+"skewX(",null,r)-2,x:Ve(u,h)}):h&&g.push(o(g)+"skewX("+h+r)}function l(u,h,g,b,m,w){if(u!==g||h!==b){var p=m.push(o(m)+"scale(",null,",",null,")");w.push({i:p-4,x:Ve(u,g)},{i:p-2,x:Ve(h,b)})}else(g!==1||b!==1)&&m.push(o(m)+"scale("+g+","+b+")")}return function(u,h){var g=[],b=[];return u=e(u),h=e(h),a(u.translateX,u.translateY,h.translateX,h.translateY,g,b),i(u.rotate,h.rotate,g,b),s(u.skewX,h.skewX,g,b),l(u.scaleX,u.scaleY,h.scaleX,h.scaleY,g,b),u=h=null,function(m){for(var w=-1,p=b.length,v;++w<p;)g[(v=b[w]).i]=v.x(m);return g.join("")}}}var qo=si(Wo,"px, ","px)","deg)"),Xo=si(Zo,", ",")",")"),Yo=1e-12;function Cr(e){return((e=Math.exp(e))+1/e)/2}function Go(e){return((e=Math.exp(e))-1/e)/2}function Jo(e){return((e=Math.exp(2*e))-1)/(e+1)}const Vo=function e(t,n,r){function o(a,i){var s=a[0],l=a[1],u=a[2],h=i[0],g=i[1],b=i[2],m=h-s,w=g-l,p=m*m+w*w,v,y;if(p<Yo)y=Math.log(b/u)/t,v=function(A){return[s+A*m,l+A*w,u*Math.exp(t*A*y)]};else{var E=Math.sqrt(p),f=(b*b-u*u+r*p)/(2*u*n*E),_=(b*b-u*u-r*p)/(2*b*n*E),I=Math.log(Math.sqrt(f*f+1)-f),N=Math.log(Math.sqrt(_*_+1)-_);y=(N-I)/t,v=function(A){var U=A*y,M=Cr(I),W=u/(n*E)*(M*Jo(t*U+I)-Go(I));return[s+W*m,l+W*w,u*M/Cr(t*U+I)]}}return v.duration=y*1e3*t/Math.SQRT2,v}return o.rho=function(a){var i=Math.max(.001,+a),s=i*i,l=s*s;return e(i,s,l)},o}(Math.SQRT2,2,4);var gt=0,It=0,xt=0,li=1e3,mn,Bt,pn=0,at=0,In=0,Mt=typeof performance=="object"&&performance.now?performance:Date,ci=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function rr(){return at||(ci(Ko),at=Mt.now()+In)}function Ko(){at=0}function gn(){this._call=this._time=this._next=null}gn.prototype=di.prototype={constructor:gn,restart:function(e,t,n){if(typeof e!="function")throw new TypeError("callback is not a function");n=(n==null?rr():+n)+(t==null?0:+t),!this._next&&Bt!==this&&(Bt?Bt._next=this:mn=this,Bt=this),this._call=e,this._time=n,Wn()},stop:function(){this._call&&(this._call=null,this._time=1/0,Wn())}};function di(e,t,n){var r=new gn;return r.restart(e,t,n),r}function Qo(){rr(),++gt;for(var e=mn,t;e;)(t=at-e._time)>=0&&e._call.call(void 0,t),e=e._next;--gt}function Sr(){at=(pn=Mt.now())+In,gt=It=0;try{Qo()}finally{gt=0,ts(),at=0}}function es(){var e=Mt.now(),t=e-pn;t>li&&(In-=t,pn=e)}function ts(){for(var e,t=mn,n,r=1/0;t;)t._call?(r>t._time&&(r=t._time),e=t,t=t._next):(n=t._next,t._next=null,t=e?e._next=n:mn=n);Bt=e,Wn(r)}function Wn(e){if(!gt){It&&(It=clearTimeout(It));var t=e-at;t>24?(e<1/0&&(It=setTimeout(Sr,e-Mt.now()-In)),xt&&(xt=clearInterval(xt))):(xt||(pn=Mt.now(),xt=setInterval(es,li)),gt=1,ci(Sr))}}function Lr(e,t,n){var r=new gn;return t=t==null?0:+t,r.restart(o=>{r.stop(),e(o+t)},t,n),r}var ns=En("start","end","cancel","interrupt"),rs=[],ui=0,$r=1,Zn=2,rn=3,Ar=4,qn=5,an=6;function Bn(e,t,n,r,o,a){var i=e.__transition;if(!i)e.__transition={};else if(n in i)return;is(e,n,{name:t,index:r,group:o,on:ns,tween:rs,time:a.time,delay:a.delay,duration:a.duration,ease:a.ease,timer:null,state:ui})}function ir(e,t){var n=Me(e,t);if(n.state>ui)throw new Error("too late; already scheduled");return n}function je(e,t){var n=Me(e,t);if(n.state>rn)throw new Error("too late; already running");return n}function Me(e,t){var n=e.__transition;if(!n||!(n=n[t]))throw new Error("transition not found");return n}function is(e,t,n){var r=e.__transition,o;r[t]=n,n.timer=di(a,0,n.time);function a(u){n.state=$r,n.timer.restart(i,n.delay,n.time),n.delay<=u&&i(u-n.delay)}function i(u){var h,g,b,m;if(n.state!==$r)return l();for(h in r)if(m=r[h],m.name===n.name){if(m.state===rn)return Lr(i);m.state===Ar?(m.state=an,m.timer.stop(),m.on.call("interrupt",e,e.__data__,m.index,m.group),delete r[h]):+h<t&&(m.state=an,m.timer.stop(),m.on.call("cancel",e,e.__data__,m.index,m.group),delete r[h])}if(Lr(function(){n.state===rn&&(n.state=Ar,n.timer.restart(s,n.delay,n.time),s(u))}),n.state=Zn,n.on.call("start",e,e.__data__,n.index,n.group),n.state===Zn){for(n.state=rn,o=new Array(b=n.tween.length),h=0,g=-1;h<b;++h)(m=n.tween[h].value.call(e,e.__data__,n.index,n.group))&&(o[++g]=m);o.length=g+1}}function s(u){for(var h=u<n.duration?n.ease.call(null,u/n.duration):(n.timer.restart(l),n.state=qn,1),g=-1,b=o.length;++g<b;)o[g].call(e,h);n.state===qn&&(n.on.call("end",e,e.__data__,n.index,n.group),l())}function l(){n.state=an,n.timer.stop(),delete r[t];for(var u in r)return;delete e.__transition}}function on(e,t){var n=e.__transition,r,o,a=!0,i;if(n){t=t==null?null:t+"";for(i in n){if((r=n[i]).name!==t){a=!1;continue}o=r.state>Zn&&r.state<qn,r.state=an,r.timer.stop(),r.on.call(o?"interrupt":"cancel",e,e.__data__,r.index,r.group),delete n[i]}a&&delete e.__transition}}function as(e){return this.each(function(){on(this,e)})}function os(e,t){var n,r;return function(){var o=je(this,e),a=o.tween;if(a!==n){r=n=a;for(var i=0,s=r.length;i<s;++i)if(r[i].name===t){r=r.slice(),r.splice(i,1);break}}o.tween=r}}function ss(e,t,n){var r,o;if(typeof n!="function")throw new Error;return function(){var a=je(this,e),i=a.tween;if(i!==r){o=(r=i).slice();for(var s={name:t,value:n},l=0,u=o.length;l<u;++l)if(o[l].name===t){o[l]=s;break}l===u&&o.push(s)}a.tween=o}}function ls(e,t){var n=this._id;if(e+="",arguments.length<2){for(var r=Me(this.node(),n).tween,o=0,a=r.length,i;o<a;++o)if((i=r[o]).name===e)return i.value;return null}return this.each((t==null?os:ss)(n,e,t))}function ar(e,t,n){var r=e._id;return e.each(function(){var o=je(this,r);(o.value||(o.value={}))[t]=n.apply(this,arguments)}),function(o){return Me(o,r).value[t]}}function hi(e,t){var n;return(typeof t=="number"?Ve:t instanceof Nt?Ir:(n=Nt(t))?(t=n,Ir):jo)(e,t)}function cs(e){return function(){this.removeAttribute(e)}}function ds(e){return function(){this.removeAttributeNS(e.space,e.local)}}function us(e,t,n){var r,o=n+"",a;return function(){var i=this.getAttribute(e);return i===o?null:i===r?a:a=t(r=i,n)}}function hs(e,t,n){var r,o=n+"",a;return function(){var i=this.getAttributeNS(e.space,e.local);return i===o?null:i===r?a:a=t(r=i,n)}}function fs(e,t,n){var r,o,a;return function(){var i,s=n(this),l;return s==null?void this.removeAttribute(e):(i=this.getAttribute(e),l=s+"",i===l?null:i===r&&l===o?a:(o=l,a=t(r=i,s)))}}function ms(e,t,n){var r,o,a;return function(){var i,s=n(this),l;return s==null?void this.removeAttributeNS(e.space,e.local):(i=this.getAttributeNS(e.space,e.local),l=s+"",i===l?null:i===r&&l===o?a:(o=l,a=t(r=i,s)))}}function ps(e,t){var n=kn(e),r=n==="transform"?Xo:hi;return this.attrTween(e,typeof t=="function"?(n.local?ms:fs)(n,r,ar(this,"attr."+e,t)):t==null?(n.local?ds:cs)(n):(n.local?hs:us)(n,r,t))}function gs(e,t){return function(n){this.setAttribute(e,t.call(this,n))}}function ys(e,t){return function(n){this.setAttributeNS(e.space,e.local,t.call(this,n))}}function _s(e,t){var n,r;function o(){var a=t.apply(this,arguments);return a!==r&&(n=(r=a)&&ys(e,a)),n}return o._value=t,o}function bs(e,t){var n,r;function o(){var a=t.apply(this,arguments);return a!==r&&(n=(r=a)&&gs(e,a)),n}return o._value=t,o}function vs(e,t){var n="attr."+e;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(t==null)return this.tween(n,null);if(typeof t!="function")throw new Error;var r=kn(e);return this.tween(n,(r.local?_s:bs)(r,t))}function ws(e,t){return function(){ir(this,e).delay=+t.apply(this,arguments)}}function xs(e,t){return t=+t,function(){ir(this,e).delay=t}}function Es(e){var t=this._id;return arguments.length?this.each((typeof e=="function"?ws:xs)(t,e)):Me(this.node(),t).delay}function ks(e,t){return function(){je(this,e).duration=+t.apply(this,arguments)}}function Is(e,t){return t=+t,function(){je(this,e).duration=t}}function Bs(e){var t=this._id;return arguments.length?this.each((typeof e=="function"?ks:Is)(t,e)):Me(this.node(),t).duration}function Cs(e,t){if(typeof t!="function")throw new Error;return function(){je(this,e).ease=t}}function Ss(e){var t=this._id;return arguments.length?this.each(Cs(t,e)):Me(this.node(),t).ease}function Ls(e,t){return function(){var n=t.apply(this,arguments);if(typeof n!="function")throw new Error;je(this,e).ease=n}}function $s(e){if(typeof e!="function")throw new Error;return this.each(Ls(this._id,e))}function As(e){typeof e!="function"&&(e=Wr(e));for(var t=this._groups,n=t.length,r=new Array(n),o=0;o<n;++o)for(var a=t[o],i=a.length,s=r[o]=[],l,u=0;u<i;++u)(l=a[u])&&e.call(l,l.__data__,u,a)&&s.push(l);return new Ge(r,this._parents,this._name,this._id)}function Ts(e){if(e._id!==this._id)throw new Error;for(var t=this._groups,n=e._groups,r=t.length,o=n.length,a=Math.min(r,o),i=new Array(r),s=0;s<a;++s)for(var l=t[s],u=n[s],h=l.length,g=i[s]=new Array(h),b,m=0;m<h;++m)(b=l[m]||u[m])&&(g[m]=b);for(;s<r;++s)i[s]=t[s];return new Ge(i,this._parents,this._name,this._id)}function zs(e){return(e+"").trim().split(/^|\s+/).every(function(t){var n=t.indexOf(".");return n>=0&&(t=t.slice(0,n)),!t||t==="start"})}function Ns(e,t,n){var r,o,a=zs(t)?ir:je;return function(){var i=a(this,e),s=i.on;s!==r&&(o=(r=s).copy()).on(t,n),i.on=o}}function Ms(e,t){var n=this._id;return arguments.length<2?Me(this.node(),n).on.on(e):this.each(Ns(n,e,t))}function Ds(e){return function(){var t=this.parentNode;for(var n in this.__transition)if(+n!==e)return;t&&t.removeChild(this)}}function Os(){return this.on("end.remove",Ds(this._id))}function Ps(e){var t=this._name,n=this._id;typeof e!="function"&&(e=er(e));for(var r=this._groups,o=r.length,a=new Array(o),i=0;i<o;++i)for(var s=r[i],l=s.length,u=a[i]=new Array(l),h,g,b=0;b<l;++b)(h=s[b])&&(g=e.call(h,h.__data__,b,s))&&("__data__"in h&&(g.__data__=h.__data__),u[b]=g,Bn(u[b],t,n,b,u,Me(h,n)));return new Ge(a,this._parents,t,n)}function Rs(e){var t=this._name,n=this._id;typeof e!="function"&&(e=jr(e));for(var r=this._groups,o=r.length,a=[],i=[],s=0;s<o;++s)for(var l=r[s],u=l.length,h,g=0;g<u;++g)if(h=l[g]){for(var b=e.call(h,h.__data__,g,l),m,w=Me(h,n),p=0,v=b.length;p<v;++p)(m=b[p])&&Bn(m,t,n,p,b,w);a.push(b),i.push(h)}return new Ge(a,i,t,n)}var Fs=Ft.prototype.constructor;function Us(){return new Fs(this._groups,this._parents)}function Hs(e,t){var n,r,o;return function(){var a=pt(this,e),i=(this.style.removeProperty(e),pt(this,e));return a===i?null:a===n&&i===r?o:o=t(n=a,r=i)}}function fi(e){return function(){this.style.removeProperty(e)}}function js(e,t,n){var r,o=n+"",a;return function(){var i=pt(this,e);return i===o?null:i===r?a:a=t(r=i,n)}}function Ws(e,t,n){var r,o,a;return function(){var i=pt(this,e),s=n(this),l=s+"";return s==null&&(l=s=(this.style.removeProperty(e),pt(this,e))),i===l?null:i===r&&l===o?a:(o=l,a=t(r=i,s))}}function Zs(e,t){var n,r,o,a="style."+t,i="end."+a,s;return function(){var l=je(this,e),u=l.on,h=l.value[a]==null?s||(s=fi(t)):void 0;(u!==n||o!==h)&&(r=(n=u).copy()).on(i,o=h),l.on=r}}function qs(e,t,n){var r=(e+="")=="transform"?qo:hi;return t==null?this.styleTween(e,Hs(e,r)).on("end.style."+e,fi(e)):typeof t=="function"?this.styleTween(e,Ws(e,r,ar(this,"style."+e,t))).each(Zs(this._id,e)):this.styleTween(e,js(e,r,t),n).on("end.style."+e,null)}function Xs(e,t,n){return function(r){this.style.setProperty(e,t.call(this,r),n)}}function Ys(e,t,n){var r,o;function a(){var i=t.apply(this,arguments);return i!==o&&(r=(o=i)&&Xs(e,i,n)),r}return a._value=t,a}function Gs(e,t,n){var r="style."+(e+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(t==null)return this.tween(r,null);if(typeof t!="function")throw new Error;return this.tween(r,Ys(e,t,n??""))}function Js(e){return function(){this.textContent=e}}function Vs(e){return function(){var t=e(this);this.textContent=t??""}}function Ks(e){return this.tween("text",typeof e=="function"?Vs(ar(this,"text",e)):Js(e==null?"":e+""))}function Qs(e){return function(t){this.textContent=e.call(this,t)}}function el(e){var t,n;function r(){var o=e.apply(this,arguments);return o!==n&&(t=(n=o)&&Qs(o)),t}return r._value=e,r}function tl(e){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;return this.tween(t,el(e))}function nl(){for(var e=this._name,t=this._id,n=mi(),r=this._groups,o=r.length,a=0;a<o;++a)for(var i=r[a],s=i.length,l,u=0;u<s;++u)if(l=i[u]){var h=Me(l,t);Bn(l,e,n,u,i,{time:h.time+h.delay+h.duration,delay:0,duration:h.duration,ease:h.ease})}return new Ge(r,this._parents,e,n)}function rl(){var e,t,n=this,r=n._id,o=n.size();return new Promise(function(a,i){var s={value:i},l={value:function(){--o===0&&a()}};n.each(function(){var u=je(this,r),h=u.on;h!==e&&(t=(e=h).copy(),t._.cancel.push(s),t._.interrupt.push(s),t._.end.push(l)),u.on=t}),o===0&&a()})}var il=0;function Ge(e,t,n,r){this._groups=e,this._parents=t,this._name=n,this._id=r}function mi(){return++il}var Ze=Ft.prototype;Ge.prototype={constructor:Ge,select:Ps,selectAll:Rs,selectChild:Ze.selectChild,selectChildren:Ze.selectChildren,filter:As,merge:Ts,selection:Us,transition:nl,call:Ze.call,nodes:Ze.nodes,node:Ze.node,size:Ze.size,empty:Ze.empty,each:Ze.each,on:Ms,attr:ps,attrTween:vs,style:qs,styleTween:Gs,text:Ks,textTween:tl,remove:Os,tween:ls,delay:Es,duration:Bs,ease:Ss,easeVarying:$s,end:rl,[Symbol.iterator]:Ze[Symbol.iterator]};function al(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}var ol={time:null,delay:0,duration:250,ease:al};function sl(e,t){for(var n;!(n=e.__transition)||!(n=n[t]);)if(!(e=e.parentNode))throw new Error(`transition ${t} not found`);return n}function ll(e){var t,n;e instanceof Ge?(t=e._id,e=e._name):(t=mi(),(n=ol).time=rr(),e=e==null?null:e+"");for(var r=this._groups,o=r.length,a=0;a<o;++a)for(var i=r[a],s=i.length,l,u=0;u<s;++u)(l=i[u])&&Bn(l,e,t,u,i,n||sl(l,t));return new Ge(r,this._parents,e,t)}Ft.prototype.interrupt=as;Ft.prototype.transition=ll;const Yt=e=>()=>e;function cl(e,{sourceEvent:t,target:n,transform:r,dispatch:o}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:o}})}function qe(e,t,n){this.k=e,this.x=t,this.y=n}qe.prototype={constructor:qe,scale:function(e){return e===1?this:new qe(this.k*e,this.x,this.y)},translate:function(e,t){return e===0&t===0?this:new qe(this.k,this.x+this.k*e,this.y+this.k*t)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Ct=new qe(1,0,0);qe.prototype;function On(e){e.stopImmediatePropagation()}function Et(e){e.preventDefault(),e.stopImmediatePropagation()}function dl(e){return(!e.ctrlKey||e.type==="wheel")&&!e.button}function ul(){var e=this;return e instanceof SVGElement?(e=e.ownerSVGElement||e,e.hasAttribute("viewBox")?(e=e.viewBox.baseVal,[[e.x,e.y],[e.x+e.width,e.y+e.height]]):[[0,0],[e.width.baseVal.value,e.height.baseVal.value]]):[[0,0],[e.clientWidth,e.clientHeight]]}function Tr(){return this.__zoom||Ct}function hl(e){return-e.deltaY*(e.deltaMode===1?.05:e.deltaMode?1:.002)*(e.ctrlKey?10:1)}function fl(){return navigator.maxTouchPoints||"ontouchstart"in this}function ml(e,t,n){var r=e.invertX(t[0][0])-n[0][0],o=e.invertX(t[1][0])-n[1][0],a=e.invertY(t[0][1])-n[0][1],i=e.invertY(t[1][1])-n[1][1];return e.translate(o>r?(r+o)/2:Math.min(0,r)||Math.max(0,o),i>a?(a+i)/2:Math.min(0,a)||Math.max(0,i))}function pl(){var e=dl,t=ul,n=ml,r=hl,o=fl,a=[0,1/0],i=[[-1/0,-1/0],[1/0,1/0]],s=250,l=Vo,u=En("start","zoom","end"),h,g,b,m=500,w=150,p=0,v=10;function y(c){c.property("__zoom",Tr).on("wheel.zoom",U,{passive:!1}).on("mousedown.zoom",M).on("dblclick.zoom",W).filter(o).on("touchstart.zoom",ee).on("touchmove.zoom",B).on("touchend.zoom touchcancel.zoom",R).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}y.transform=function(c,S,D,z){var J=c.selection?c.selection():c;J.property("__zoom",Tr),c!==J?I(c,S,D,z):J.interrupt().each(function(){N(this,arguments).event(z).start().zoom(null,typeof S=="function"?S.apply(this,arguments):S).end()})},y.scaleBy=function(c,S,D,z){y.scaleTo(c,function(){var J=this.__zoom.k,P=typeof S=="function"?S.apply(this,arguments):S;return J*P},D,z)},y.scaleTo=function(c,S,D,z){y.transform(c,function(){var J=t.apply(this,arguments),P=this.__zoom,q=D==null?_(J):typeof D=="function"?D.apply(this,arguments):D,$=P.invert(q),L=typeof S=="function"?S.apply(this,arguments):S;return n(f(E(P,L),q,$),J,i)},D,z)},y.translateBy=function(c,S,D,z){y.transform(c,function(){return n(this.__zoom.translate(typeof S=="function"?S.apply(this,arguments):S,typeof D=="function"?D.apply(this,arguments):D),t.apply(this,arguments),i)},null,z)},y.translateTo=function(c,S,D,z,J){y.transform(c,function(){var P=t.apply(this,arguments),q=this.__zoom,$=z==null?_(P):typeof z=="function"?z.apply(this,arguments):z;return n(Ct.translate($[0],$[1]).scale(q.k).translate(typeof S=="function"?-S.apply(this,arguments):-S,typeof D=="function"?-D.apply(this,arguments):-D),P,i)},z,J)};function E(c,S){return S=Math.max(a[0],Math.min(a[1],S)),S===c.k?c:new qe(S,c.x,c.y)}function f(c,S,D){var z=S[0]-D[0]*c.k,J=S[1]-D[1]*c.k;return z===c.x&&J===c.y?c:new qe(c.k,z,J)}function _(c){return[(+c[0][0]+ +c[1][0])/2,(+c[0][1]+ +c[1][1])/2]}function I(c,S,D,z){c.on("start.zoom",function(){N(this,arguments).event(z).start()}).on("interrupt.zoom end.zoom",function(){N(this,arguments).event(z).end()}).tween("zoom",function(){var J=this,P=arguments,q=N(J,P).event(z),$=t.apply(J,P),L=D==null?_($):typeof D=="function"?D.apply(J,P):D,te=Math.max($[1][0]-$[0][0],$[1][1]-$[0][1]),Y=J.__zoom,Z=typeof S=="function"?S.apply(J,P):S,ce=l(Y.invert(L).concat(te/Y.k),Z.invert(L).concat(te/Z.k));return function(ue){if(ue===1)ue=Z;else{var ae=ce(ue),se=te/ae[2];ue=new qe(se,L[0]-ae[0]*se,L[1]-ae[1]*se)}q.zoom(null,ue)}})}function N(c,S,D){return!D&&c.__zooming||new A(c,S)}function A(c,S){this.that=c,this.args=S,this.active=0,this.sourceEvent=null,this.extent=t.apply(c,S),this.taps=0}A.prototype={event:function(c){return c&&(this.sourceEvent=c),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(c,S){return this.mouse&&c!=="mouse"&&(this.mouse[1]=S.invert(this.mouse[0])),this.touch0&&c!=="touch"&&(this.touch0[1]=S.invert(this.touch0[0])),this.touch1&&c!=="touch"&&(this.touch1[1]=S.invert(this.touch1[0])),this.that.__zoom=S,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(c){var S=Le(this.that).datum();u.call(c,this.that,new cl(c,{sourceEvent:this.sourceEvent,target:y,transform:this.that.__zoom,dispatch:u}),S)}};function U(c,...S){if(!e.apply(this,arguments))return;var D=N(this,S).event(c),z=this.__zoom,J=Math.max(a[0],Math.min(a[1],z.k*Math.pow(2,r.apply(this,arguments)))),P=Re(c);if(D.wheel)(D.mouse[0][0]!==P[0]||D.mouse[0][1]!==P[1])&&(D.mouse[1]=z.invert(D.mouse[0]=P)),clearTimeout(D.wheel);else{if(z.k===J)return;D.mouse=[P,z.invert(P)],on(this),D.start()}Et(c),D.wheel=setTimeout(q,w),D.zoom("mouse",n(f(E(z,J),D.mouse[0],D.mouse[1]),D.extent,i));function q(){D.wheel=null,D.end()}}function M(c,...S){if(b||!e.apply(this,arguments))return;var D=c.currentTarget,z=N(this,S,!0).event(c),J=Le(c.view).on("mousemove.zoom",L,!0).on("mouseup.zoom",te,!0),P=Re(c,D),q=c.clientX,$=c.clientY;ei(c.view),On(c),z.mouse=[P,this.__zoom.invert(P)],on(this),z.start();function L(Y){if(Et(Y),!z.moved){var Z=Y.clientX-q,ce=Y.clientY-$;z.moved=Z*Z+ce*ce>p}z.event(Y).zoom("mouse",n(f(z.that.__zoom,z.mouse[0]=Re(Y,D),z.mouse[1]),z.extent,i))}function te(Y){J.on("mousemove.zoom mouseup.zoom",null),ti(Y.view,z.moved),Et(Y),z.event(Y).end()}}function W(c,...S){if(e.apply(this,arguments)){var D=this.__zoom,z=Re(c.changedTouches?c.changedTouches[0]:c,this),J=D.invert(z),P=D.k*(c.shiftKey?.5:2),q=n(f(E(D,P),z,J),t.apply(this,S),i);Et(c),s>0?Le(this).transition().duration(s).call(I,q,z,c):Le(this).call(y.transform,q,z,c)}}function ee(c,...S){if(e.apply(this,arguments)){var D=c.touches,z=D.length,J=N(this,S,c.changedTouches.length===z).event(c),P,q,$,L;for(On(c),q=0;q<z;++q)$=D[q],L=Re($,this),L=[L,this.__zoom.invert(L),$.identifier],J.touch0?!J.touch1&&J.touch0[2]!==L[2]&&(J.touch1=L,J.taps=0):(J.touch0=L,P=!0,J.taps=1+!!h);h&&(h=clearTimeout(h)),P&&(J.taps<2&&(g=L[0],h=setTimeout(function(){h=null},m)),on(this),J.start())}}function B(c,...S){if(this.__zooming){var D=N(this,S).event(c),z=c.changedTouches,J=z.length,P,q,$,L;for(Et(c),P=0;P<J;++P)q=z[P],$=Re(q,this),D.touch0&&D.touch0[2]===q.identifier?D.touch0[0]=$:D.touch1&&D.touch1[2]===q.identifier&&(D.touch1[0]=$);if(q=D.that.__zoom,D.touch1){var te=D.touch0[0],Y=D.touch0[1],Z=D.touch1[0],ce=D.touch1[1],ue=(ue=Z[0]-te[0])*ue+(ue=Z[1]-te[1])*ue,ae=(ae=ce[0]-Y[0])*ae+(ae=ce[1]-Y[1])*ae;q=E(q,Math.sqrt(ue/ae)),$=[(te[0]+Z[0])/2,(te[1]+Z[1])/2],L=[(Y[0]+ce[0])/2,(Y[1]+ce[1])/2]}else if(D.touch0)$=D.touch0[0],L=D.touch0[1];else return;D.zoom("touch",n(f(q,$,L),D.extent,i))}}function R(c,...S){if(this.__zooming){var D=N(this,S).event(c),z=c.changedTouches,J=z.length,P,q;for(On(c),b&&clearTimeout(b),b=setTimeout(function(){b=null},m),P=0;P<J;++P)q=z[P],D.touch0&&D.touch0[2]===q.identifier?delete D.touch0:D.touch1&&D.touch1[2]===q.identifier&&delete D.touch1;if(D.touch1&&!D.touch0&&(D.touch0=D.touch1,delete D.touch1),D.touch0)D.touch0[1]=this.__zoom.invert(D.touch0[0]);else if(D.end(),D.taps===2&&(q=Re(q,this),Math.hypot(g[0]-q[0],g[1]-q[1])<v)){var $=Le(this).on("dblclick.zoom");$&&$.apply(this,arguments)}}}return y.wheelDelta=function(c){return arguments.length?(r=typeof c=="function"?c:Yt(+c),y):r},y.filter=function(c){return arguments.length?(e=typeof c=="function"?c:Yt(!!c),y):e},y.touchable=function(c){return arguments.length?(o=typeof c=="function"?c:Yt(!!c),y):o},y.extent=function(c){return arguments.length?(t=typeof c=="function"?c:Yt([[+c[0][0],+c[0][1]],[+c[1][0],+c[1][1]]]),y):t},y.scaleExtent=function(c){return arguments.length?(a[0]=+c[0],a[1]=+c[1],y):[a[0],a[1]]},y.translateExtent=function(c){return arguments.length?(i[0][0]=+c[0][0],i[1][0]=+c[1][0],i[0][1]=+c[0][1],i[1][1]=+c[1][1],y):[[i[0][0],i[0][1]],[i[1][0],i[1][1]]]},y.constrain=function(c){return arguments.length?(n=c,y):n},y.duration=function(c){return arguments.length?(s=+c,y):s},y.interpolate=function(c){return arguments.length?(l=c,y):l},y.on=function(){var c=u.on.apply(u,arguments);return c===u?y:c},y.clickDistance=function(c){return arguments.length?(p=(c=+c)*c,y):Math.sqrt(p)},y.tapDistance=function(c){return arguments.length?(v=+c,y):v},y}class pi{constructor(t,n={}){this.container=document.getElementById(t),this.svg=Le("#bibmap-svg"),this.nodesLayer=this.svg.select("#nodes-layer"),this.connectionsLayer=this.svg.select("#connections-layer"),this.srNodeList=document.getElementById("sr-node-list"),this.bibmapId=null,this.nodes=[],this.connections=[],this.selectedNode=null,this.connectMode=!1,this.connectSourceNode=null,this.selectedConnection=null,this.resizing=!1,this.snapToGrid=!1,this.gridSize=20,this.onNodeSelect=n.onNodeSelect||(()=>{}),this.onNodeUpdate=n.onNodeUpdate||(()=>{}),this.onConnectionSelect=n.onConnectionSelect||(()=>{}),this.onCanvasClick=n.onCanvasClick||(()=>{}),this.announce=n.announce||(()=>{}),this.defaultNodeColor="#3B82F6",this.defaultTextColor="#FFFFFF",this.minNodeWidth=50,this.minNodeHeight=30,this.setupZoomAndPan(),this.setupKeyboardNavigation(),this.setupCanvasClick()}setupCanvasClick(){this.svg.on("click",t=>{t.target===this.svg.node()&&(this.clearSelection(),this.clearConnectionSelection(),this.onCanvasClick())})}setupZoomAndPan(){this.zoom=pl().scaleExtent([.25,4]).on("zoom",t=>{this.nodesLayer.attr("transform",t.transform),this.connectionsLayer.attr("transform",t.transform),this.hideDescriptionCallout()}),this.svg.call(this.zoom),this.svg.on("dblclick.zoom",()=>{this.svg.transition().duration(300).call(this.zoom.transform,Ct)})}setupZoomControls(){const t=document.createElement("div");t.className="zoom-controls",t.innerHTML=`
      <button class="zoom-btn" id="zoom-in" aria-label="Zoom in" title="Zoom In">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </button>
      <button class="zoom-btn" id="zoom-out" aria-label="Zoom out" title="Zoom Out">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M3 8h10" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </button>
      <button class="zoom-btn" id="zoom-fit" aria-label="Fit to screen" title="Fit to Screen">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M2 2h4M2 2v4M14 2h-4M14 2v4M2 14h4M2 14v-4M14 14h-4M14 14v-4" stroke="currentColor" stroke-width="1.5" fill="none"/>
        </svg>
      </button>
    `,t.style.cssText=`
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 100;
    `;const n=`
      width: 32px;
      height: 32px;
      border: 1px solid #E5E7EB;
      border-radius: 6px;
      background: #FFFFFF;
      color: #374151;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    `;t.querySelectorAll(".zoom-btn").forEach(r=>{r.style.cssText=n,r.addEventListener("mouseenter",()=>{r.style.background="#F3F4F6",r.style.borderColor="#3B82F6"}),r.addEventListener("mouseleave",()=>{r.style.background="#FFFFFF",r.style.borderColor="#E5E7EB"})}),t.querySelector("#zoom-in").addEventListener("click",()=>this.zoomIn()),t.querySelector("#zoom-out").addEventListener("click",()=>this.zoomOut()),t.querySelector("#zoom-fit").addEventListener("click",()=>this.fitToScreen()),this.container.appendChild(t)}zoomIn(){this.svg.transition().duration(200).call(this.zoom.scaleBy,1.3)}zoomOut(){this.svg.transition().duration(200).call(this.zoom.scaleBy,.7)}fitToScreen(){if(this.nodes.length===0){this.svg.transition().duration(300).call(this.zoom.transform,Ct);return}const t=50;let n=1/0,r=1/0,o=-1/0,a=-1/0;this.nodes.forEach(p=>{const v=p.width||150,y=p.height||60;n=Math.min(n,p.x),r=Math.min(r,p.y),o=Math.max(o,p.x+v),a=Math.max(a,p.y+y)}),n-=t,r-=t,o+=t,a+=t;const i=this.svg.node().getBoundingClientRect(),s=i.width,l=i.height,u=o-n,h=a-r,g=Math.min(s/u,l/h,2),b=(s-u*g)/2-n*g,m=(l-h*g)/2-r*g,w=Ct.translate(b,m).scale(g);this.svg.transition().duration(300).call(this.zoom.transform,w)}setupKeyboardNavigation(){this.container.addEventListener("keydown",t=>{if(!this.selectedNode)return;const n=this.nodes.findIndex(o=>o.id===this.selectedNode.id);let r=n;switch(t.key){case"ArrowRight":case"ArrowDown":r=Math.min(n+1,this.nodes.length-1),t.preventDefault();break;case"ArrowLeft":case"ArrowUp":r=Math.max(n-1,0),t.preventDefault();break;case"Enter":case" ":this.onNodeSelect(this.selectedNode),t.preventDefault();break;case"Escape":this.clearConnectionSelection(),this.clearSelection(),t.preventDefault();break}r!==n&&this.nodes[r]&&this.selectNode(this.nodes[r])})}async load(t){this.bibmapId=t;const n=await K.bibmaps.get(t);return this.nodes=n.nodes||[],this.connections=n.connections||[],this.render(),this.updateScreenReaderList(),this.zoomControlsSetup||(this.setupZoomControls(),this.zoomControlsSetup=!0),n}render(){this.renderConnections(),this.renderNodes()}ensureArrowMarker(t,n,r=!1){const o=r?"-start":"",a=`arrowhead-${t}-${n.replace("#","")}${o}`,i=this.svg.select("defs");if(i.select(`#${a}`).empty()){const s=t/4,l=10*s,u=7*s,h=r?1*s:9*s,g=3.5*s,b=i.append("marker").attr("id",a).attr("markerWidth",l).attr("markerHeight",u).attr("refX",h).attr("refY",g).attr("orient","auto");r?b.append("polygon").attr("points",`${l} 0, 0 ${g}, ${l} ${u}`).attr("fill",n):b.append("polygon").attr("points",`0 0, ${l} ${g}, 0 ${u}`).attr("fill",n)}return`url(#${a})`}renderConnections(){const t=this.connectionsLayer.selectAll(".connection-group").data(this.connections,a=>a.id);t.exit().remove();const n=t.enter().append("g").attr("class","connection-group");n.append("path").attr("class","connection-line"),n.append("text").attr("class","connection-label").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill","#374151").attr("font-size","12").attr("pointer-events","none");const r=t.merge(n),o=this;r.select(".connection-line").attr("d",a=>this.calculateConnectionPath(a)).attr("stroke",a=>a.line_color||"#6B7280").attr("stroke-width",a=>a.line_width||4).attr("stroke-dasharray",a=>a.line_style==="dashed"?"8,4":a.line_style==="dotted"?"2,2":null).attr("marker-end",function(a){if(a.arrow_type==="none")return null;const i=a.line_width||4,s=a.line_color||"#6B7280";return o.ensureArrowMarker(i,s,!1)}).attr("marker-start",function(a){if(a.arrow_type!=="both")return null;const i=a.line_width||4,s=a.line_color||"#6B7280";return o.ensureArrowMarker(i,s,!0)}).attr("fill","none").classed("selected",a=>this.selectedConnection&&a.id===this.selectedConnection.id).on("click",(a,i)=>{a.stopPropagation(),this.selectConnection(i,a)}),r.select(".connection-label").attr("x",a=>this.getConnectionMidpoint(a).x).attr("y",a=>this.getConnectionMidpoint(a).y-10).text(a=>a.show_label&&a.label?a.label:"").attr("visibility",a=>a.show_label&&a.label?"visible":"hidden")}getConnectionMidpoint(t){const n=this.nodes.find(l=>l.id===t.source_node_id),r=this.nodes.find(l=>l.id===t.target_node_id);if(!n||!r)return{x:0,y:0};const o=n.x+(n.width||150)/2,a=n.y+(n.height||60)/2,i=r.x+(r.width||150)/2,s=r.y+(r.height||60)/2;return{x:(o+i)/2,y:(a+s)/2}}calculateConnectionPath(t){const n=this.nodes.find(h=>h.id===t.source_node_id),r=this.nodes.find(h=>h.id===t.target_node_id);if(!n||!r)return"";const o=n.x+(n.width||150)/2,a=n.y+(n.height||60)/2,i=r.x+(r.width||150)/2,s=r.y+(r.height||60)/2;let l,u;if(t.target_attach_x!=null&&t.target_attach_y!=null){const h={x:r.x+t.target_attach_x,y:r.y+t.target_attach_y},g=Math.atan2(h.y-a,h.x-o);l=this.getEdgePoint(n,g),u=this.clampToNodeEdge(r,h)}else{const h=Math.atan2(s-a,i-o);l=this.getEdgePoint(n,h),u=this.getEdgePoint(r,h+Math.PI)}if(t.source_attach_x!=null&&t.source_attach_y!=null){const h={x:n.x+t.source_attach_x,y:n.y+t.source_attach_y};l=this.clampToNodeEdge(n,h)}return`M ${l.x} ${l.y} L ${u.x} ${u.y}`}clampToNodeEdge(t,n){const r=t.x+(t.width||150)/2,o=t.y+(t.height||60)/2,a=Math.atan2(n.y-o,n.x-r);return this.getEdgePoint(t,a)}getEdgePoint(t,n){const r=t.x+(t.width||150)/2,o=t.y+(t.height||60)/2,a=(t.width||150)/2,i=(t.height||60)/2,s=t.shape||"rectangle";let l,u;switch(s){case"ellipse":{l=r+a*Math.cos(n),u=o+i*Math.sin(n);break}case"diamond":{const h=Math.cos(n),g=Math.sin(n);if(Math.abs(h)*i>Math.abs(g)*a){const b=a/Math.abs(h);l=r+b*h,u=o+b*g}else{const b=i/Math.abs(g);l=r+b*h,u=o+b*g}break}case"rounded-rectangle":case"rectangle":default:{const h=Math.tan(n);Math.abs(Math.cos(n))*i>Math.abs(Math.sin(n))*a?(l=r+(Math.cos(n)>0?a:-a),u=o+(Math.cos(n)>0?a:-a)*h):(u=o+(Math.sin(n)>0?i:-i),l=r+(Math.sin(n)>0?i:-i)/h);break}}return{x:l,y:u}}getShapePath(t){const n=t.width||150,r=t.height||60;switch(t.shape||"rectangle"){case"ellipse":{const a=n/2,i=r/2,s=n/2,l=r/2,u=.5522848,h=s*u,g=l*u;return`M ${a-s} ${i}
                C ${a-s} ${i-g}, ${a-h} ${i-l}, ${a} ${i-l}
                C ${a+h} ${i-l}, ${a+s} ${i-g}, ${a+s} ${i}
                C ${a+s} ${i+g}, ${a+h} ${i+l}, ${a} ${i+l}
                C ${a-h} ${i+l}, ${a-s} ${i+g}, ${a-s} ${i}
                Z`}case"diamond":{const a=n/2,i=r/2;return`M ${a} 0 L ${n} ${i} L ${a} ${r} L 0 ${i} Z`}case"rounded-rectangle":{const a=Math.min(16,n/4,r/4);return`M ${a} 0
                L ${n-a} 0
                Q ${n} 0, ${n} ${a}
                L ${n} ${r-a}
                Q ${n} ${r}, ${n-a} ${r}
                L ${a} ${r}
                Q 0 ${r}, 0 ${r-a}
                L 0 ${a}
                Q 0 0, ${a} 0
                Z`}case"rectangle":default:return`M 0 0
                L ${n} 0
                L ${n} ${r}
                L 0 ${r}
                Z`}}getNodeFill(t){const n=t.node_style||"flat",r=t.background_color||this.defaultNodeColor;return n==="outline"?"none":r}getNodeStroke(t){const n=t.node_style||"flat",r=t.background_color||this.defaultNodeColor,o=t.border_color||"#1E40AF";return n==="outline"?r:o}getNodeStrokeWidth(t){return(t.node_style||"flat")==="outline"?3:2}getNodeFilter(t){const n=t.node_style||"flat";switch(this.ensureNodeStyleFilters(),n){case"bevel":return"url(#bevel-filter)";case"emboss":return"url(#emboss-filter)";default:return null}}ensureNodeStyleFilters(){const t=this.svg.select("defs");if(t.select("#bevel-filter").empty()&&t.append("filter").attr("id","bevel-filter").attr("x","-20%").attr("y","-20%").attr("width","140%").attr("height","140%").append("feDropShadow").attr("dx","3").attr("dy","3").attr("stdDeviation","2").attr("flood-color","#000000").attr("flood-opacity","0.4"),t.select("#emboss-filter").empty()){const n=t.append("filter").attr("id","emboss-filter").attr("x","-20%").attr("y","-20%").attr("width","140%").attr("height","140%");n.append("feOffset").attr("in","SourceAlpha").attr("dx","2").attr("dy","2").attr("result","shadowOffset"),n.append("feGaussianBlur").attr("in","shadowOffset").attr("stdDeviation","1").attr("result","shadowBlur"),n.append("feComposite").attr("in","shadowBlur").attr("in2","SourceAlpha").attr("operator","arithmetic").attr("k2","-1").attr("k3","1").attr("result","shadowDiff"),n.append("feFlood").attr("flood-color","#000000").attr("flood-opacity","0.5"),n.append("feComposite").attr("in2","shadowDiff").attr("operator","in").attr("result","innerShadow"),n.append("feOffset").attr("in","SourceAlpha").attr("dx","-2").attr("dy","-2").attr("result","highlightOffset"),n.append("feGaussianBlur").attr("in","highlightOffset").attr("stdDeviation","1").attr("result","highlightBlur"),n.append("feComposite").attr("in","highlightBlur").attr("in2","SourceAlpha").attr("operator","arithmetic").attr("k2","-1").attr("k3","1").attr("result","highlightDiff"),n.append("feFlood").attr("flood-color","#ffffff").attr("flood-opacity","0.4"),n.append("feComposite").attr("in2","highlightDiff").attr("operator","in").attr("result","innerHighlight");const r=n.append("feMerge");r.append("feMergeNode").attr("in","SourceGraphic"),r.append("feMergeNode").attr("in","innerShadow"),r.append("feMergeNode").attr("in","innerHighlight")}}showDescriptionCallout(t,n){var m;this.hideDescriptionCallout(),this.nodesLayer.select(`.node-group[aria-label="Node: ${t.label}${(m=t.taxonomies)!=null&&m.length?`, Tags: ${t.taxonomies.map(w=>w.name).join(", ")}`:""}"]`);const r=this.nodesLayer.attr("transform");this.container.getBoundingClientRect();const o=t.x+(t.width||150)-12,a=t.y+12;let i=1,s=0,l=0;if(r){const w=r.match(/translate\(([-\d.]+),\s*([-\d.]+)\)\s*scale\(([-\d.]+)\)/);if(w)s=parseFloat(w[1]),l=parseFloat(w[2]),i=parseFloat(w[3]);else{const p=r.match(/translate\(([-\d.]+),\s*([-\d.]+)\)/);p&&(s=parseFloat(p[1]),l=parseFloat(p[2]));const v=r.match(/scale\(([-\d.]+)\)/);v&&(i=parseFloat(v[1]))}}const u=o*i+s,h=a*i+l,g=document.createElement("div");g.id="description-callout",g.className="description-callout",g.innerHTML=`
      <div class="callout-content">${this.escapeHtml(t.description)}</div>
      <button class="callout-close" aria-label="Close">&times;</button>
    `,g.style.position="absolute",g.style.left=`${u+20}px`,g.style.top=`${h}px`,g.style.maxWidth="250px",g.style.padding="0.75rem",g.style.background="#1F2937",g.style.color="#F9FAFB",g.style.borderRadius="8px",g.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)",g.style.fontSize="0.875rem",g.style.lineHeight="1.4",g.style.zIndex="1000",g.style.whiteSpace="pre-wrap";const b=g.querySelector(".callout-close");b.style.position="absolute",b.style.top="4px",b.style.right="8px",b.style.background="none",b.style.border="none",b.style.color="#9CA3AF",b.style.fontSize="1.25rem",b.style.cursor="pointer",b.style.padding="0",b.style.lineHeight="1",b.addEventListener("click",w=>{w.stopPropagation(),this.hideDescriptionCallout()}),this.container.appendChild(g),this._calloutClickHandler=w=>{g.contains(w.target)||this.hideDescriptionCallout()},setTimeout(()=>{document.addEventListener("click",this._calloutClickHandler)},0)}hideDescriptionCallout(){const t=document.getElementById("description-callout");t&&t.remove(),this._calloutClickHandler&&(document.removeEventListener("click",this._calloutClickHandler),this._calloutClickHandler=null)}escapeHtml(t){if(!t)return"";const n=document.createElement("div");return n.textContent=t,n.innerHTML}renderNodes(){const t=this,n=this.nodesLayer.selectAll(".node-group").data(this.nodes,i=>i.id);n.exit().remove();const r=n.enter().append("g").attr("class","node-group").attr("tabindex","0").attr("role","button").attr("aria-label",i=>`Node: ${i.label}`).call(gr().on("start",function(i,s){t.connectMode||t.deleteMode||t.resizing||Le(this).raise()}).on("drag",function(i,s){if(t.connectMode||t.deleteMode||t.resizing)return;let l=i.x,u=i.y;t.snapToGrid&&(l=Math.round(l/t.gridSize)*t.gridSize,u=Math.round(u/t.gridSize)*t.gridSize),s.x=l,s.y=u,Le(this).attr("transform",`translate(${s.x}, ${s.y})`),t.renderConnections()}).on("end",async function(i,s){if(!(t.connectMode||t.deleteMode||t.resizing))try{await K.nodes.updatePosition(s.id,s.x,s.y)}catch(l){console.error("Failed to save position:",l)}}));r.append("path").attr("class","node-shape"),r.append("foreignObject").attr("class","node-label-container").append("xhtml:div").attr("class","node-label-wrapper"),r.append("circle").attr("class","info-icon").attr("r",8).attr("fill","#6B7280").attr("stroke","#ffffff").attr("stroke-width",1.5).attr("cursor","pointer").style("opacity",0),r.append("text").attr("class","info-icon-text").attr("text-anchor","middle").attr("dominant-baseline","central").attr("fill","#ffffff").attr("font-size","10").attr("font-weight","bold").attr("pointer-events","none").style("opacity",0).text("i"),r.append("rect").attr("class","resize-handle").attr("width",12).attr("height",12).attr("rx",2).attr("fill","#3B82F6").attr("stroke","#1E40AF").attr("stroke-width",1).attr("cursor","se-resize").style("opacity",0).call(gr().on("start",function(i,s){i.sourceEvent.stopPropagation(),t.resizing=!0,s._startWidth=s.width||150,s._startHeight=s.height||60,s._startX=i.x,s._startY=i.y}).on("drag",function(i,s){i.sourceEvent.stopPropagation();const l=i.x-s._startX,u=i.y-s._startY;s.width=Math.max(t.minNodeWidth,s._startWidth+l),s.height=Math.max(t.minNodeHeight,s._startHeight+u),t.render()}).on("end",async function(i,s){i.sourceEvent.stopPropagation(),t.resizing=!1,delete s._startWidth,delete s._startHeight,delete s._startX,delete s._startY;try{await K.nodes.updateSize(s.id,s.width,s.height),t.announce("Node resized.")}catch(l){console.error("Failed to save size:",l)}}));const a=n.merge(r);a.attr("transform",i=>`translate(${i.x}, ${i.y})`).attr("aria-label",i=>{var s;return`Node: ${i.label}${(s=i.taxonomies)!=null&&s.length?`, Tags: ${i.taxonomies.map(l=>l.name).join(", ")}`:""}`}),a.select(".node-shape").attr("d",i=>this.getShapePath(i)).attr("fill",i=>this.getNodeFill(i)).attr("stroke",i=>this.getNodeStroke(i)).attr("stroke-width",i=>this.getNodeStrokeWidth(i)).attr("filter",i=>this.getNodeFilter(i)),a.select(".node-label-container").attr("x",4).attr("y",4).attr("width",i=>(i.width||150)-8).attr("height",i=>(i.height||60)-8),a.select(".node-label-wrapper").style("width",i=>`${(i.width||150)-8}px`).style("height",i=>`${(i.height||60)-8}px`).style("color",i=>i.text_color||this.defaultTextColor).style("font-size",i=>`${i.font_size||14}px`).style("font-family",i=>i.font_family||"system-ui").style("font-weight",i=>i.font_bold?"bold":"normal").style("font-style",i=>i.font_italic?"italic":"normal").style("text-decoration",i=>i.font_underline?"underline":"none").style("overflow","hidden").style("display","flex").style("align-items","center").style("justify-content","center").style("text-align","center").style("word-wrap",i=>i.wrap_text!==!1?"break-word":"normal").style("overflow-wrap",i=>i.wrap_text!==!1?"break-word":"normal").style("white-space",i=>i.wrap_text!==!1?"normal":"nowrap").style("text-overflow",i=>i.wrap_text!==!1?"clip":"ellipsis").style("line-height","1.2").style("padding","2px").style("box-sizing","border-box").text(i=>i.label),a.select(".resize-handle").attr("x",i=>(i.width||150)-10).attr("y",i=>(i.height||60)-10).style("opacity",i=>this.selectedNode&&this.selectedNode.id===i.id?1:0),a.select(".info-icon").attr("cx",i=>(i.width||150)-12).attr("cy",12).style("opacity",i=>i.description?1:0).on("click",(i,s)=>{i.stopPropagation(),s.description&&this.showDescriptionCallout(s,i)}),a.select(".info-icon-text").attr("x",i=>(i.width||150)-12).attr("y",12).style("opacity",i=>i.description?1:0),a.on("click",(i,s)=>{i.stopPropagation(),this.clearConnectionSelection(),this.connectMode?this.handleConnectClick(s):(this.selectNode(s),this.onNodeSelect(s))}).on("focus",(i,s)=>{this.selectNode(s)})}truncateLabel(t,n){const r=Math.floor(n/10);return t.length<=r?t:t.substring(0,r-2)+"..."}selectNode(t){this.selectedNode=t,this.nodesLayer.selectAll(".node-group").classed("selected",n=>n.id===t.id),this.nodesLayer.selectAll(".resize-handle").style("opacity",n=>n.id===t.id?1:0),this.announce(`Selected node: ${t.label}`)}clearSelection(){this.selectedNode=null,this.connectSourceNode=null,this.nodesLayer.selectAll(".node-group").classed("selected",!1),this.nodesLayer.selectAll(".resize-handle").style("opacity",0),this.hideDescriptionCallout()}setConnectMode(t){this.connectMode=t,this.connectSourceNode=null,this.clearConnectionSelection(),t&&this.announce("Connect mode enabled. Click a node to start connection.")}startDragConnection(t){t&&this.selectedNode?(this.dragConnecting=!0,this.connectSourceNode=this.selectedNode,this.dragLine=null,this.setupDragConnectionHandlers(),this.announce(`Drag from ${this.selectedNode.label} to another node to connect.`)):this.cancelDragConnection()}setupDragConnectionHandlers(){const t=this,n=this.connectSourceNode,r=n.x+(n.width||150)/2,o=n.y+(n.height||60)/2;this.lastDragMousePos={x:r,y:o},this.dragLine=this.connectionsLayer.append("path").attr("class","drag-connection-line").attr("stroke","#3B82F6").attr("stroke-width",2).attr("stroke-dasharray","5,5").attr("fill","none").attr("marker-end","url(#arrowhead)").attr("d",`M ${r} ${o} L ${r} ${o}`),this.svg.on("mousemove.dragconnect",function(a){if(!t.dragConnecting||!t.dragLine)return;const[i,s]=Re(a,t.nodesLayer.node());t.lastDragMousePos={x:i,y:s},t.dragLine.attr("d",`M ${r} ${o} L ${i} ${s}`)}),this.nodesLayer.selectAll(".node-group").on("click.dragconnect",function(a,i){if(t.dragConnecting){if(a.stopPropagation(),i.id!==n.id){const s=t.lastDragMousePos.x-i.x,l=t.lastDragMousePos.y-i.y;t.createConnectionWithAttachment(n.id,i.id,s,l)}t.cancelDragConnection()}}),this.svg.on("click.dragconnect",function(a){a.target===t.svg.node()&&t.cancelDragConnection()}),document.addEventListener("keydown",this.dragConnectionEscHandler=a=>{a.key==="Escape"&&t.cancelDragConnection()})}cancelDragConnection(){this.dragConnecting=!1,this.connectSourceNode=null,this.dragLine&&(this.dragLine.remove(),this.dragLine=null),this.svg.on("mousemove.dragconnect",null),this.svg.on("click.dragconnect",null),this.nodesLayer.selectAll(".node-group").on("click.dragconnect",null),this.dragConnectionEscHandler&&(document.removeEventListener("keydown",this.dragConnectionEscHandler),this.dragConnectionEscHandler=null);const t=document.getElementById("connect-mode");t&&t.setAttribute("aria-pressed","false")}selectConnection(t,n){this.selectedConnection=t,this.clearSelection(),this.connectionsLayer.selectAll(".connection-line").classed("selected",r=>r.id===t.id),this.onConnectionSelect(t),this.announce("Selected connection. Click delete to remove.")}clearConnectionSelection(){this.selectedConnection=null,this.connectionsLayer.selectAll(".connection-line").classed("selected",!1),this.onConnectionSelect(null)}handleConnectClick(t){this.connectSourceNode?this.connectSourceNode.id!==t.id&&(this.createConnection(this.connectSourceNode.id,t.id),this.connectSourceNode=null,this.clearSelection()):(this.connectSourceNode=t,this.selectNode(t),this.announce(`Connection started from ${t.label}. Click another node to connect.`))}async createConnection(t,n){try{const r=await K.connections.create({bibmap_id:this.bibmapId,source_node_id:t,target_node_id:n});this.connections.push(r),this.renderConnections(),this.announce("Connection created.")}catch(r){this.announce(`Error: ${r.message}`)}}async createConnectionWithAttachment(t,n,r,o){try{const a=await K.connections.create({bibmap_id:this.bibmapId,source_node_id:t,target_node_id:n,target_attach_x:r,target_attach_y:o});this.connections.push(a),this.renderConnections(),this.announce("Connection created.")}catch(a){this.announce(`Error: ${a.message}`)}}async deleteConnection(t){try{await K.connections.delete(t),this.connections=this.connections.filter(n=>n.id!==t),this.renderConnections(),this.announce("Connection deleted.")}catch(n){this.announce(`Error: ${n.message}`)}}async updateConnection(t,n){try{const r=await K.connections.update(t,n),o=this.connections.findIndex(a=>a.id===t);return o>=0&&(this.connections[o]=r),this.renderConnections(),r}catch(r){throw this.announce(`Error: ${r.message}`),r}}async addNode(t=100,n=100){try{const r=await K.nodes.create({bibmap_id:this.bibmapId,label:"New Node",x:t,y:n,background_color:this.defaultNodeColor,text_color:this.defaultTextColor});return this.nodes.push(r),this.render(),this.updateScreenReaderList(),this.selectNode(r),this.announce("New node created. Press Enter to edit properties."),r}catch(r){throw this.announce(`Error: ${r.message}`),r}}async updateNode(t,n){try{const r=await K.nodes.update(t,n),o=this.nodes.findIndex(a=>a.id===t);return o>=0&&(this.nodes[o]={...this.nodes[o],...r,...n}),this.render(),this.updateScreenReaderList(),this.announce("Node updated."),this.nodes[o]}catch(r){throw this.announce(`Error: ${r.message}`),r}}async deleteNode(t){try{await K.nodes.delete(t),this.nodes=this.nodes.filter(n=>n.id!==t),this.connections=this.connections.filter(n=>n.source_node_id!==t&&n.target_node_id!==t),this.render(),this.updateScreenReaderList(),this.clearSelection(),this.announce("Node deleted.")}catch(n){this.announce(`Error: ${n.message}`)}}async duplicateNode(t){var r;const n=this.nodes.find(o=>o.id===t);if(!n)return null;try{const o=await K.nodes.create({bibmap_id:this.bibmapId,label:`${n.label} (copy)`,description:n.description,x:n.x+30,y:n.y+30,background_color:n.background_color,text_color:n.text_color,border_color:n.border_color,font_size:n.font_size,font_family:n.font_family,font_bold:n.font_bold,font_italic:n.font_italic,font_underline:n.font_underline,width:n.width,height:n.height,shape:n.shape,node_style:n.node_style,link_to_references:n.link_to_references,wrap_text:n.wrap_text,taxonomy_ids:((r=n.taxonomies)==null?void 0:r.map(a=>a.id))||[]});return this.nodes.push(o),this.render(),this.updateScreenReaderList(),this.selectNode(o),this.announce("Node duplicated."),o}catch(o){throw this.announce(`Error: ${o.message}`),o}}async duplicateConnection(t){const n=this.connections.find(r=>r.id===t);if(!n)return null;try{const r=await K.connections.create({bibmap_id:this.bibmapId,source_node_id:n.source_node_id,target_node_id:n.target_node_id,line_color:n.line_color,line_width:n.line_width,line_style:n.line_style,arrow_type:n.arrow_type,label:n.label?`${n.label} (copy)`:null,show_label:n.show_label});return this.connections.push(r),this.renderConnections(),this.announce("Connection duplicated."),r}catch(r){throw this.announce(`Error: ${r.message}`),r}}getConnectionById(t){return this.connections.find(n=>n.id===t)}setDefaultColors(t,n){this.defaultNodeColor=t,this.defaultTextColor=n}updateScreenReaderList(){this.srNodeList&&(this.srNodeList.innerHTML=this.nodes.map(t=>{var n;return`
      <div role="listitem">
        ${t.label}
        ${(n=t.taxonomies)!=null&&n.length?`(Tags: ${t.taxonomies.map(r=>r.name).join(", ")})`:""}
      </div>
    `}).join(""))}getNodeById(t){return this.nodes.find(n=>n.id===t)}setReadOnly(t,n={}){this.readOnly=t;const{enableLinkedReferences:r=!1,onNodeClick:o=null}=n;t?(this.connectMode=!1,this.clearSelection(),this.clearConnectionSelection(),this.nodesLayer.selectAll(".node-group").style("cursor",r?"pointer":"default").on(".drag",null).on("mouseenter",null).on("mouseleave",null),r&&o?this.nodesLayer.selectAll(".node-group").on("click",(a,i)=>{a.stopPropagation(),i&&i.link_to_references&&o(i)}):this.nodesLayer.selectAll(".node-group").on("click",null),this.nodesLayer.selectAll(".resize-handle").style("display","none").on(".drag",null),this.connectionsLayer.selectAll(".connection-line").style("cursor","default").on("click",null)):this.render()}}var Gt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function gl(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Jt(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var gi={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(e,t){(function(n){e.exports=n()})(function(){return function n(r,o,a){function i(u,h){if(!o[u]){if(!r[u]){var g=typeof Jt=="function"&&Jt;if(!h&&g)return g(u,!0);if(s)return s(u,!0);var b=new Error("Cannot find module '"+u+"'");throw b.code="MODULE_NOT_FOUND",b}var m=o[u]={exports:{}};r[u][0].call(m.exports,function(w){var p=r[u][1][w];return i(p||w)},m,m.exports,n,r,o,a)}return o[u].exports}for(var s=typeof Jt=="function"&&Jt,l=0;l<a.length;l++)i(a[l]);return i}({1:[function(n,r,o){var a=n("./utils"),i=n("./support"),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";o.encode=function(l){for(var u,h,g,b,m,w,p,v=[],y=0,E=l.length,f=E,_=a.getTypeOf(l)!=="string";y<l.length;)f=E-y,g=_?(u=l[y++],h=y<E?l[y++]:0,y<E?l[y++]:0):(u=l.charCodeAt(y++),h=y<E?l.charCodeAt(y++):0,y<E?l.charCodeAt(y++):0),b=u>>2,m=(3&u)<<4|h>>4,w=1<f?(15&h)<<2|g>>6:64,p=2<f?63&g:64,v.push(s.charAt(b)+s.charAt(m)+s.charAt(w)+s.charAt(p));return v.join("")},o.decode=function(l){var u,h,g,b,m,w,p=0,v=0,y="data:";if(l.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var E,f=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===s.charAt(64)&&f--,l.charAt(l.length-2)===s.charAt(64)&&f--,f%1!=0)throw new Error("Invalid base64 input, bad content length.");for(E=i.uint8array?new Uint8Array(0|f):new Array(0|f);p<l.length;)u=s.indexOf(l.charAt(p++))<<2|(b=s.indexOf(l.charAt(p++)))>>4,h=(15&b)<<4|(m=s.indexOf(l.charAt(p++)))>>2,g=(3&m)<<6|(w=s.indexOf(l.charAt(p++))),E[v++]=u,m!==64&&(E[v++]=h),w!==64&&(E[v++]=g);return E}},{"./support":30,"./utils":32}],2:[function(n,r,o){var a=n("./external"),i=n("./stream/DataWorker"),s=n("./stream/Crc32Probe"),l=n("./stream/DataLengthProbe");function u(h,g,b,m,w){this.compressedSize=h,this.uncompressedSize=g,this.crc32=b,this.compression=m,this.compressedContent=w}u.prototype={getContentWorker:function(){var h=new i(a.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),g=this;return h.on("end",function(){if(this.streamInfo.data_length!==g.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new i(a.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},u.createWorkerFrom=function(h,g,b){return h.pipe(new s).pipe(new l("uncompressedSize")).pipe(g.compressWorker(b)).pipe(new l("compressedSize")).withStreamInfo("compression",g)},r.exports=u},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(n,r,o){var a=n("./stream/GenericWorker");o.STORE={magic:"\0\0",compressWorker:function(){return new a("STORE compression")},uncompressWorker:function(){return new a("STORE decompression")}},o.DEFLATE=n("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(n,r,o){var a=n("./utils"),i=function(){for(var s,l=[],u=0;u<256;u++){s=u;for(var h=0;h<8;h++)s=1&s?3988292384^s>>>1:s>>>1;l[u]=s}return l}();r.exports=function(s,l){return s!==void 0&&s.length?a.getTypeOf(s)!=="string"?function(u,h,g,b){var m=i,w=b+g;u^=-1;for(var p=b;p<w;p++)u=u>>>8^m[255&(u^h[p])];return-1^u}(0|l,s,s.length,0):function(u,h,g,b){var m=i,w=b+g;u^=-1;for(var p=b;p<w;p++)u=u>>>8^m[255&(u^h.charCodeAt(p))];return-1^u}(0|l,s,s.length,0):0}},{"./utils":32}],5:[function(n,r,o){o.base64=!1,o.binary=!1,o.dir=!1,o.createFolders=!0,o.date=null,o.compression=null,o.compressionOptions=null,o.comment=null,o.unixPermissions=null,o.dosPermissions=null},{}],6:[function(n,r,o){var a=null;a=typeof Promise<"u"?Promise:n("lie"),r.exports={Promise:a}},{lie:37}],7:[function(n,r,o){var a=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=n("pako"),s=n("./utils"),l=n("./stream/GenericWorker"),u=a?"uint8array":"array";function h(g,b){l.call(this,"FlateWorker/"+g),this._pako=null,this._pakoAction=g,this._pakoOptions=b,this.meta={}}o.magic="\b\0",s.inherits(h,l),h.prototype.processChunk=function(g){this.meta=g.meta,this._pako===null&&this._createPako(),this._pako.push(s.transformTo(u,g.data),!1)},h.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var g=this;this._pako.onData=function(b){g.push({data:b,meta:g.meta})}},o.compressWorker=function(g){return new h("Deflate",g)},o.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(n,r,o){function a(m,w){var p,v="";for(p=0;p<w;p++)v+=String.fromCharCode(255&m),m>>>=8;return v}function i(m,w,p,v,y,E){var f,_,I=m.file,N=m.compression,A=E!==u.utf8encode,U=s.transformTo("string",E(I.name)),M=s.transformTo("string",u.utf8encode(I.name)),W=I.comment,ee=s.transformTo("string",E(W)),B=s.transformTo("string",u.utf8encode(W)),R=M.length!==I.name.length,c=B.length!==W.length,S="",D="",z="",J=I.dir,P=I.date,q={crc32:0,compressedSize:0,uncompressedSize:0};w&&!p||(q.crc32=m.crc32,q.compressedSize=m.compressedSize,q.uncompressedSize=m.uncompressedSize);var $=0;w&&($|=8),A||!R&&!c||($|=2048);var L=0,te=0;J&&(L|=16),y==="UNIX"?(te=798,L|=function(Z,ce){var ue=Z;return Z||(ue=ce?16893:33204),(65535&ue)<<16}(I.unixPermissions,J)):(te=20,L|=function(Z){return 63&(Z||0)}(I.dosPermissions)),f=P.getUTCHours(),f<<=6,f|=P.getUTCMinutes(),f<<=5,f|=P.getUTCSeconds()/2,_=P.getUTCFullYear()-1980,_<<=4,_|=P.getUTCMonth()+1,_<<=5,_|=P.getUTCDate(),R&&(D=a(1,1)+a(h(U),4)+M,S+="up"+a(D.length,2)+D),c&&(z=a(1,1)+a(h(ee),4)+B,S+="uc"+a(z.length,2)+z);var Y="";return Y+=`
\0`,Y+=a($,2),Y+=N.magic,Y+=a(f,2),Y+=a(_,2),Y+=a(q.crc32,4),Y+=a(q.compressedSize,4),Y+=a(q.uncompressedSize,4),Y+=a(U.length,2),Y+=a(S.length,2),{fileRecord:g.LOCAL_FILE_HEADER+Y+U+S,dirRecord:g.CENTRAL_FILE_HEADER+a(te,2)+Y+a(ee.length,2)+"\0\0\0\0"+a(L,4)+a(v,4)+U+S+ee}}var s=n("../utils"),l=n("../stream/GenericWorker"),u=n("../utf8"),h=n("../crc32"),g=n("../signature");function b(m,w,p,v){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=w,this.zipPlatform=p,this.encodeFileName=v,this.streamFiles=m,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}s.inherits(b,l),b.prototype.push=function(m){var w=m.meta.percent||0,p=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(m):(this.bytesWritten+=m.data.length,l.prototype.push.call(this,{data:m.data,meta:{currentFile:this.currentFile,percent:p?(w+100*(p-v-1))/p:100}}))},b.prototype.openedSource=function(m){this.currentSourceOffset=this.bytesWritten,this.currentFile=m.file.name;var w=this.streamFiles&&!m.file.dir;if(w){var p=i(m,w,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:p.fileRecord,meta:{percent:0}})}else this.accumulate=!0},b.prototype.closedSource=function(m){this.accumulate=!1;var w=this.streamFiles&&!m.file.dir,p=i(m,w,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(p.dirRecord),w)this.push({data:function(v){return g.DATA_DESCRIPTOR+a(v.crc32,4)+a(v.compressedSize,4)+a(v.uncompressedSize,4)}(m),meta:{percent:100}});else for(this.push({data:p.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},b.prototype.flush=function(){for(var m=this.bytesWritten,w=0;w<this.dirRecords.length;w++)this.push({data:this.dirRecords[w],meta:{percent:100}});var p=this.bytesWritten-m,v=function(y,E,f,_,I){var N=s.transformTo("string",I(_));return g.CENTRAL_DIRECTORY_END+"\0\0\0\0"+a(y,2)+a(y,2)+a(E,4)+a(f,4)+a(N.length,2)+N}(this.dirRecords.length,p,m,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},b.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},b.prototype.registerPrevious=function(m){this._sources.push(m);var w=this;return m.on("data",function(p){w.processChunk(p)}),m.on("end",function(){w.closedSource(w.previous.streamInfo),w._sources.length?w.prepareNextSource():w.end()}),m.on("error",function(p){w.error(p)}),this},b.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},b.prototype.error=function(m){var w=this._sources;if(!l.prototype.error.call(this,m))return!1;for(var p=0;p<w.length;p++)try{w[p].error(m)}catch{}return!0},b.prototype.lock=function(){l.prototype.lock.call(this);for(var m=this._sources,w=0;w<m.length;w++)m[w].lock()},r.exports=b},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(n,r,o){var a=n("../compressions"),i=n("./ZipFileWorker");o.generateWorker=function(s,l,u){var h=new i(l.streamFiles,u,l.platform,l.encodeFileName),g=0;try{s.forEach(function(b,m){g++;var w=function(E,f){var _=E||f,I=a[_];if(!I)throw new Error(_+" is not a valid compression method !");return I}(m.options.compression,l.compression),p=m.options.compressionOptions||l.compressionOptions||{},v=m.dir,y=m.date;m._compressWorker(w,p).withStreamInfo("file",{name:b,dir:v,date:y,comment:m.comment||"",unixPermissions:m.unixPermissions,dosPermissions:m.dosPermissions}).pipe(h)}),h.entriesCount=g}catch(b){h.error(b)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(n,r,o){function a(){if(!(this instanceof a))return new a;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new a;for(var s in this)typeof this[s]!="function"&&(i[s]=this[s]);return i}}(a.prototype=n("./object")).loadAsync=n("./load"),a.support=n("./support"),a.defaults=n("./defaults"),a.version="3.10.1",a.loadAsync=function(i,s){return new a().loadAsync(i,s)},a.external=n("./external"),r.exports=a},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(n,r,o){var a=n("./utils"),i=n("./external"),s=n("./utf8"),l=n("./zipEntries"),u=n("./stream/Crc32Probe"),h=n("./nodejsUtils");function g(b){return new i.Promise(function(m,w){var p=b.decompressed.getContentWorker().pipe(new u);p.on("error",function(v){w(v)}).on("end",function(){p.streamInfo.crc32!==b.decompressed.crc32?w(new Error("Corrupted zip : CRC32 mismatch")):m()}).resume()})}r.exports=function(b,m){var w=this;return m=a.extend(m||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:s.utf8decode}),h.isNode&&h.isStream(b)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):a.prepareContent("the loaded zip file",b,!0,m.optimizedBinaryString,m.base64).then(function(p){var v=new l(m);return v.load(p),v}).then(function(p){var v=[i.Promise.resolve(p)],y=p.files;if(m.checkCRC32)for(var E=0;E<y.length;E++)v.push(g(y[E]));return i.Promise.all(v)}).then(function(p){for(var v=p.shift(),y=v.files,E=0;E<y.length;E++){var f=y[E],_=f.fileNameStr,I=a.resolve(f.fileNameStr);w.file(I,f.decompressed,{binary:!0,optimizedBinaryString:!0,date:f.date,dir:f.dir,comment:f.fileCommentStr.length?f.fileCommentStr:null,unixPermissions:f.unixPermissions,dosPermissions:f.dosPermissions,createFolders:m.createFolders}),f.dir||(w.file(I).unsafeOriginalName=_)}return v.zipComment.length&&(w.comment=v.zipComment),w})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(n,r,o){var a=n("../utils"),i=n("../stream/GenericWorker");function s(l,u){i.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(u)}a.inherits(s,i),s.prototype._bindStream=function(l){var u=this;(this._stream=l).pause(),l.on("data",function(h){u.push({data:h,meta:{percent:0}})}).on("error",function(h){u.isPaused?this.generatedError=h:u.error(h)}).on("end",function(){u.isPaused?u._upstreamEnded=!0:u.end()})},s.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},r.exports=s},{"../stream/GenericWorker":28,"../utils":32}],13:[function(n,r,o){var a=n("readable-stream").Readable;function i(s,l,u){a.call(this,l),this._helper=s;var h=this;s.on("data",function(g,b){h.push(g)||h._helper.pause(),u&&u(b)}).on("error",function(g){h.emit("error",g)}).on("end",function(){h.push(null)})}n("../utils").inherits(i,a),i.prototype._read=function(){this._helper.resume()},r.exports=i},{"../utils":32,"readable-stream":16}],14:[function(n,r,o){r.exports={isNode:typeof Buffer<"u",newBufferFrom:function(a,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(a,i);if(typeof a=="number")throw new Error('The "data" argument must not be a number');return new Buffer(a,i)},allocBuffer:function(a){if(Buffer.alloc)return Buffer.alloc(a);var i=new Buffer(a);return i.fill(0),i},isBuffer:function(a){return Buffer.isBuffer(a)},isStream:function(a){return a&&typeof a.on=="function"&&typeof a.pause=="function"&&typeof a.resume=="function"}}},{}],15:[function(n,r,o){function a(I,N,A){var U,M=s.getTypeOf(N),W=s.extend(A||{},h);W.date=W.date||new Date,W.compression!==null&&(W.compression=W.compression.toUpperCase()),typeof W.unixPermissions=="string"&&(W.unixPermissions=parseInt(W.unixPermissions,8)),W.unixPermissions&&16384&W.unixPermissions&&(W.dir=!0),W.dosPermissions&&16&W.dosPermissions&&(W.dir=!0),W.dir&&(I=y(I)),W.createFolders&&(U=v(I))&&E.call(this,U,!0);var ee=M==="string"&&W.binary===!1&&W.base64===!1;A&&A.binary!==void 0||(W.binary=!ee),(N instanceof g&&N.uncompressedSize===0||W.dir||!N||N.length===0)&&(W.base64=!1,W.binary=!0,N="",W.compression="STORE",M="string");var B=null;B=N instanceof g||N instanceof l?N:w.isNode&&w.isStream(N)?new p(I,N):s.prepareContent(I,N,W.binary,W.optimizedBinaryString,W.base64);var R=new b(I,B,W);this.files[I]=R}var i=n("./utf8"),s=n("./utils"),l=n("./stream/GenericWorker"),u=n("./stream/StreamHelper"),h=n("./defaults"),g=n("./compressedObject"),b=n("./zipObject"),m=n("./generate"),w=n("./nodejsUtils"),p=n("./nodejs/NodejsStreamInputAdapter"),v=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var N=I.lastIndexOf("/");return 0<N?I.substring(0,N):""},y=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},E=function(I,N){return N=N!==void 0?N:h.createFolders,I=y(I),this.files[I]||a.call(this,I,null,{dir:!0,createFolders:N}),this.files[I]};function f(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var N,A,U;for(N in this.files)U=this.files[N],(A=N.slice(this.root.length,N.length))&&N.slice(0,this.root.length)===this.root&&I(A,U)},filter:function(I){var N=[];return this.forEach(function(A,U){I(A,U)&&N.push(U)}),N},file:function(I,N,A){if(arguments.length!==1)return I=this.root+I,a.call(this,I,N,A),this;if(f(I)){var U=I;return this.filter(function(W,ee){return!ee.dir&&U.test(W)})}var M=this.files[this.root+I];return M&&!M.dir?M:null},folder:function(I){if(!I)return this;if(f(I))return this.filter(function(M,W){return W.dir&&I.test(M)});var N=this.root+I,A=E.call(this,N),U=this.clone();return U.root=A.name,U},remove:function(I){I=this.root+I;var N=this.files[I];if(N||(I.slice(-1)!=="/"&&(I+="/"),N=this.files[I]),N&&!N.dir)delete this.files[I];else for(var A=this.filter(function(M,W){return W.name.slice(0,I.length)===I}),U=0;U<A.length;U++)delete this.files[A[U].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var N,A={};try{if((A=s.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=A.type.toLowerCase(),A.compression=A.compression.toUpperCase(),A.type==="binarystring"&&(A.type="string"),!A.type)throw new Error("No output type specified.");s.checkSupport(A.type),A.platform!=="darwin"&&A.platform!=="freebsd"&&A.platform!=="linux"&&A.platform!=="sunos"||(A.platform="UNIX"),A.platform==="win32"&&(A.platform="DOS");var U=A.comment||this.comment||"";N=m.generateWorker(this,A,U)}catch(M){(N=new l("error")).error(M)}return new u(N,A.type||"string",A.mimeType)},generateAsync:function(I,N){return this.generateInternalStream(I).accumulate(N)},generateNodeStream:function(I,N){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(N)}};r.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(n,r,o){r.exports=n("stream")},{stream:void 0}],17:[function(n,r,o){var a=n("./DataReader");function i(s){a.call(this,s);for(var l=0;l<this.data.length;l++)s[l]=255&s[l]}n("../utils").inherits(i,a),i.prototype.byteAt=function(s){return this.data[this.zero+s]},i.prototype.lastIndexOfSignature=function(s){for(var l=s.charCodeAt(0),u=s.charCodeAt(1),h=s.charCodeAt(2),g=s.charCodeAt(3),b=this.length-4;0<=b;--b)if(this.data[b]===l&&this.data[b+1]===u&&this.data[b+2]===h&&this.data[b+3]===g)return b-this.zero;return-1},i.prototype.readAndCheckSignature=function(s){var l=s.charCodeAt(0),u=s.charCodeAt(1),h=s.charCodeAt(2),g=s.charCodeAt(3),b=this.readData(4);return l===b[0]&&u===b[1]&&h===b[2]&&g===b[3]},i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,l},r.exports=i},{"../utils":32,"./DataReader":18}],18:[function(n,r,o){var a=n("../utils");function i(s){this.data=s,this.length=s.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(s){this.checkIndex(this.index+s)},checkIndex:function(s){if(this.length<this.zero+s||s<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+s+"). Corrupted zip ?")},setIndex:function(s){this.checkIndex(s),this.index=s},skip:function(s){this.setIndex(this.index+s)},byteAt:function(){},readInt:function(s){var l,u=0;for(this.checkOffset(s),l=this.index+s-1;l>=this.index;l--)u=(u<<8)+this.byteAt(l);return this.index+=s,u},readString:function(s){return a.transformTo("string",this.readData(s))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var s=this.readInt(4);return new Date(Date.UTC(1980+(s>>25&127),(s>>21&15)-1,s>>16&31,s>>11&31,s>>5&63,(31&s)<<1))}},r.exports=i},{"../utils":32}],19:[function(n,r,o){var a=n("./Uint8ArrayReader");function i(s){a.call(this,s)}n("../utils").inherits(i,a),i.prototype.readData=function(s){this.checkOffset(s);var l=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,l},r.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(n,r,o){var a=n("./DataReader");function i(s){a.call(this,s)}n("../utils").inherits(i,a),i.prototype.byteAt=function(s){return this.data.charCodeAt(this.zero+s)},i.prototype.lastIndexOfSignature=function(s){return this.data.lastIndexOf(s)-this.zero},i.prototype.readAndCheckSignature=function(s){return s===this.readData(4)},i.prototype.readData=function(s){this.checkOffset(s);var l=this.data.slice(this.zero+this.index,this.zero+this.index+s);return this.index+=s,l},r.exports=i},{"../utils":32,"./DataReader":18}],21:[function(n,r,o){var a=n("./ArrayReader");function i(s){a.call(this,s)}n("../utils").inherits(i,a),i.prototype.readData=function(s){if(this.checkOffset(s),s===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+s);return this.index+=s,l},r.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(n,r,o){var a=n("../utils"),i=n("../support"),s=n("./ArrayReader"),l=n("./StringReader"),u=n("./NodeBufferReader"),h=n("./Uint8ArrayReader");r.exports=function(g){var b=a.getTypeOf(g);return a.checkSupport(b),b!=="string"||i.uint8array?b==="nodebuffer"?new u(g):i.uint8array?new h(a.transformTo("uint8array",g)):new s(a.transformTo("array",g)):new l(g)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(n,r,o){o.LOCAL_FILE_HEADER="PK",o.CENTRAL_FILE_HEADER="PK",o.CENTRAL_DIRECTORY_END="PK",o.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",o.ZIP64_CENTRAL_DIRECTORY_END="PK",o.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(n,r,o){var a=n("./GenericWorker"),i=n("../utils");function s(l){a.call(this,"ConvertWorker to "+l),this.destType=l}i.inherits(s,a),s.prototype.processChunk=function(l){this.push({data:i.transformTo(this.destType,l.data),meta:l.meta})},r.exports=s},{"../utils":32,"./GenericWorker":28}],25:[function(n,r,o){var a=n("./GenericWorker"),i=n("../crc32");function s(){a.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}n("../utils").inherits(s,a),s.prototype.processChunk=function(l){this.streamInfo.crc32=i(l.data,this.streamInfo.crc32||0),this.push(l)},r.exports=s},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(n,r,o){var a=n("../utils"),i=n("./GenericWorker");function s(l){i.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}a.inherits(s,i),s.prototype.processChunk=function(l){if(l){var u=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=u+l.data.length}i.prototype.processChunk.call(this,l)},r.exports=s},{"../utils":32,"./GenericWorker":28}],27:[function(n,r,o){var a=n("../utils"),i=n("./GenericWorker");function s(l){i.call(this,"DataWorker");var u=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(h){u.dataIsReady=!0,u.data=h,u.max=h&&h.length||0,u.type=a.getTypeOf(h),u.isPaused||u._tickAndRepeat()},function(h){u.error(h)})}a.inherits(s,i),s.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},s.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,a.delay(this._tickAndRepeat,[],this)),!0)},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(a.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,u=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,u);break;case"uint8array":l=this.data.subarray(this.index,u);break;case"array":case"nodebuffer":l=this.data.slice(this.index,u)}return this.index=u,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},r.exports=s},{"../utils":32,"./GenericWorker":28}],28:[function(n,r,o){function a(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}a.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,s){return this._listeners[i].push(s),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,s){if(this._listeners[i])for(var l=0;l<this._listeners[i].length;l++)this._listeners[i][l].call(this,s)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var s=this;return i.on("data",function(l){s.processChunk(l)}),i.on("end",function(){s.end()}),i.on("error",function(l){s.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,s){return this.extraStreamInfo[i]=s,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},r.exports=a},{}],29:[function(n,r,o){var a=n("../utils"),i=n("./ConvertWorker"),s=n("./GenericWorker"),l=n("../base64"),u=n("../support"),h=n("../external"),g=null;if(u.nodestream)try{g=n("../nodejs/NodejsStreamOutputAdapter")}catch{}function b(w,p){return new h.Promise(function(v,y){var E=[],f=w._internalType,_=w._outputType,I=w._mimeType;w.on("data",function(N,A){E.push(N),p&&p(A)}).on("error",function(N){E=[],y(N)}).on("end",function(){try{var N=function(A,U,M){switch(A){case"blob":return a.newBlob(a.transformTo("arraybuffer",U),M);case"base64":return l.encode(U);default:return a.transformTo(A,U)}}(_,function(A,U){var M,W=0,ee=null,B=0;for(M=0;M<U.length;M++)B+=U[M].length;switch(A){case"string":return U.join("");case"array":return Array.prototype.concat.apply([],U);case"uint8array":for(ee=new Uint8Array(B),M=0;M<U.length;M++)ee.set(U[M],W),W+=U[M].length;return ee;case"nodebuffer":return Buffer.concat(U);default:throw new Error("concat : unsupported type '"+A+"'")}}(f,E),I);v(N)}catch(A){y(A)}E=[]}).resume()})}function m(w,p,v){var y=p;switch(p){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=p,this._mimeType=v,a.checkSupport(y),this._worker=w.pipe(new i(y)),w.lock()}catch(E){this._worker=new s("error"),this._worker.error(E)}}m.prototype={accumulate:function(w){return b(this,w)},on:function(w,p){var v=this;return w==="data"?this._worker.on(w,function(y){p.call(v,y.data,y.meta)}):this._worker.on(w,function(){a.delay(p,arguments,v)}),this},resume:function(){return a.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(w){if(a.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new g(this,{objectMode:this._outputType!=="nodebuffer"},w)}},r.exports=m},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(n,r,o){if(o.base64=!0,o.array=!0,o.string=!0,o.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",o.nodebuffer=typeof Buffer<"u",o.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")o.blob=!1;else{var a=new ArrayBuffer(0);try{o.blob=new Blob([a],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(a),o.blob=i.getBlob("application/zip").size===0}catch{o.blob=!1}}}try{o.nodestream=!!n("readable-stream").Readable}catch{o.nodestream=!1}},{"readable-stream":16}],31:[function(n,r,o){for(var a=n("./utils"),i=n("./support"),s=n("./nodejsUtils"),l=n("./stream/GenericWorker"),u=new Array(256),h=0;h<256;h++)u[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;u[254]=u[254]=1;function g(){l.call(this,"utf-8 decode"),this.leftOver=null}function b(){l.call(this,"utf-8 encode")}o.utf8encode=function(m){return i.nodebuffer?s.newBufferFrom(m,"utf-8"):function(w){var p,v,y,E,f,_=w.length,I=0;for(E=0;E<_;E++)(64512&(v=w.charCodeAt(E)))==55296&&E+1<_&&(64512&(y=w.charCodeAt(E+1)))==56320&&(v=65536+(v-55296<<10)+(y-56320),E++),I+=v<128?1:v<2048?2:v<65536?3:4;for(p=i.uint8array?new Uint8Array(I):new Array(I),E=f=0;f<I;E++)(64512&(v=w.charCodeAt(E)))==55296&&E+1<_&&(64512&(y=w.charCodeAt(E+1)))==56320&&(v=65536+(v-55296<<10)+(y-56320),E++),v<128?p[f++]=v:(v<2048?p[f++]=192|v>>>6:(v<65536?p[f++]=224|v>>>12:(p[f++]=240|v>>>18,p[f++]=128|v>>>12&63),p[f++]=128|v>>>6&63),p[f++]=128|63&v);return p}(m)},o.utf8decode=function(m){return i.nodebuffer?a.transformTo("nodebuffer",m).toString("utf-8"):function(w){var p,v,y,E,f=w.length,_=new Array(2*f);for(p=v=0;p<f;)if((y=w[p++])<128)_[v++]=y;else if(4<(E=u[y]))_[v++]=65533,p+=E-1;else{for(y&=E===2?31:E===3?15:7;1<E&&p<f;)y=y<<6|63&w[p++],E--;1<E?_[v++]=65533:y<65536?_[v++]=y:(y-=65536,_[v++]=55296|y>>10&1023,_[v++]=56320|1023&y)}return _.length!==v&&(_.subarray?_=_.subarray(0,v):_.length=v),a.applyFromCharCode(_)}(m=a.transformTo(i.uint8array?"uint8array":"array",m))},a.inherits(g,l),g.prototype.processChunk=function(m){var w=a.transformTo(i.uint8array?"uint8array":"array",m.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var p=w;(w=new Uint8Array(p.length+this.leftOver.length)).set(this.leftOver,0),w.set(p,this.leftOver.length)}else w=this.leftOver.concat(w);this.leftOver=null}var v=function(E,f){var _;for((f=f||E.length)>E.length&&(f=E.length),_=f-1;0<=_&&(192&E[_])==128;)_--;return _<0||_===0?f:_+u[E[_]]>f?_:f}(w),y=w;v!==w.length&&(i.uint8array?(y=w.subarray(0,v),this.leftOver=w.subarray(v,w.length)):(y=w.slice(0,v),this.leftOver=w.slice(v,w.length))),this.push({data:o.utf8decode(y),meta:m.meta})},g.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:o.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},o.Utf8DecodeWorker=g,a.inherits(b,l),b.prototype.processChunk=function(m){this.push({data:o.utf8encode(m.data),meta:m.meta})},o.Utf8EncodeWorker=b},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(n,r,o){var a=n("./support"),i=n("./base64"),s=n("./nodejsUtils"),l=n("./external");function u(p){return p}function h(p,v){for(var y=0;y<p.length;++y)v[y]=255&p.charCodeAt(y);return v}n("setimmediate"),o.newBlob=function(p,v){o.checkSupport("blob");try{return new Blob([p],{type:v})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(p),y.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var g={stringifyByChunk:function(p,v,y){var E=[],f=0,_=p.length;if(_<=y)return String.fromCharCode.apply(null,p);for(;f<_;)v==="array"||v==="nodebuffer"?E.push(String.fromCharCode.apply(null,p.slice(f,Math.min(f+y,_)))):E.push(String.fromCharCode.apply(null,p.subarray(f,Math.min(f+y,_)))),f+=y;return E.join("")},stringifyByChar:function(p){for(var v="",y=0;y<p.length;y++)v+=String.fromCharCode(p[y]);return v},applyCanBeUsed:{uint8array:function(){try{return a.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return a.nodebuffer&&String.fromCharCode.apply(null,s.allocBuffer(1)).length===1}catch{return!1}}()}};function b(p){var v=65536,y=o.getTypeOf(p),E=!0;if(y==="uint8array"?E=g.applyCanBeUsed.uint8array:y==="nodebuffer"&&(E=g.applyCanBeUsed.nodebuffer),E)for(;1<v;)try{return g.stringifyByChunk(p,y,v)}catch{v=Math.floor(v/2)}return g.stringifyByChar(p)}function m(p,v){for(var y=0;y<p.length;y++)v[y]=p[y];return v}o.applyFromCharCode=b;var w={};w.string={string:u,array:function(p){return h(p,new Array(p.length))},arraybuffer:function(p){return w.string.uint8array(p).buffer},uint8array:function(p){return h(p,new Uint8Array(p.length))},nodebuffer:function(p){return h(p,s.allocBuffer(p.length))}},w.array={string:b,array:u,arraybuffer:function(p){return new Uint8Array(p).buffer},uint8array:function(p){return new Uint8Array(p)},nodebuffer:function(p){return s.newBufferFrom(p)}},w.arraybuffer={string:function(p){return b(new Uint8Array(p))},array:function(p){return m(new Uint8Array(p),new Array(p.byteLength))},arraybuffer:u,uint8array:function(p){return new Uint8Array(p)},nodebuffer:function(p){return s.newBufferFrom(new Uint8Array(p))}},w.uint8array={string:b,array:function(p){return m(p,new Array(p.length))},arraybuffer:function(p){return p.buffer},uint8array:u,nodebuffer:function(p){return s.newBufferFrom(p)}},w.nodebuffer={string:b,array:function(p){return m(p,new Array(p.length))},arraybuffer:function(p){return w.nodebuffer.uint8array(p).buffer},uint8array:function(p){return m(p,new Uint8Array(p.length))},nodebuffer:u},o.transformTo=function(p,v){if(v=v||"",!p)return v;o.checkSupport(p);var y=o.getTypeOf(v);return w[y][p](v)},o.resolve=function(p){for(var v=p.split("/"),y=[],E=0;E<v.length;E++){var f=v[E];f==="."||f===""&&E!==0&&E!==v.length-1||(f===".."?y.pop():y.push(f))}return y.join("/")},o.getTypeOf=function(p){return typeof p=="string"?"string":Object.prototype.toString.call(p)==="[object Array]"?"array":a.nodebuffer&&s.isBuffer(p)?"nodebuffer":a.uint8array&&p instanceof Uint8Array?"uint8array":a.arraybuffer&&p instanceof ArrayBuffer?"arraybuffer":void 0},o.checkSupport=function(p){if(!a[p.toLowerCase()])throw new Error(p+" is not supported by this platform")},o.MAX_VALUE_16BITS=65535,o.MAX_VALUE_32BITS=-1,o.pretty=function(p){var v,y,E="";for(y=0;y<(p||"").length;y++)E+="\\x"+((v=p.charCodeAt(y))<16?"0":"")+v.toString(16).toUpperCase();return E},o.delay=function(p,v,y){setImmediate(function(){p.apply(y||null,v||[])})},o.inherits=function(p,v){function y(){}y.prototype=v.prototype,p.prototype=new y},o.extend=function(){var p,v,y={};for(p=0;p<arguments.length;p++)for(v in arguments[p])Object.prototype.hasOwnProperty.call(arguments[p],v)&&y[v]===void 0&&(y[v]=arguments[p][v]);return y},o.prepareContent=function(p,v,y,E,f){return l.Promise.resolve(v).then(function(_){return a.blob&&(_ instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(_))!==-1)&&typeof FileReader<"u"?new l.Promise(function(I,N){var A=new FileReader;A.onload=function(U){I(U.target.result)},A.onerror=function(U){N(U.target.error)},A.readAsArrayBuffer(_)}):_}).then(function(_){var I=o.getTypeOf(_);return I?(I==="arraybuffer"?_=o.transformTo("uint8array",_):I==="string"&&(f?_=i.decode(_):y&&E!==!0&&(_=function(N){return h(N,a.uint8array?new Uint8Array(N.length):new Array(N.length))}(_))),_):l.Promise.reject(new Error("Can't read the data of '"+p+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(n,r,o){var a=n("./reader/readerFor"),i=n("./utils"),s=n("./signature"),l=n("./zipEntry"),u=n("./support");function h(g){this.files=[],this.loadOptions=g}h.prototype={checkSignature:function(g){if(!this.reader.readAndCheckSignature(g)){this.reader.index-=4;var b=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(b)+", expected "+i.pretty(g)+")")}},isSignature:function(g,b){var m=this.reader.index;this.reader.setIndex(g);var w=this.reader.readString(4)===b;return this.reader.setIndex(m),w},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var g=this.reader.readData(this.zipCommentLength),b=u.uint8array?"uint8array":"array",m=i.transformTo(b,g);this.zipComment=this.loadOptions.decodeFileName(m)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var g,b,m,w=this.zip64EndOfCentralSize-44;0<w;)g=this.reader.readInt(2),b=this.reader.readInt(4),m=this.reader.readData(b),this.zip64ExtensibleData[g]={id:g,length:b,value:m}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var g,b;for(g=0;g<this.files.length;g++)b=this.files[g],this.reader.setIndex(b.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),b.readLocalPart(this.reader),b.handleUTF8(),b.processAttributes()},readCentralDir:function(){var g;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(g=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(g);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var g=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(g<0)throw this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(g);var b=g;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(g=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(g),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var m=this.centralDirOffset+this.centralDirSize;this.zip64&&(m+=20,m+=12+this.zip64EndOfCentralSize);var w=b-m;if(0<w)this.isSignature(b,s.CENTRAL_FILE_HEADER)||(this.reader.zero=w);else if(w<0)throw new Error("Corrupted zip: missing "+Math.abs(w)+" bytes.")},prepareReader:function(g){this.reader=a(g)},load:function(g){this.prepareReader(g),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},r.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(n,r,o){var a=n("./reader/readerFor"),i=n("./utils"),s=n("./compressedObject"),l=n("./crc32"),u=n("./utf8"),h=n("./compressions"),g=n("./support");function b(m,w){this.options=m,this.loadOptions=w}b.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(m){var w,p;if(m.skip(22),this.fileNameLength=m.readInt(2),p=m.readInt(2),this.fileName=m.readData(this.fileNameLength),m.skip(p),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((w=function(v){for(var y in h)if(Object.prototype.hasOwnProperty.call(h,y)&&h[y].magic===v)return h[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new s(this.compressedSize,this.uncompressedSize,this.crc32,w,m.readData(this.compressedSize))},readCentralPart:function(m){this.versionMadeBy=m.readInt(2),m.skip(2),this.bitFlag=m.readInt(2),this.compressionMethod=m.readString(2),this.date=m.readDate(),this.crc32=m.readInt(4),this.compressedSize=m.readInt(4),this.uncompressedSize=m.readInt(4);var w=m.readInt(2);if(this.extraFieldsLength=m.readInt(2),this.fileCommentLength=m.readInt(2),this.diskNumberStart=m.readInt(2),this.internalFileAttributes=m.readInt(2),this.externalFileAttributes=m.readInt(4),this.localHeaderOffset=m.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");m.skip(w),this.readExtraFields(m),this.parseZIP64ExtraField(m),this.fileComment=m.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var m=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),m==0&&(this.dosPermissions=63&this.externalFileAttributes),m==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var m=a(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=m.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=m.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=m.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=m.readInt(4))}},readExtraFields:function(m){var w,p,v,y=m.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});m.index+4<y;)w=m.readInt(2),p=m.readInt(2),v=m.readData(p),this.extraFields[w]={id:w,length:p,value:v};m.setIndex(y)},handleUTF8:function(){var m=g.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=u.utf8decode(this.fileName),this.fileCommentStr=u.utf8decode(this.fileComment);else{var w=this.findExtraFieldUnicodePath();if(w!==null)this.fileNameStr=w;else{var p=i.transformTo(m,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(p)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var y=i.transformTo(m,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var m=this.extraFields[28789];if(m){var w=a(m.value);return w.readInt(1)!==1||l(this.fileName)!==w.readInt(4)?null:u.utf8decode(w.readData(m.length-5))}return null},findExtraFieldUnicodeComment:function(){var m=this.extraFields[25461];if(m){var w=a(m.value);return w.readInt(1)!==1||l(this.fileComment)!==w.readInt(4)?null:u.utf8decode(w.readData(m.length-5))}return null}},r.exports=b},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(n,r,o){function a(w,p,v){this.name=w,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=p,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var i=n("./stream/StreamHelper"),s=n("./stream/DataWorker"),l=n("./utf8"),u=n("./compressedObject"),h=n("./stream/GenericWorker");a.prototype={internalStream:function(w){var p=null,v="string";try{if(!w)throw new Error("No output type specified.");var y=(v=w.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),p=this._decompressWorker();var E=!this._dataBinary;E&&!y&&(p=p.pipe(new l.Utf8EncodeWorker)),!E&&y&&(p=p.pipe(new l.Utf8DecodeWorker))}catch(f){(p=new h("error")).error(f)}return new i(p,v,"")},async:function(w,p){return this.internalStream(w).accumulate(p)},nodeStream:function(w,p){return this.internalStream(w||"nodebuffer").toNodejsStream(p)},_compressWorker:function(w,p){if(this._data instanceof u&&this._data.compression.magic===w.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new l.Utf8EncodeWorker)),u.createWorkerFrom(v,w,p)},_decompressWorker:function(){return this._data instanceof u?this._data.getContentWorker():this._data instanceof h?this._data:new s(this._data)}};for(var g=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],b=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},m=0;m<g.length;m++)a.prototype[g[m]]=b;r.exports=a},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(n,r,o){(function(a){var i,s,l=a.MutationObserver||a.WebKitMutationObserver;if(l){var u=0,h=new l(w),g=a.document.createTextNode("");h.observe(g,{characterData:!0}),i=function(){g.data=u=++u%2}}else if(a.setImmediate||a.MessageChannel===void 0)i="document"in a&&"onreadystatechange"in a.document.createElement("script")?function(){var p=a.document.createElement("script");p.onreadystatechange=function(){w(),p.onreadystatechange=null,p.parentNode.removeChild(p),p=null},a.document.documentElement.appendChild(p)}:function(){setTimeout(w,0)};else{var b=new a.MessageChannel;b.port1.onmessage=w,i=function(){b.port2.postMessage(0)}}var m=[];function w(){var p,v;s=!0;for(var y=m.length;y;){for(v=m,m=[],p=-1;++p<y;)v[p]();y=m.length}s=!1}r.exports=function(p){m.push(p)!==1||s||i()}}).call(this,typeof Gt<"u"?Gt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(n,r,o){var a=n("immediate");function i(){}var s={},l=["REJECTED"],u=["FULFILLED"],h=["PENDING"];function g(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,y!==i&&p(this,y)}function b(y,E,f){this.promise=y,typeof E=="function"&&(this.onFulfilled=E,this.callFulfilled=this.otherCallFulfilled),typeof f=="function"&&(this.onRejected=f,this.callRejected=this.otherCallRejected)}function m(y,E,f){a(function(){var _;try{_=E(f)}catch(I){return s.reject(y,I)}_===y?s.reject(y,new TypeError("Cannot resolve promise with itself")):s.resolve(y,_)})}function w(y){var E=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof E=="function")return function(){E.apply(y,arguments)}}function p(y,E){var f=!1;function _(A){f||(f=!0,s.reject(y,A))}function I(A){f||(f=!0,s.resolve(y,A))}var N=v(function(){E(I,_)});N.status==="error"&&_(N.value)}function v(y,E){var f={};try{f.value=y(E),f.status="success"}catch(_){f.status="error",f.value=_}return f}(r.exports=g).prototype.finally=function(y){if(typeof y!="function")return this;var E=this.constructor;return this.then(function(f){return E.resolve(y()).then(function(){return f})},function(f){return E.resolve(y()).then(function(){throw f})})},g.prototype.catch=function(y){return this.then(null,y)},g.prototype.then=function(y,E){if(typeof y!="function"&&this.state===u||typeof E!="function"&&this.state===l)return this;var f=new this.constructor(i);return this.state!==h?m(f,this.state===u?y:E,this.outcome):this.queue.push(new b(f,y,E)),f},b.prototype.callFulfilled=function(y){s.resolve(this.promise,y)},b.prototype.otherCallFulfilled=function(y){m(this.promise,this.onFulfilled,y)},b.prototype.callRejected=function(y){s.reject(this.promise,y)},b.prototype.otherCallRejected=function(y){m(this.promise,this.onRejected,y)},s.resolve=function(y,E){var f=v(w,E);if(f.status==="error")return s.reject(y,f.value);var _=f.value;if(_)p(y,_);else{y.state=u,y.outcome=E;for(var I=-1,N=y.queue.length;++I<N;)y.queue[I].callFulfilled(E)}return y},s.reject=function(y,E){y.state=l,y.outcome=E;for(var f=-1,_=y.queue.length;++f<_;)y.queue[f].callRejected(E);return y},g.resolve=function(y){return y instanceof this?y:s.resolve(new this(i),y)},g.reject=function(y){var E=new this(i);return s.reject(E,y)},g.all=function(y){var E=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var f=y.length,_=!1;if(!f)return this.resolve([]);for(var I=new Array(f),N=0,A=-1,U=new this(i);++A<f;)M(y[A],A);return U;function M(W,ee){E.resolve(W).then(function(B){I[ee]=B,++N!==f||_||(_=!0,s.resolve(U,I))},function(B){_||(_=!0,s.reject(U,B))})}},g.race=function(y){var E=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var f=y.length,_=!1;if(!f)return this.resolve([]);for(var I=-1,N=new this(i);++I<f;)A=y[I],E.resolve(A).then(function(U){_||(_=!0,s.resolve(N,U))},function(U){_||(_=!0,s.reject(N,U))});var A;return N}},{immediate:36}],38:[function(n,r,o){var a={};(0,n("./lib/utils/common").assign)(a,n("./lib/deflate"),n("./lib/inflate"),n("./lib/zlib/constants")),r.exports=a},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(n,r,o){var a=n("./zlib/deflate"),i=n("./utils/common"),s=n("./utils/strings"),l=n("./zlib/messages"),u=n("./zlib/zstream"),h=Object.prototype.toString,g=0,b=-1,m=0,w=8;function p(y){if(!(this instanceof p))return new p(y);this.options=i.assign({level:b,method:w,chunkSize:16384,windowBits:15,memLevel:8,strategy:m,to:""},y||{});var E=this.options;E.raw&&0<E.windowBits?E.windowBits=-E.windowBits:E.gzip&&0<E.windowBits&&E.windowBits<16&&(E.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var f=a.deflateInit2(this.strm,E.level,E.method,E.windowBits,E.memLevel,E.strategy);if(f!==g)throw new Error(l[f]);if(E.header&&a.deflateSetHeader(this.strm,E.header),E.dictionary){var _;if(_=typeof E.dictionary=="string"?s.string2buf(E.dictionary):h.call(E.dictionary)==="[object ArrayBuffer]"?new Uint8Array(E.dictionary):E.dictionary,(f=a.deflateSetDictionary(this.strm,_))!==g)throw new Error(l[f]);this._dict_set=!0}}function v(y,E){var f=new p(E);if(f.push(y,!0),f.err)throw f.msg||l[f.err];return f.result}p.prototype.push=function(y,E){var f,_,I=this.strm,N=this.options.chunkSize;if(this.ended)return!1;_=E===~~E?E:E===!0?4:0,typeof y=="string"?I.input=s.string2buf(y):h.call(y)==="[object ArrayBuffer]"?I.input=new Uint8Array(y):I.input=y,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new i.Buf8(N),I.next_out=0,I.avail_out=N),(f=a.deflate(I,_))!==1&&f!==g)return this.onEnd(f),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||_!==4&&_!==2)||(this.options.to==="string"?this.onData(s.buf2binstring(i.shrinkBuf(I.output,I.next_out))):this.onData(i.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&f!==1);return _===4?(f=a.deflateEnd(this.strm),this.onEnd(f),this.ended=!0,f===g):_!==2||(this.onEnd(g),!(I.avail_out=0))},p.prototype.onData=function(y){this.chunks.push(y)},p.prototype.onEnd=function(y){y===g&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},o.Deflate=p,o.deflate=v,o.deflateRaw=function(y,E){return(E=E||{}).raw=!0,v(y,E)},o.gzip=function(y,E){return(E=E||{}).gzip=!0,v(y,E)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(n,r,o){var a=n("./zlib/inflate"),i=n("./utils/common"),s=n("./utils/strings"),l=n("./zlib/constants"),u=n("./zlib/messages"),h=n("./zlib/zstream"),g=n("./zlib/gzheader"),b=Object.prototype.toString;function m(p){if(!(this instanceof m))return new m(p);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},p||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||p&&p.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var y=a.inflateInit2(this.strm,v.windowBits);if(y!==l.Z_OK)throw new Error(u[y]);this.header=new g,a.inflateGetHeader(this.strm,this.header)}function w(p,v){var y=new m(v);if(y.push(p,!0),y.err)throw y.msg||u[y.err];return y.result}m.prototype.push=function(p,v){var y,E,f,_,I,N,A=this.strm,U=this.options.chunkSize,M=this.options.dictionary,W=!1;if(this.ended)return!1;E=v===~~v?v:v===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof p=="string"?A.input=s.binstring2buf(p):b.call(p)==="[object ArrayBuffer]"?A.input=new Uint8Array(p):A.input=p,A.next_in=0,A.avail_in=A.input.length;do{if(A.avail_out===0&&(A.output=new i.Buf8(U),A.next_out=0,A.avail_out=U),(y=a.inflate(A,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&M&&(N=typeof M=="string"?s.string2buf(M):b.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,y=a.inflateSetDictionary(this.strm,N)),y===l.Z_BUF_ERROR&&W===!0&&(y=l.Z_OK,W=!1),y!==l.Z_STREAM_END&&y!==l.Z_OK)return this.onEnd(y),!(this.ended=!0);A.next_out&&(A.avail_out!==0&&y!==l.Z_STREAM_END&&(A.avail_in!==0||E!==l.Z_FINISH&&E!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(f=s.utf8border(A.output,A.next_out),_=A.next_out-f,I=s.buf2string(A.output,f),A.next_out=_,A.avail_out=U-_,_&&i.arraySet(A.output,A.output,f,_,0),this.onData(I)):this.onData(i.shrinkBuf(A.output,A.next_out)))),A.avail_in===0&&A.avail_out===0&&(W=!0)}while((0<A.avail_in||A.avail_out===0)&&y!==l.Z_STREAM_END);return y===l.Z_STREAM_END&&(E=l.Z_FINISH),E===l.Z_FINISH?(y=a.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===l.Z_OK):E!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(A.avail_out=0))},m.prototype.onData=function(p){this.chunks.push(p)},m.prototype.onEnd=function(p){p===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg},o.Inflate=m,o.inflate=w,o.inflateRaw=function(p,v){return(v=v||{}).raw=!0,w(p,v)},o.ungzip=w},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(n,r,o){var a=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";o.assign=function(l){for(var u=Array.prototype.slice.call(arguments,1);u.length;){var h=u.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var g in h)h.hasOwnProperty(g)&&(l[g]=h[g])}}return l},o.shrinkBuf=function(l,u){return l.length===u?l:l.subarray?l.subarray(0,u):(l.length=u,l)};var i={arraySet:function(l,u,h,g,b){if(u.subarray&&l.subarray)l.set(u.subarray(h,h+g),b);else for(var m=0;m<g;m++)l[b+m]=u[h+m]},flattenChunks:function(l){var u,h,g,b,m,w;for(u=g=0,h=l.length;u<h;u++)g+=l[u].length;for(w=new Uint8Array(g),u=b=0,h=l.length;u<h;u++)m=l[u],w.set(m,b),b+=m.length;return w}},s={arraySet:function(l,u,h,g,b){for(var m=0;m<g;m++)l[b+m]=u[h+m]},flattenChunks:function(l){return[].concat.apply([],l)}};o.setTyped=function(l){l?(o.Buf8=Uint8Array,o.Buf16=Uint16Array,o.Buf32=Int32Array,o.assign(o,i)):(o.Buf8=Array,o.Buf16=Array,o.Buf32=Array,o.assign(o,s))},o.setTyped(a)},{}],42:[function(n,r,o){var a=n("./common"),i=!0,s=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s=!1}for(var l=new a.Buf8(256),u=0;u<256;u++)l[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;function h(g,b){if(b<65537&&(g.subarray&&s||!g.subarray&&i))return String.fromCharCode.apply(null,a.shrinkBuf(g,b));for(var m="",w=0;w<b;w++)m+=String.fromCharCode(g[w]);return m}l[254]=l[254]=1,o.string2buf=function(g){var b,m,w,p,v,y=g.length,E=0;for(p=0;p<y;p++)(64512&(m=g.charCodeAt(p)))==55296&&p+1<y&&(64512&(w=g.charCodeAt(p+1)))==56320&&(m=65536+(m-55296<<10)+(w-56320),p++),E+=m<128?1:m<2048?2:m<65536?3:4;for(b=new a.Buf8(E),p=v=0;v<E;p++)(64512&(m=g.charCodeAt(p)))==55296&&p+1<y&&(64512&(w=g.charCodeAt(p+1)))==56320&&(m=65536+(m-55296<<10)+(w-56320),p++),m<128?b[v++]=m:(m<2048?b[v++]=192|m>>>6:(m<65536?b[v++]=224|m>>>12:(b[v++]=240|m>>>18,b[v++]=128|m>>>12&63),b[v++]=128|m>>>6&63),b[v++]=128|63&m);return b},o.buf2binstring=function(g){return h(g,g.length)},o.binstring2buf=function(g){for(var b=new a.Buf8(g.length),m=0,w=b.length;m<w;m++)b[m]=g.charCodeAt(m);return b},o.buf2string=function(g,b){var m,w,p,v,y=b||g.length,E=new Array(2*y);for(m=w=0;m<y;)if((p=g[m++])<128)E[w++]=p;else if(4<(v=l[p]))E[w++]=65533,m+=v-1;else{for(p&=v===2?31:v===3?15:7;1<v&&m<y;)p=p<<6|63&g[m++],v--;1<v?E[w++]=65533:p<65536?E[w++]=p:(p-=65536,E[w++]=55296|p>>10&1023,E[w++]=56320|1023&p)}return h(E,w)},o.utf8border=function(g,b){var m;for((b=b||g.length)>g.length&&(b=g.length),m=b-1;0<=m&&(192&g[m])==128;)m--;return m<0||m===0?b:m+l[g[m]]>b?m:b}},{"./common":41}],43:[function(n,r,o){r.exports=function(a,i,s,l){for(var u=65535&a|0,h=a>>>16&65535|0,g=0;s!==0;){for(s-=g=2e3<s?2e3:s;h=h+(u=u+i[l++]|0)|0,--g;);u%=65521,h%=65521}return u|h<<16|0}},{}],44:[function(n,r,o){r.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(n,r,o){var a=function(){for(var i,s=[],l=0;l<256;l++){i=l;for(var u=0;u<8;u++)i=1&i?3988292384^i>>>1:i>>>1;s[l]=i}return s}();r.exports=function(i,s,l,u){var h=a,g=u+l;i^=-1;for(var b=u;b<g;b++)i=i>>>8^h[255&(i^s[b])];return-1^i}},{}],46:[function(n,r,o){var a,i=n("../utils/common"),s=n("./trees"),l=n("./adler32"),u=n("./crc32"),h=n("./messages"),g=0,b=4,m=0,w=-2,p=-1,v=4,y=2,E=8,f=9,_=286,I=30,N=19,A=2*_+1,U=15,M=3,W=258,ee=W+M+1,B=42,R=113,c=1,S=2,D=3,z=4;function J(d,F){return d.msg=h[F],F}function P(d){return(d<<1)-(4<d?9:0)}function q(d){for(var F=d.length;0<=--F;)d[F]=0}function $(d){var F=d.state,O=F.pending;O>d.avail_out&&(O=d.avail_out),O!==0&&(i.arraySet(d.output,F.pending_buf,F.pending_out,O,d.next_out),d.next_out+=O,F.pending_out+=O,d.total_out+=O,d.avail_out-=O,F.pending-=O,F.pending===0&&(F.pending_out=0))}function L(d,F){s._tr_flush_block(d,0<=d.block_start?d.block_start:-1,d.strstart-d.block_start,F),d.block_start=d.strstart,$(d.strm)}function te(d,F){d.pending_buf[d.pending++]=F}function Y(d,F){d.pending_buf[d.pending++]=F>>>8&255,d.pending_buf[d.pending++]=255&F}function Z(d,F){var O,k,x=d.max_chain_length,C=d.strstart,H=d.prev_length,j=d.nice_match,T=d.strstart>d.w_size-ee?d.strstart-(d.w_size-ee):0,X=d.window,Q=d.w_mask,G=d.prev,ie=d.strstart+W,he=X[C+H-1],le=X[C+H];d.prev_length>=d.good_match&&(x>>=2),j>d.lookahead&&(j=d.lookahead);do if(X[(O=F)+H]===le&&X[O+H-1]===he&&X[O]===X[C]&&X[++O]===X[C+1]){C+=2,O++;do;while(X[++C]===X[++O]&&X[++C]===X[++O]&&X[++C]===X[++O]&&X[++C]===X[++O]&&X[++C]===X[++O]&&X[++C]===X[++O]&&X[++C]===X[++O]&&X[++C]===X[++O]&&C<ie);if(k=W-(ie-C),C=ie-W,H<k){if(d.match_start=F,j<=(H=k))break;he=X[C+H-1],le=X[C+H]}}while((F=G[F&Q])>T&&--x!=0);return H<=d.lookahead?H:d.lookahead}function ce(d){var F,O,k,x,C,H,j,T,X,Q,G=d.w_size;do{if(x=d.window_size-d.lookahead-d.strstart,d.strstart>=G+(G-ee)){for(i.arraySet(d.window,d.window,G,G,0),d.match_start-=G,d.strstart-=G,d.block_start-=G,F=O=d.hash_size;k=d.head[--F],d.head[F]=G<=k?k-G:0,--O;);for(F=O=G;k=d.prev[--F],d.prev[F]=G<=k?k-G:0,--O;);x+=G}if(d.strm.avail_in===0)break;if(H=d.strm,j=d.window,T=d.strstart+d.lookahead,X=x,Q=void 0,Q=H.avail_in,X<Q&&(Q=X),O=Q===0?0:(H.avail_in-=Q,i.arraySet(j,H.input,H.next_in,Q,T),H.state.wrap===1?H.adler=l(H.adler,j,Q,T):H.state.wrap===2&&(H.adler=u(H.adler,j,Q,T)),H.next_in+=Q,H.total_in+=Q,Q),d.lookahead+=O,d.lookahead+d.insert>=M)for(C=d.strstart-d.insert,d.ins_h=d.window[C],d.ins_h=(d.ins_h<<d.hash_shift^d.window[C+1])&d.hash_mask;d.insert&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[C+M-1])&d.hash_mask,d.prev[C&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=C,C++,d.insert--,!(d.lookahead+d.insert<M)););}while(d.lookahead<ee&&d.strm.avail_in!==0)}function ue(d,F){for(var O,k;;){if(d.lookahead<ee){if(ce(d),d.lookahead<ee&&F===g)return c;if(d.lookahead===0)break}if(O=0,d.lookahead>=M&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,O=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),O!==0&&d.strstart-O<=d.w_size-ee&&(d.match_length=Z(d,O)),d.match_length>=M)if(k=s._tr_tally(d,d.strstart-d.match_start,d.match_length-M),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=M){for(d.match_length--;d.strstart++,d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,O=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart,--d.match_length!=0;);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+1])&d.hash_mask;else k=s._tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(k&&(L(d,!1),d.strm.avail_out===0))return c}return d.insert=d.strstart<M-1?d.strstart:M-1,F===b?(L(d,!0),d.strm.avail_out===0?D:z):d.last_lit&&(L(d,!1),d.strm.avail_out===0)?c:S}function ae(d,F){for(var O,k,x;;){if(d.lookahead<ee){if(ce(d),d.lookahead<ee&&F===g)return c;if(d.lookahead===0)break}if(O=0,d.lookahead>=M&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,O=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=M-1,O!==0&&d.prev_length<d.max_lazy_match&&d.strstart-O<=d.w_size-ee&&(d.match_length=Z(d,O),d.match_length<=5&&(d.strategy===1||d.match_length===M&&4096<d.strstart-d.match_start)&&(d.match_length=M-1)),d.prev_length>=M&&d.match_length<=d.prev_length){for(x=d.strstart+d.lookahead-M,k=s._tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-M),d.lookahead-=d.prev_length-1,d.prev_length-=2;++d.strstart<=x&&(d.ins_h=(d.ins_h<<d.hash_shift^d.window[d.strstart+M-1])&d.hash_mask,O=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),--d.prev_length!=0;);if(d.match_available=0,d.match_length=M-1,d.strstart++,k&&(L(d,!1),d.strm.avail_out===0))return c}else if(d.match_available){if((k=s._tr_tally(d,0,d.window[d.strstart-1]))&&L(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return c}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(k=s._tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<M-1?d.strstart:M-1,F===b?(L(d,!0),d.strm.avail_out===0?D:z):d.last_lit&&(L(d,!1),d.strm.avail_out===0)?c:S}function se(d,F,O,k,x){this.good_length=d,this.max_lazy=F,this.nice_length=O,this.max_chain=k,this.func=x}function ge(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=E,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*A),this.dyn_dtree=new i.Buf16(2*(2*I+1)),this.bl_tree=new i.Buf16(2*(2*N+1)),q(this.dyn_ltree),q(this.dyn_dtree),q(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(U+1),this.heap=new i.Buf16(2*_+1),q(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*_+1),q(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function fe(d){var F;return d&&d.state?(d.total_in=d.total_out=0,d.data_type=y,(F=d.state).pending=0,F.pending_out=0,F.wrap<0&&(F.wrap=-F.wrap),F.status=F.wrap?B:R,d.adler=F.wrap===2?0:1,F.last_flush=g,s._tr_init(F),m):J(d,w)}function De(d){var F=fe(d);return F===m&&function(O){O.window_size=2*O.w_size,q(O.head),O.max_lazy_match=a[O.level].max_lazy,O.good_match=a[O.level].good_length,O.nice_match=a[O.level].nice_length,O.max_chain_length=a[O.level].max_chain,O.strstart=0,O.block_start=0,O.lookahead=0,O.insert=0,O.match_length=O.prev_length=M-1,O.match_available=0,O.ins_h=0}(d.state),F}function $e(d,F,O,k,x,C){if(!d)return w;var H=1;if(F===p&&(F=6),k<0?(H=0,k=-k):15<k&&(H=2,k-=16),x<1||f<x||O!==E||k<8||15<k||F<0||9<F||C<0||v<C)return J(d,w);k===8&&(k=9);var j=new ge;return(d.state=j).strm=d,j.wrap=H,j.gzhead=null,j.w_bits=k,j.w_size=1<<j.w_bits,j.w_mask=j.w_size-1,j.hash_bits=x+7,j.hash_size=1<<j.hash_bits,j.hash_mask=j.hash_size-1,j.hash_shift=~~((j.hash_bits+M-1)/M),j.window=new i.Buf8(2*j.w_size),j.head=new i.Buf16(j.hash_size),j.prev=new i.Buf16(j.w_size),j.lit_bufsize=1<<x+6,j.pending_buf_size=4*j.lit_bufsize,j.pending_buf=new i.Buf8(j.pending_buf_size),j.d_buf=1*j.lit_bufsize,j.l_buf=3*j.lit_bufsize,j.level=F,j.strategy=C,j.method=O,De(d)}a=[new se(0,0,0,0,function(d,F){var O=65535;for(O>d.pending_buf_size-5&&(O=d.pending_buf_size-5);;){if(d.lookahead<=1){if(ce(d),d.lookahead===0&&F===g)return c;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;var k=d.block_start+O;if((d.strstart===0||d.strstart>=k)&&(d.lookahead=d.strstart-k,d.strstart=k,L(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-ee&&(L(d,!1),d.strm.avail_out===0))return c}return d.insert=0,F===b?(L(d,!0),d.strm.avail_out===0?D:z):(d.strstart>d.block_start&&(L(d,!1),d.strm.avail_out),c)}),new se(4,4,8,4,ue),new se(4,5,16,8,ue),new se(4,6,32,32,ue),new se(4,4,16,16,ae),new se(8,16,32,32,ae),new se(8,16,128,128,ae),new se(8,32,128,256,ae),new se(32,128,258,1024,ae),new se(32,258,258,4096,ae)],o.deflateInit=function(d,F){return $e(d,F,E,15,8,0)},o.deflateInit2=$e,o.deflateReset=De,o.deflateResetKeep=fe,o.deflateSetHeader=function(d,F){return d&&d.state?d.state.wrap!==2?w:(d.state.gzhead=F,m):w},o.deflate=function(d,F){var O,k,x,C;if(!d||!d.state||5<F||F<0)return d?J(d,w):w;if(k=d.state,!d.output||!d.input&&d.avail_in!==0||k.status===666&&F!==b)return J(d,d.avail_out===0?-5:w);if(k.strm=d,O=k.last_flush,k.last_flush=F,k.status===B)if(k.wrap===2)d.adler=0,te(k,31),te(k,139),te(k,8),k.gzhead?(te(k,(k.gzhead.text?1:0)+(k.gzhead.hcrc?2:0)+(k.gzhead.extra?4:0)+(k.gzhead.name?8:0)+(k.gzhead.comment?16:0)),te(k,255&k.gzhead.time),te(k,k.gzhead.time>>8&255),te(k,k.gzhead.time>>16&255),te(k,k.gzhead.time>>24&255),te(k,k.level===9?2:2<=k.strategy||k.level<2?4:0),te(k,255&k.gzhead.os),k.gzhead.extra&&k.gzhead.extra.length&&(te(k,255&k.gzhead.extra.length),te(k,k.gzhead.extra.length>>8&255)),k.gzhead.hcrc&&(d.adler=u(d.adler,k.pending_buf,k.pending,0)),k.gzindex=0,k.status=69):(te(k,0),te(k,0),te(k,0),te(k,0),te(k,0),te(k,k.level===9?2:2<=k.strategy||k.level<2?4:0),te(k,3),k.status=R);else{var H=E+(k.w_bits-8<<4)<<8;H|=(2<=k.strategy||k.level<2?0:k.level<6?1:k.level===6?2:3)<<6,k.strstart!==0&&(H|=32),H+=31-H%31,k.status=R,Y(k,H),k.strstart!==0&&(Y(k,d.adler>>>16),Y(k,65535&d.adler)),d.adler=1}if(k.status===69)if(k.gzhead.extra){for(x=k.pending;k.gzindex<(65535&k.gzhead.extra.length)&&(k.pending!==k.pending_buf_size||(k.gzhead.hcrc&&k.pending>x&&(d.adler=u(d.adler,k.pending_buf,k.pending-x,x)),$(d),x=k.pending,k.pending!==k.pending_buf_size));)te(k,255&k.gzhead.extra[k.gzindex]),k.gzindex++;k.gzhead.hcrc&&k.pending>x&&(d.adler=u(d.adler,k.pending_buf,k.pending-x,x)),k.gzindex===k.gzhead.extra.length&&(k.gzindex=0,k.status=73)}else k.status=73;if(k.status===73)if(k.gzhead.name){x=k.pending;do{if(k.pending===k.pending_buf_size&&(k.gzhead.hcrc&&k.pending>x&&(d.adler=u(d.adler,k.pending_buf,k.pending-x,x)),$(d),x=k.pending,k.pending===k.pending_buf_size)){C=1;break}C=k.gzindex<k.gzhead.name.length?255&k.gzhead.name.charCodeAt(k.gzindex++):0,te(k,C)}while(C!==0);k.gzhead.hcrc&&k.pending>x&&(d.adler=u(d.adler,k.pending_buf,k.pending-x,x)),C===0&&(k.gzindex=0,k.status=91)}else k.status=91;if(k.status===91)if(k.gzhead.comment){x=k.pending;do{if(k.pending===k.pending_buf_size&&(k.gzhead.hcrc&&k.pending>x&&(d.adler=u(d.adler,k.pending_buf,k.pending-x,x)),$(d),x=k.pending,k.pending===k.pending_buf_size)){C=1;break}C=k.gzindex<k.gzhead.comment.length?255&k.gzhead.comment.charCodeAt(k.gzindex++):0,te(k,C)}while(C!==0);k.gzhead.hcrc&&k.pending>x&&(d.adler=u(d.adler,k.pending_buf,k.pending-x,x)),C===0&&(k.status=103)}else k.status=103;if(k.status===103&&(k.gzhead.hcrc?(k.pending+2>k.pending_buf_size&&$(d),k.pending+2<=k.pending_buf_size&&(te(k,255&d.adler),te(k,d.adler>>8&255),d.adler=0,k.status=R)):k.status=R),k.pending!==0){if($(d),d.avail_out===0)return k.last_flush=-1,m}else if(d.avail_in===0&&P(F)<=P(O)&&F!==b)return J(d,-5);if(k.status===666&&d.avail_in!==0)return J(d,-5);if(d.avail_in!==0||k.lookahead!==0||F!==g&&k.status!==666){var j=k.strategy===2?function(T,X){for(var Q;;){if(T.lookahead===0&&(ce(T),T.lookahead===0)){if(X===g)return c;break}if(T.match_length=0,Q=s._tr_tally(T,0,T.window[T.strstart]),T.lookahead--,T.strstart++,Q&&(L(T,!1),T.strm.avail_out===0))return c}return T.insert=0,X===b?(L(T,!0),T.strm.avail_out===0?D:z):T.last_lit&&(L(T,!1),T.strm.avail_out===0)?c:S}(k,F):k.strategy===3?function(T,X){for(var Q,G,ie,he,le=T.window;;){if(T.lookahead<=W){if(ce(T),T.lookahead<=W&&X===g)return c;if(T.lookahead===0)break}if(T.match_length=0,T.lookahead>=M&&0<T.strstart&&(G=le[ie=T.strstart-1])===le[++ie]&&G===le[++ie]&&G===le[++ie]){he=T.strstart+W;do;while(G===le[++ie]&&G===le[++ie]&&G===le[++ie]&&G===le[++ie]&&G===le[++ie]&&G===le[++ie]&&G===le[++ie]&&G===le[++ie]&&ie<he);T.match_length=W-(he-ie),T.match_length>T.lookahead&&(T.match_length=T.lookahead)}if(T.match_length>=M?(Q=s._tr_tally(T,1,T.match_length-M),T.lookahead-=T.match_length,T.strstart+=T.match_length,T.match_length=0):(Q=s._tr_tally(T,0,T.window[T.strstart]),T.lookahead--,T.strstart++),Q&&(L(T,!1),T.strm.avail_out===0))return c}return T.insert=0,X===b?(L(T,!0),T.strm.avail_out===0?D:z):T.last_lit&&(L(T,!1),T.strm.avail_out===0)?c:S}(k,F):a[k.level].func(k,F);if(j!==D&&j!==z||(k.status=666),j===c||j===D)return d.avail_out===0&&(k.last_flush=-1),m;if(j===S&&(F===1?s._tr_align(k):F!==5&&(s._tr_stored_block(k,0,0,!1),F===3&&(q(k.head),k.lookahead===0&&(k.strstart=0,k.block_start=0,k.insert=0))),$(d),d.avail_out===0))return k.last_flush=-1,m}return F!==b?m:k.wrap<=0?1:(k.wrap===2?(te(k,255&d.adler),te(k,d.adler>>8&255),te(k,d.adler>>16&255),te(k,d.adler>>24&255),te(k,255&d.total_in),te(k,d.total_in>>8&255),te(k,d.total_in>>16&255),te(k,d.total_in>>24&255)):(Y(k,d.adler>>>16),Y(k,65535&d.adler)),$(d),0<k.wrap&&(k.wrap=-k.wrap),k.pending!==0?m:1)},o.deflateEnd=function(d){var F;return d&&d.state?(F=d.state.status)!==B&&F!==69&&F!==73&&F!==91&&F!==103&&F!==R&&F!==666?J(d,w):(d.state=null,F===R?J(d,-3):m):w},o.deflateSetDictionary=function(d,F){var O,k,x,C,H,j,T,X,Q=F.length;if(!d||!d.state||(C=(O=d.state).wrap)===2||C===1&&O.status!==B||O.lookahead)return w;for(C===1&&(d.adler=l(d.adler,F,Q,0)),O.wrap=0,Q>=O.w_size&&(C===0&&(q(O.head),O.strstart=0,O.block_start=0,O.insert=0),X=new i.Buf8(O.w_size),i.arraySet(X,F,Q-O.w_size,O.w_size,0),F=X,Q=O.w_size),H=d.avail_in,j=d.next_in,T=d.input,d.avail_in=Q,d.next_in=0,d.input=F,ce(O);O.lookahead>=M;){for(k=O.strstart,x=O.lookahead-(M-1);O.ins_h=(O.ins_h<<O.hash_shift^O.window[k+M-1])&O.hash_mask,O.prev[k&O.w_mask]=O.head[O.ins_h],O.head[O.ins_h]=k,k++,--x;);O.strstart=k,O.lookahead=M-1,ce(O)}return O.strstart+=O.lookahead,O.block_start=O.strstart,O.insert=O.lookahead,O.lookahead=0,O.match_length=O.prev_length=M-1,O.match_available=0,d.next_in=j,d.input=T,d.avail_in=H,O.wrap=C,m},o.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(n,r,o){r.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(n,r,o){r.exports=function(a,i){var s,l,u,h,g,b,m,w,p,v,y,E,f,_,I,N,A,U,M,W,ee,B,R,c,S;s=a.state,l=a.next_in,c=a.input,u=l+(a.avail_in-5),h=a.next_out,S=a.output,g=h-(i-a.avail_out),b=h+(a.avail_out-257),m=s.dmax,w=s.wsize,p=s.whave,v=s.wnext,y=s.window,E=s.hold,f=s.bits,_=s.lencode,I=s.distcode,N=(1<<s.lenbits)-1,A=(1<<s.distbits)-1;e:do{f<15&&(E+=c[l++]<<f,f+=8,E+=c[l++]<<f,f+=8),U=_[E&N];t:for(;;){if(E>>>=M=U>>>24,f-=M,(M=U>>>16&255)===0)S[h++]=65535&U;else{if(!(16&M)){if(!(64&M)){U=_[(65535&U)+(E&(1<<M)-1)];continue t}if(32&M){s.mode=12;break e}a.msg="invalid literal/length code",s.mode=30;break e}W=65535&U,(M&=15)&&(f<M&&(E+=c[l++]<<f,f+=8),W+=E&(1<<M)-1,E>>>=M,f-=M),f<15&&(E+=c[l++]<<f,f+=8,E+=c[l++]<<f,f+=8),U=I[E&A];n:for(;;){if(E>>>=M=U>>>24,f-=M,!(16&(M=U>>>16&255))){if(!(64&M)){U=I[(65535&U)+(E&(1<<M)-1)];continue n}a.msg="invalid distance code",s.mode=30;break e}if(ee=65535&U,f<(M&=15)&&(E+=c[l++]<<f,(f+=8)<M&&(E+=c[l++]<<f,f+=8)),m<(ee+=E&(1<<M)-1)){a.msg="invalid distance too far back",s.mode=30;break e}if(E>>>=M,f-=M,(M=h-g)<ee){if(p<(M=ee-M)&&s.sane){a.msg="invalid distance too far back",s.mode=30;break e}if(R=y,(B=0)===v){if(B+=w-M,M<W){for(W-=M;S[h++]=y[B++],--M;);B=h-ee,R=S}}else if(v<M){if(B+=w+v-M,(M-=v)<W){for(W-=M;S[h++]=y[B++],--M;);if(B=0,v<W){for(W-=M=v;S[h++]=y[B++],--M;);B=h-ee,R=S}}}else if(B+=v-M,M<W){for(W-=M;S[h++]=y[B++],--M;);B=h-ee,R=S}for(;2<W;)S[h++]=R[B++],S[h++]=R[B++],S[h++]=R[B++],W-=3;W&&(S[h++]=R[B++],1<W&&(S[h++]=R[B++]))}else{for(B=h-ee;S[h++]=S[B++],S[h++]=S[B++],S[h++]=S[B++],2<(W-=3););W&&(S[h++]=S[B++],1<W&&(S[h++]=S[B++]))}break}}break}}while(l<u&&h<b);l-=W=f>>3,E&=(1<<(f-=W<<3))-1,a.next_in=l,a.next_out=h,a.avail_in=l<u?u-l+5:5-(l-u),a.avail_out=h<b?b-h+257:257-(h-b),s.hold=E,s.bits=f}},{}],49:[function(n,r,o){var a=n("../utils/common"),i=n("./adler32"),s=n("./crc32"),l=n("./inffast"),u=n("./inftrees"),h=1,g=2,b=0,m=-2,w=1,p=852,v=592;function y(B){return(B>>>24&255)+(B>>>8&65280)+((65280&B)<<8)+((255&B)<<24)}function E(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function f(B){var R;return B&&B.state?(R=B.state,B.total_in=B.total_out=R.total=0,B.msg="",R.wrap&&(B.adler=1&R.wrap),R.mode=w,R.last=0,R.havedict=0,R.dmax=32768,R.head=null,R.hold=0,R.bits=0,R.lencode=R.lendyn=new a.Buf32(p),R.distcode=R.distdyn=new a.Buf32(v),R.sane=1,R.back=-1,b):m}function _(B){var R;return B&&B.state?((R=B.state).wsize=0,R.whave=0,R.wnext=0,f(B)):m}function I(B,R){var c,S;return B&&B.state?(S=B.state,R<0?(c=0,R=-R):(c=1+(R>>4),R<48&&(R&=15)),R&&(R<8||15<R)?m:(S.window!==null&&S.wbits!==R&&(S.window=null),S.wrap=c,S.wbits=R,_(B))):m}function N(B,R){var c,S;return B?(S=new E,(B.state=S).window=null,(c=I(B,R))!==b&&(B.state=null),c):m}var A,U,M=!0;function W(B){if(M){var R;for(A=new a.Buf32(512),U=new a.Buf32(32),R=0;R<144;)B.lens[R++]=8;for(;R<256;)B.lens[R++]=9;for(;R<280;)B.lens[R++]=7;for(;R<288;)B.lens[R++]=8;for(u(h,B.lens,0,288,A,0,B.work,{bits:9}),R=0;R<32;)B.lens[R++]=5;u(g,B.lens,0,32,U,0,B.work,{bits:5}),M=!1}B.lencode=A,B.lenbits=9,B.distcode=U,B.distbits=5}function ee(B,R,c,S){var D,z=B.state;return z.window===null&&(z.wsize=1<<z.wbits,z.wnext=0,z.whave=0,z.window=new a.Buf8(z.wsize)),S>=z.wsize?(a.arraySet(z.window,R,c-z.wsize,z.wsize,0),z.wnext=0,z.whave=z.wsize):(S<(D=z.wsize-z.wnext)&&(D=S),a.arraySet(z.window,R,c-S,D,z.wnext),(S-=D)?(a.arraySet(z.window,R,c-S,S,0),z.wnext=S,z.whave=z.wsize):(z.wnext+=D,z.wnext===z.wsize&&(z.wnext=0),z.whave<z.wsize&&(z.whave+=D))),0}o.inflateReset=_,o.inflateReset2=I,o.inflateResetKeep=f,o.inflateInit=function(B){return N(B,15)},o.inflateInit2=N,o.inflate=function(B,R){var c,S,D,z,J,P,q,$,L,te,Y,Z,ce,ue,ae,se,ge,fe,De,$e,d,F,O,k,x=0,C=new a.Buf8(4),H=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!B||!B.state||!B.output||!B.input&&B.avail_in!==0)return m;(c=B.state).mode===12&&(c.mode=13),J=B.next_out,D=B.output,q=B.avail_out,z=B.next_in,S=B.input,P=B.avail_in,$=c.hold,L=c.bits,te=P,Y=q,F=b;e:for(;;)switch(c.mode){case w:if(c.wrap===0){c.mode=13;break}for(;L<16;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if(2&c.wrap&&$===35615){C[c.check=0]=255&$,C[1]=$>>>8&255,c.check=s(c.check,C,2,0),L=$=0,c.mode=2;break}if(c.flags=0,c.head&&(c.head.done=!1),!(1&c.wrap)||(((255&$)<<8)+($>>8))%31){B.msg="incorrect header check",c.mode=30;break}if((15&$)!=8){B.msg="unknown compression method",c.mode=30;break}if(L-=4,d=8+(15&($>>>=4)),c.wbits===0)c.wbits=d;else if(d>c.wbits){B.msg="invalid window size",c.mode=30;break}c.dmax=1<<d,B.adler=c.check=1,c.mode=512&$?10:12,L=$=0;break;case 2:for(;L<16;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if(c.flags=$,(255&c.flags)!=8){B.msg="unknown compression method",c.mode=30;break}if(57344&c.flags){B.msg="unknown header flags set",c.mode=30;break}c.head&&(c.head.text=$>>8&1),512&c.flags&&(C[0]=255&$,C[1]=$>>>8&255,c.check=s(c.check,C,2,0)),L=$=0,c.mode=3;case 3:for(;L<32;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}c.head&&(c.head.time=$),512&c.flags&&(C[0]=255&$,C[1]=$>>>8&255,C[2]=$>>>16&255,C[3]=$>>>24&255,c.check=s(c.check,C,4,0)),L=$=0,c.mode=4;case 4:for(;L<16;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}c.head&&(c.head.xflags=255&$,c.head.os=$>>8),512&c.flags&&(C[0]=255&$,C[1]=$>>>8&255,c.check=s(c.check,C,2,0)),L=$=0,c.mode=5;case 5:if(1024&c.flags){for(;L<16;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}c.length=$,c.head&&(c.head.extra_len=$),512&c.flags&&(C[0]=255&$,C[1]=$>>>8&255,c.check=s(c.check,C,2,0)),L=$=0}else c.head&&(c.head.extra=null);c.mode=6;case 6:if(1024&c.flags&&(P<(Z=c.length)&&(Z=P),Z&&(c.head&&(d=c.head.extra_len-c.length,c.head.extra||(c.head.extra=new Array(c.head.extra_len)),a.arraySet(c.head.extra,S,z,Z,d)),512&c.flags&&(c.check=s(c.check,S,Z,z)),P-=Z,z+=Z,c.length-=Z),c.length))break e;c.length=0,c.mode=7;case 7:if(2048&c.flags){if(P===0)break e;for(Z=0;d=S[z+Z++],c.head&&d&&c.length<65536&&(c.head.name+=String.fromCharCode(d)),d&&Z<P;);if(512&c.flags&&(c.check=s(c.check,S,Z,z)),P-=Z,z+=Z,d)break e}else c.head&&(c.head.name=null);c.length=0,c.mode=8;case 8:if(4096&c.flags){if(P===0)break e;for(Z=0;d=S[z+Z++],c.head&&d&&c.length<65536&&(c.head.comment+=String.fromCharCode(d)),d&&Z<P;);if(512&c.flags&&(c.check=s(c.check,S,Z,z)),P-=Z,z+=Z,d)break e}else c.head&&(c.head.comment=null);c.mode=9;case 9:if(512&c.flags){for(;L<16;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if($!==(65535&c.check)){B.msg="header crc mismatch",c.mode=30;break}L=$=0}c.head&&(c.head.hcrc=c.flags>>9&1,c.head.done=!0),B.adler=c.check=0,c.mode=12;break;case 10:for(;L<32;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}B.adler=c.check=y($),L=$=0,c.mode=11;case 11:if(c.havedict===0)return B.next_out=J,B.avail_out=q,B.next_in=z,B.avail_in=P,c.hold=$,c.bits=L,2;B.adler=c.check=1,c.mode=12;case 12:if(R===5||R===6)break e;case 13:if(c.last){$>>>=7&L,L-=7&L,c.mode=27;break}for(;L<3;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}switch(c.last=1&$,L-=1,3&($>>>=1)){case 0:c.mode=14;break;case 1:if(W(c),c.mode=20,R!==6)break;$>>>=2,L-=2;break e;case 2:c.mode=17;break;case 3:B.msg="invalid block type",c.mode=30}$>>>=2,L-=2;break;case 14:for($>>>=7&L,L-=7&L;L<32;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if((65535&$)!=($>>>16^65535)){B.msg="invalid stored block lengths",c.mode=30;break}if(c.length=65535&$,L=$=0,c.mode=15,R===6)break e;case 15:c.mode=16;case 16:if(Z=c.length){if(P<Z&&(Z=P),q<Z&&(Z=q),Z===0)break e;a.arraySet(D,S,z,Z,J),P-=Z,z+=Z,q-=Z,J+=Z,c.length-=Z;break}c.mode=12;break;case 17:for(;L<14;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if(c.nlen=257+(31&$),$>>>=5,L-=5,c.ndist=1+(31&$),$>>>=5,L-=5,c.ncode=4+(15&$),$>>>=4,L-=4,286<c.nlen||30<c.ndist){B.msg="too many length or distance symbols",c.mode=30;break}c.have=0,c.mode=18;case 18:for(;c.have<c.ncode;){for(;L<3;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}c.lens[H[c.have++]]=7&$,$>>>=3,L-=3}for(;c.have<19;)c.lens[H[c.have++]]=0;if(c.lencode=c.lendyn,c.lenbits=7,O={bits:c.lenbits},F=u(0,c.lens,0,19,c.lencode,0,c.work,O),c.lenbits=O.bits,F){B.msg="invalid code lengths set",c.mode=30;break}c.have=0,c.mode=19;case 19:for(;c.have<c.nlen+c.ndist;){for(;se=(x=c.lencode[$&(1<<c.lenbits)-1])>>>16&255,ge=65535&x,!((ae=x>>>24)<=L);){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if(ge<16)$>>>=ae,L-=ae,c.lens[c.have++]=ge;else{if(ge===16){for(k=ae+2;L<k;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if($>>>=ae,L-=ae,c.have===0){B.msg="invalid bit length repeat",c.mode=30;break}d=c.lens[c.have-1],Z=3+(3&$),$>>>=2,L-=2}else if(ge===17){for(k=ae+3;L<k;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}L-=ae,d=0,Z=3+(7&($>>>=ae)),$>>>=3,L-=3}else{for(k=ae+7;L<k;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}L-=ae,d=0,Z=11+(127&($>>>=ae)),$>>>=7,L-=7}if(c.have+Z>c.nlen+c.ndist){B.msg="invalid bit length repeat",c.mode=30;break}for(;Z--;)c.lens[c.have++]=d}}if(c.mode===30)break;if(c.lens[256]===0){B.msg="invalid code -- missing end-of-block",c.mode=30;break}if(c.lenbits=9,O={bits:c.lenbits},F=u(h,c.lens,0,c.nlen,c.lencode,0,c.work,O),c.lenbits=O.bits,F){B.msg="invalid literal/lengths set",c.mode=30;break}if(c.distbits=6,c.distcode=c.distdyn,O={bits:c.distbits},F=u(g,c.lens,c.nlen,c.ndist,c.distcode,0,c.work,O),c.distbits=O.bits,F){B.msg="invalid distances set",c.mode=30;break}if(c.mode=20,R===6)break e;case 20:c.mode=21;case 21:if(6<=P&&258<=q){B.next_out=J,B.avail_out=q,B.next_in=z,B.avail_in=P,c.hold=$,c.bits=L,l(B,Y),J=B.next_out,D=B.output,q=B.avail_out,z=B.next_in,S=B.input,P=B.avail_in,$=c.hold,L=c.bits,c.mode===12&&(c.back=-1);break}for(c.back=0;se=(x=c.lencode[$&(1<<c.lenbits)-1])>>>16&255,ge=65535&x,!((ae=x>>>24)<=L);){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if(se&&!(240&se)){for(fe=ae,De=se,$e=ge;se=(x=c.lencode[$e+(($&(1<<fe+De)-1)>>fe)])>>>16&255,ge=65535&x,!(fe+(ae=x>>>24)<=L);){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}$>>>=fe,L-=fe,c.back+=fe}if($>>>=ae,L-=ae,c.back+=ae,c.length=ge,se===0){c.mode=26;break}if(32&se){c.back=-1,c.mode=12;break}if(64&se){B.msg="invalid literal/length code",c.mode=30;break}c.extra=15&se,c.mode=22;case 22:if(c.extra){for(k=c.extra;L<k;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}c.length+=$&(1<<c.extra)-1,$>>>=c.extra,L-=c.extra,c.back+=c.extra}c.was=c.length,c.mode=23;case 23:for(;se=(x=c.distcode[$&(1<<c.distbits)-1])>>>16&255,ge=65535&x,!((ae=x>>>24)<=L);){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if(!(240&se)){for(fe=ae,De=se,$e=ge;se=(x=c.distcode[$e+(($&(1<<fe+De)-1)>>fe)])>>>16&255,ge=65535&x,!(fe+(ae=x>>>24)<=L);){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}$>>>=fe,L-=fe,c.back+=fe}if($>>>=ae,L-=ae,c.back+=ae,64&se){B.msg="invalid distance code",c.mode=30;break}c.offset=ge,c.extra=15&se,c.mode=24;case 24:if(c.extra){for(k=c.extra;L<k;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}c.offset+=$&(1<<c.extra)-1,$>>>=c.extra,L-=c.extra,c.back+=c.extra}if(c.offset>c.dmax){B.msg="invalid distance too far back",c.mode=30;break}c.mode=25;case 25:if(q===0)break e;if(Z=Y-q,c.offset>Z){if((Z=c.offset-Z)>c.whave&&c.sane){B.msg="invalid distance too far back",c.mode=30;break}ce=Z>c.wnext?(Z-=c.wnext,c.wsize-Z):c.wnext-Z,Z>c.length&&(Z=c.length),ue=c.window}else ue=D,ce=J-c.offset,Z=c.length;for(q<Z&&(Z=q),q-=Z,c.length-=Z;D[J++]=ue[ce++],--Z;);c.length===0&&(c.mode=21);break;case 26:if(q===0)break e;D[J++]=c.length,q--,c.mode=21;break;case 27:if(c.wrap){for(;L<32;){if(P===0)break e;P--,$|=S[z++]<<L,L+=8}if(Y-=q,B.total_out+=Y,c.total+=Y,Y&&(B.adler=c.check=c.flags?s(c.check,D,Y,J-Y):i(c.check,D,Y,J-Y)),Y=q,(c.flags?$:y($))!==c.check){B.msg="incorrect data check",c.mode=30;break}L=$=0}c.mode=28;case 28:if(c.wrap&&c.flags){for(;L<32;){if(P===0)break e;P--,$+=S[z++]<<L,L+=8}if($!==(4294967295&c.total)){B.msg="incorrect length check",c.mode=30;break}L=$=0}c.mode=29;case 29:F=1;break e;case 30:F=-3;break e;case 31:return-4;case 32:default:return m}return B.next_out=J,B.avail_out=q,B.next_in=z,B.avail_in=P,c.hold=$,c.bits=L,(c.wsize||Y!==B.avail_out&&c.mode<30&&(c.mode<27||R!==4))&&ee(B,B.output,B.next_out,Y-B.avail_out)?(c.mode=31,-4):(te-=B.avail_in,Y-=B.avail_out,B.total_in+=te,B.total_out+=Y,c.total+=Y,c.wrap&&Y&&(B.adler=c.check=c.flags?s(c.check,D,Y,B.next_out-Y):i(c.check,D,Y,B.next_out-Y)),B.data_type=c.bits+(c.last?64:0)+(c.mode===12?128:0)+(c.mode===20||c.mode===15?256:0),(te==0&&Y===0||R===4)&&F===b&&(F=-5),F)},o.inflateEnd=function(B){if(!B||!B.state)return m;var R=B.state;return R.window&&(R.window=null),B.state=null,b},o.inflateGetHeader=function(B,R){var c;return B&&B.state&&2&(c=B.state).wrap?((c.head=R).done=!1,b):m},o.inflateSetDictionary=function(B,R){var c,S=R.length;return B&&B.state?(c=B.state).wrap!==0&&c.mode!==11?m:c.mode===11&&i(1,R,S,0)!==c.check?-3:ee(B,R,S,S)?(c.mode=31,-4):(c.havedict=1,b):m},o.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(n,r,o){var a=n("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],u=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];r.exports=function(h,g,b,m,w,p,v,y){var E,f,_,I,N,A,U,M,W,ee=y.bits,B=0,R=0,c=0,S=0,D=0,z=0,J=0,P=0,q=0,$=0,L=null,te=0,Y=new a.Buf16(16),Z=new a.Buf16(16),ce=null,ue=0;for(B=0;B<=15;B++)Y[B]=0;for(R=0;R<m;R++)Y[g[b+R]]++;for(D=ee,S=15;1<=S&&Y[S]===0;S--);if(S<D&&(D=S),S===0)return w[p++]=20971520,w[p++]=20971520,y.bits=1,0;for(c=1;c<S&&Y[c]===0;c++);for(D<c&&(D=c),B=P=1;B<=15;B++)if(P<<=1,(P-=Y[B])<0)return-1;if(0<P&&(h===0||S!==1))return-1;for(Z[1]=0,B=1;B<15;B++)Z[B+1]=Z[B]+Y[B];for(R=0;R<m;R++)g[b+R]!==0&&(v[Z[g[b+R]]++]=R);if(A=h===0?(L=ce=v,19):h===1?(L=i,te-=257,ce=s,ue-=257,256):(L=l,ce=u,-1),B=c,N=p,J=R=$=0,_=-1,I=(q=1<<(z=D))-1,h===1&&852<q||h===2&&592<q)return 1;for(;;){for(U=B-J,W=v[R]<A?(M=0,v[R]):v[R]>A?(M=ce[ue+v[R]],L[te+v[R]]):(M=96,0),E=1<<B-J,c=f=1<<z;w[N+($>>J)+(f-=E)]=U<<24|M<<16|W|0,f!==0;);for(E=1<<B-1;$&E;)E>>=1;if(E!==0?($&=E-1,$+=E):$=0,R++,--Y[B]==0){if(B===S)break;B=g[b+v[R]]}if(D<B&&($&I)!==_){for(J===0&&(J=D),N+=c,P=1<<(z=B-J);z+J<S&&!((P-=Y[z+J])<=0);)z++,P<<=1;if(q+=1<<z,h===1&&852<q||h===2&&592<q)return 1;w[_=$&I]=D<<24|z<<16|N-p|0}}return $!==0&&(w[N+$]=B-J<<24|64<<16|0),y.bits=D,0}},{"../utils/common":41}],51:[function(n,r,o){r.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(n,r,o){var a=n("../utils/common"),i=0,s=1;function l(x){for(var C=x.length;0<=--C;)x[C]=0}var u=0,h=29,g=256,b=g+1+h,m=30,w=19,p=2*b+1,v=15,y=16,E=7,f=256,_=16,I=17,N=18,A=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],U=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ee=new Array(2*(b+2));l(ee);var B=new Array(2*m);l(B);var R=new Array(512);l(R);var c=new Array(256);l(c);var S=new Array(h);l(S);var D,z,J,P=new Array(m);function q(x,C,H,j,T){this.static_tree=x,this.extra_bits=C,this.extra_base=H,this.elems=j,this.max_length=T,this.has_stree=x&&x.length}function $(x,C){this.dyn_tree=x,this.max_code=0,this.stat_desc=C}function L(x){return x<256?R[x]:R[256+(x>>>7)]}function te(x,C){x.pending_buf[x.pending++]=255&C,x.pending_buf[x.pending++]=C>>>8&255}function Y(x,C,H){x.bi_valid>y-H?(x.bi_buf|=C<<x.bi_valid&65535,te(x,x.bi_buf),x.bi_buf=C>>y-x.bi_valid,x.bi_valid+=H-y):(x.bi_buf|=C<<x.bi_valid&65535,x.bi_valid+=H)}function Z(x,C,H){Y(x,H[2*C],H[2*C+1])}function ce(x,C){for(var H=0;H|=1&x,x>>>=1,H<<=1,0<--C;);return H>>>1}function ue(x,C,H){var j,T,X=new Array(v+1),Q=0;for(j=1;j<=v;j++)X[j]=Q=Q+H[j-1]<<1;for(T=0;T<=C;T++){var G=x[2*T+1];G!==0&&(x[2*T]=ce(X[G]++,G))}}function ae(x){var C;for(C=0;C<b;C++)x.dyn_ltree[2*C]=0;for(C=0;C<m;C++)x.dyn_dtree[2*C]=0;for(C=0;C<w;C++)x.bl_tree[2*C]=0;x.dyn_ltree[2*f]=1,x.opt_len=x.static_len=0,x.last_lit=x.matches=0}function se(x){8<x.bi_valid?te(x,x.bi_buf):0<x.bi_valid&&(x.pending_buf[x.pending++]=x.bi_buf),x.bi_buf=0,x.bi_valid=0}function ge(x,C,H,j){var T=2*C,X=2*H;return x[T]<x[X]||x[T]===x[X]&&j[C]<=j[H]}function fe(x,C,H){for(var j=x.heap[H],T=H<<1;T<=x.heap_len&&(T<x.heap_len&&ge(C,x.heap[T+1],x.heap[T],x.depth)&&T++,!ge(C,j,x.heap[T],x.depth));)x.heap[H]=x.heap[T],H=T,T<<=1;x.heap[H]=j}function De(x,C,H){var j,T,X,Q,G=0;if(x.last_lit!==0)for(;j=x.pending_buf[x.d_buf+2*G]<<8|x.pending_buf[x.d_buf+2*G+1],T=x.pending_buf[x.l_buf+G],G++,j===0?Z(x,T,C):(Z(x,(X=c[T])+g+1,C),(Q=A[X])!==0&&Y(x,T-=S[X],Q),Z(x,X=L(--j),H),(Q=U[X])!==0&&Y(x,j-=P[X],Q)),G<x.last_lit;);Z(x,f,C)}function $e(x,C){var H,j,T,X=C.dyn_tree,Q=C.stat_desc.static_tree,G=C.stat_desc.has_stree,ie=C.stat_desc.elems,he=-1;for(x.heap_len=0,x.heap_max=p,H=0;H<ie;H++)X[2*H]!==0?(x.heap[++x.heap_len]=he=H,x.depth[H]=0):X[2*H+1]=0;for(;x.heap_len<2;)X[2*(T=x.heap[++x.heap_len]=he<2?++he:0)]=1,x.depth[T]=0,x.opt_len--,G&&(x.static_len-=Q[2*T+1]);for(C.max_code=he,H=x.heap_len>>1;1<=H;H--)fe(x,X,H);for(T=ie;H=x.heap[1],x.heap[1]=x.heap[x.heap_len--],fe(x,X,1),j=x.heap[1],x.heap[--x.heap_max]=H,x.heap[--x.heap_max]=j,X[2*T]=X[2*H]+X[2*j],x.depth[T]=(x.depth[H]>=x.depth[j]?x.depth[H]:x.depth[j])+1,X[2*H+1]=X[2*j+1]=T,x.heap[1]=T++,fe(x,X,1),2<=x.heap_len;);x.heap[--x.heap_max]=x.heap[1],function(le,Se){var bt,Oe,vt,me,Ht,zn,We=Se.dyn_tree,hr=Se.max_code,Ni=Se.stat_desc.static_tree,Mi=Se.stat_desc.has_stree,Di=Se.stat_desc.extra_bits,fr=Se.stat_desc.extra_base,wt=Se.stat_desc.max_length,jt=0;for(me=0;me<=v;me++)le.bl_count[me]=0;for(We[2*le.heap[le.heap_max]+1]=0,bt=le.heap_max+1;bt<p;bt++)wt<(me=We[2*We[2*(Oe=le.heap[bt])+1]+1]+1)&&(me=wt,jt++),We[2*Oe+1]=me,hr<Oe||(le.bl_count[me]++,Ht=0,fr<=Oe&&(Ht=Di[Oe-fr]),zn=We[2*Oe],le.opt_len+=zn*(me+Ht),Mi&&(le.static_len+=zn*(Ni[2*Oe+1]+Ht)));if(jt!==0){do{for(me=wt-1;le.bl_count[me]===0;)me--;le.bl_count[me]--,le.bl_count[me+1]+=2,le.bl_count[wt]--,jt-=2}while(0<jt);for(me=wt;me!==0;me--)for(Oe=le.bl_count[me];Oe!==0;)hr<(vt=le.heap[--bt])||(We[2*vt+1]!==me&&(le.opt_len+=(me-We[2*vt+1])*We[2*vt],We[2*vt+1]=me),Oe--)}}(x,C),ue(X,he,x.bl_count)}function d(x,C,H){var j,T,X=-1,Q=C[1],G=0,ie=7,he=4;for(Q===0&&(ie=138,he=3),C[2*(H+1)+1]=65535,j=0;j<=H;j++)T=Q,Q=C[2*(j+1)+1],++G<ie&&T===Q||(G<he?x.bl_tree[2*T]+=G:T!==0?(T!==X&&x.bl_tree[2*T]++,x.bl_tree[2*_]++):G<=10?x.bl_tree[2*I]++:x.bl_tree[2*N]++,X=T,he=(G=0)===Q?(ie=138,3):T===Q?(ie=6,3):(ie=7,4))}function F(x,C,H){var j,T,X=-1,Q=C[1],G=0,ie=7,he=4;for(Q===0&&(ie=138,he=3),j=0;j<=H;j++)if(T=Q,Q=C[2*(j+1)+1],!(++G<ie&&T===Q)){if(G<he)for(;Z(x,T,x.bl_tree),--G!=0;);else T!==0?(T!==X&&(Z(x,T,x.bl_tree),G--),Z(x,_,x.bl_tree),Y(x,G-3,2)):G<=10?(Z(x,I,x.bl_tree),Y(x,G-3,3)):(Z(x,N,x.bl_tree),Y(x,G-11,7));X=T,he=(G=0)===Q?(ie=138,3):T===Q?(ie=6,3):(ie=7,4)}}l(P);var O=!1;function k(x,C,H,j){Y(x,(u<<1)+(j?1:0),3),function(T,X,Q,G){se(T),te(T,Q),te(T,~Q),a.arraySet(T.pending_buf,T.window,X,Q,T.pending),T.pending+=Q}(x,C,H)}o._tr_init=function(x){O||(function(){var C,H,j,T,X,Q=new Array(v+1);for(T=j=0;T<h-1;T++)for(S[T]=j,C=0;C<1<<A[T];C++)c[j++]=T;for(c[j-1]=T,T=X=0;T<16;T++)for(P[T]=X,C=0;C<1<<U[T];C++)R[X++]=T;for(X>>=7;T<m;T++)for(P[T]=X<<7,C=0;C<1<<U[T]-7;C++)R[256+X++]=T;for(H=0;H<=v;H++)Q[H]=0;for(C=0;C<=143;)ee[2*C+1]=8,C++,Q[8]++;for(;C<=255;)ee[2*C+1]=9,C++,Q[9]++;for(;C<=279;)ee[2*C+1]=7,C++,Q[7]++;for(;C<=287;)ee[2*C+1]=8,C++,Q[8]++;for(ue(ee,b+1,Q),C=0;C<m;C++)B[2*C+1]=5,B[2*C]=ce(C,5);D=new q(ee,A,g+1,b,v),z=new q(B,U,0,m,v),J=new q(new Array(0),M,0,w,E)}(),O=!0),x.l_desc=new $(x.dyn_ltree,D),x.d_desc=new $(x.dyn_dtree,z),x.bl_desc=new $(x.bl_tree,J),x.bi_buf=0,x.bi_valid=0,ae(x)},o._tr_stored_block=k,o._tr_flush_block=function(x,C,H,j){var T,X,Q=0;0<x.level?(x.strm.data_type===2&&(x.strm.data_type=function(G){var ie,he=4093624447;for(ie=0;ie<=31;ie++,he>>>=1)if(1&he&&G.dyn_ltree[2*ie]!==0)return i;if(G.dyn_ltree[18]!==0||G.dyn_ltree[20]!==0||G.dyn_ltree[26]!==0)return s;for(ie=32;ie<g;ie++)if(G.dyn_ltree[2*ie]!==0)return s;return i}(x)),$e(x,x.l_desc),$e(x,x.d_desc),Q=function(G){var ie;for(d(G,G.dyn_ltree,G.l_desc.max_code),d(G,G.dyn_dtree,G.d_desc.max_code),$e(G,G.bl_desc),ie=w-1;3<=ie&&G.bl_tree[2*W[ie]+1]===0;ie--);return G.opt_len+=3*(ie+1)+5+5+4,ie}(x),T=x.opt_len+3+7>>>3,(X=x.static_len+3+7>>>3)<=T&&(T=X)):T=X=H+5,H+4<=T&&C!==-1?k(x,C,H,j):x.strategy===4||X===T?(Y(x,2+(j?1:0),3),De(x,ee,B)):(Y(x,4+(j?1:0),3),function(G,ie,he,le){var Se;for(Y(G,ie-257,5),Y(G,he-1,5),Y(G,le-4,4),Se=0;Se<le;Se++)Y(G,G.bl_tree[2*W[Se]+1],3);F(G,G.dyn_ltree,ie-1),F(G,G.dyn_dtree,he-1)}(x,x.l_desc.max_code+1,x.d_desc.max_code+1,Q+1),De(x,x.dyn_ltree,x.dyn_dtree)),ae(x),j&&se(x)},o._tr_tally=function(x,C,H){return x.pending_buf[x.d_buf+2*x.last_lit]=C>>>8&255,x.pending_buf[x.d_buf+2*x.last_lit+1]=255&C,x.pending_buf[x.l_buf+x.last_lit]=255&H,x.last_lit++,C===0?x.dyn_ltree[2*H]++:(x.matches++,C--,x.dyn_ltree[2*(c[H]+g+1)]++,x.dyn_dtree[2*L(C)]++),x.last_lit===x.lit_bufsize-1},o._tr_align=function(x){Y(x,2,3),Z(x,f,ee),function(C){C.bi_valid===16?(te(C,C.bi_buf),C.bi_buf=0,C.bi_valid=0):8<=C.bi_valid&&(C.pending_buf[C.pending++]=255&C.bi_buf,C.bi_buf>>=8,C.bi_valid-=8)}(x)}},{"../utils/common":41}],53:[function(n,r,o){r.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(n,r,o){(function(a){(function(i,s){if(!i.setImmediate){var l,u,h,g,b=1,m={},w=!1,p=i.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(i);v=v&&v.setTimeout?v:i,l={}.toString.call(i.process)==="[object process]"?function(_){process.nextTick(function(){E(_)})}:function(){if(i.postMessage&&!i.importScripts){var _=!0,I=i.onmessage;return i.onmessage=function(){_=!1},i.postMessage("","*"),i.onmessage=I,_}}()?(g="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",f,!1):i.attachEvent("onmessage",f),function(_){i.postMessage(g+_,"*")}):i.MessageChannel?((h=new MessageChannel).port1.onmessage=function(_){E(_.data)},function(_){h.port2.postMessage(_)}):p&&"onreadystatechange"in p.createElement("script")?(u=p.documentElement,function(_){var I=p.createElement("script");I.onreadystatechange=function(){E(_),I.onreadystatechange=null,u.removeChild(I),I=null},u.appendChild(I)}):function(_){setTimeout(E,0,_)},v.setImmediate=function(_){typeof _!="function"&&(_=new Function(""+_));for(var I=new Array(arguments.length-1),N=0;N<I.length;N++)I[N]=arguments[N+1];var A={callback:_,args:I};return m[b]=A,l(b),b++},v.clearImmediate=y}function y(_){delete m[_]}function E(_){if(w)setTimeout(E,0,_);else{var I=m[_];if(I){w=!0;try{(function(N){var A=N.callback,U=N.args;switch(U.length){case 0:A();break;case 1:A(U[0]);break;case 2:A(U[0],U[1]);break;case 3:A(U[0],U[1],U[2]);break;default:A.apply(s,U)}})(I)}finally{y(_),w=!1}}}}function f(_){_.source===i&&typeof _.data=="string"&&_.data.indexOf(g)===0&&E(+_.data.slice(g.length))}})(typeof self>"u"?a===void 0?this:a:self)}).call(this,typeof Gt<"u"?Gt:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(gi);var yl=gi.exports;const yi=gl(yl);function _l(e){const t=new Set;return e.nodes.forEach(n=>{n.taxonomies&&n.taxonomies.forEach(r=>t.add(r.id))}),{version:"1.0",exported_at:new Date().toISOString(),bibmap:{title:e.title,description:e.description,is_published:e.is_published,settings_json:e.settings_json,created_at:e.created_at,updated_at:e.updated_at},nodes:e.nodes.map(n=>{var r;return{id:n.id,label:n.label,description:n.description,x:n.x,y:n.y,width:n.width,height:n.height,background_color:n.background_color,text_color:n.text_color,border_color:n.border_color,font_size:n.font_size,font_family:n.font_family,font_bold:n.font_bold,font_italic:n.font_italic,font_underline:n.font_underline,shape:n.shape,link_to_references:n.link_to_references,tag_names:((r=n.taxonomies)==null?void 0:r.map(o=>o.name))||[]}}),connections:e.connections.map(n=>({id:n.id,source_node_id:n.source_node_id,target_node_id:n.target_node_id,label:n.label,show_label:n.show_label,line_color:n.line_color,line_width:n.line_width,line_style:n.line_style,arrow_type:n.arrow_type})),tags:Array.from(t).map(n=>{const r=e.nodes.flatMap(o=>o.taxonomies||[]).find(o=>o.id===n);return r?{name:r.name,color:r.color,description:r.description}:null}).filter(Boolean)}}function bl(e,t){const n=new Set;return e.nodes.forEach(r=>{r.taxonomies&&r.taxonomies.forEach(o=>n.add(o.id))}),t.filter(r=>{var o;return(o=r.taxonomies)==null?void 0:o.some(a=>n.has(a.id))})}function vl(e){return!e||e.length===0?"% No references linked to this BibMap":e.map(t=>t.raw_bibtex).join(`

`)}function wl(e,t){const n=new Set;return e.nodes.forEach(r=>{r.taxonomies&&r.taxonomies.forEach(o=>n.add(o.id))}),{version:"1.0",exported_at:new Date().toISOString(),tags:Array.from(n).map(r=>{const o=e.nodes.flatMap(a=>a.taxonomies||[]).find(a=>a.id===r);return o?{name:o.name,color:o.color,description:o.description,reference_keys:t.filter(a=>{var i;return(i=a.taxonomies)==null?void 0:i.some(s=>s.id===r)}).map(a=>a.bibtex_key)}:null}).filter(Boolean)}}function xl(e){return`${e.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.bibmap`}let de=null,oe=null,Xe=null,ot=[],yn=null,ct=null,Te=null,Ie=null,Ye=null,Cn=[],St=[],yt=[],_i=[],Dt=[],_e=1,Qe=20,Xn="",El="",_n="imported-desc",or=[],Yn=[],Ot="",bi="created-desc",sr=[],Pt=[],be=1,mt=20,Gn="",kl="",vi="created-desc",dt=null,Rt=[],Fe=null,pe=null,it=!1,xe={};const Vt={bibmaps:document.getElementById("bibmaps-section"),editor:document.getElementById("editor-section"),references:document.getElementById("references-section"),media:document.getElementById("media-section"),taxonomies:document.getElementById("taxonomies-section"),nodeRefs:document.getElementById("node-refs-section"),settings:document.getElementById("settings-section"),admin:document.getElementById("admin-section"),about:document.getElementById("about-section")},Je={bibmaps:document.getElementById("nav-bibmaps"),references:document.getElementById("nav-references"),media:document.getElementById("nav-media"),taxonomies:document.getElementById("nav-taxonomies"),settings:document.getElementById("nav-settings"),admin:document.getElementById("nav-admin"),about:document.getElementById("nav-about")},zr=document.getElementById("announcer");function V(e){zr.textContent=e,setTimeout(()=>{zr.textContent=""},1e3)}function ve(e){Object.values(Vt).forEach(t=>{t.hidden=!0,t.classList.remove("active")}),Vt[e]&&(Vt[e].hidden=!1,Vt[e].classList.add("active")),Object.entries(Je).forEach(([t,n])=>{n.classList.toggle("active",t===e),n.setAttribute("aria-pressed",t===e)}),lr()}function Il(e){Xe=e,lr(),wi()}function Kt(){Xe=null,oe=null,lr(),wi(),V("BibMap closed")}function lr(){const e=document.getElementById("references-heading"),t=document.getElementById("media-heading"),n=document.getElementById("taxonomies-heading");Xe?(e.textContent=`Academic References for ${Xe.title}`,t.textContent=`Media Links for ${Xe.title}`,n.textContent=`Tags for ${Xe.title}`):(e.textContent="All Academic References",t.textContent="All Media Links",n.textContent="All Tags")}function wi(){document.querySelectorAll(".close-active-bibmap-btn").forEach(t=>{t.hidden=!1,Xe?(t.disabled=!1,t.innerHTML=`&times; Close ${Xe.title}`):(t.disabled=!0,t.innerHTML="&times; Close BibMap")})}function Be(e){var r;const t=document.getElementById("modal-overlay"),n=document.getElementById(e);t.hidden=!1,n.showModal(),(r=n.querySelector("input, textarea, button"))==null||r.focus()}function Ee(){const e=document.getElementById("modal-overlay");e.hidden=!0,document.querySelectorAll(".modal").forEach(t=>t.close()),Fe&&(Fe(!1),Fe=null)}const _t=Ee;function Ae(e,t="Confirm",n="Delete"){return new Promise(r=>{Fe=r,document.getElementById("confirm-title").textContent=t,document.getElementById("confirm-message").textContent=e,document.getElementById("confirm-yes").textContent=n,Be("confirm-modal")})}function cr(e){return new Date(e).toLocaleDateString()}async function Sn(){try{const e=await K.user();pe=e.authenticated?e:null,Jn()}catch(e){console.error("Failed to load user:",e),pe=null,Jn()}}function Jn(){const e=document.getElementById("user-info"),t=document.getElementById("auth-toggle-btn"),n=document.getElementById("register-btn"),r=document.getElementById("profile-btn"),o=document.getElementById("nav-admin"),a=document.getElementById("nav-settings");pe?(e.textContent=`Signed in as ${pe.user_name||pe.username||"User"}`,t.textContent="Logout",t.classList.remove("btn-secondary"),t.classList.add("btn-primary"),n.hidden=!0,r.hidden=!1,a.hidden=!1,pe.is_admin?o.hidden=!1:o.hidden=!0):(e.textContent="Not signed in (local mode)",t.textContent="Login",t.classList.remove("btn-primary"),t.classList.add("btn-secondary"),n.hidden=!0,r.hidden=!0,o.hidden=!0,a.hidden=!0)}let Qt=!1;async function Bl(){try{Qt=(await K.auth.googleEnabled()).enabled,document.getElementById("login-google-section").hidden=!Qt,document.getElementById("register-google-section").hidden=!Qt}catch{console.log("Google OAuth not available"),Qt=!1}}function Cl(){const e=new URLSearchParams(window.location.search),t=e.get("error");if(t){let n="Login failed";switch(t){case"google_oauth_error":n=e.get("message")||"Google authentication failed";break;case"invalid_state":n="Session expired. Please try again.";break;case"account_disabled":n="Your account has been disabled.";break;case"token_exchange_failed":n="Failed to verify with Google. Please try again.";break;default:n="Authentication failed. Please try again."}V(n),window.history.replaceState({},document.title,window.location.pathname)}}function Nr(){document.getElementById("login-error").hidden=!0,document.getElementById("login-form").reset(),Be("login-modal")}function Mr(){document.getElementById("register-error").hidden=!0,document.getElementById("register-form").reset(),Be("register-modal")}function Sl(){pe&&(document.getElementById("profile-error").hidden=!0,document.getElementById("password-error").hidden=!0,document.getElementById("profile-email").value=pe.email||"",document.getElementById("profile-display-name").value=pe.user_name||"",document.getElementById("profile-username").textContent=pe.username||"",document.getElementById("profile-role").textContent=pe.role==="admin"?"Administrator":"Standard User",document.getElementById("change-password-form").reset(),Be("profile-modal"))}async function Ll(e){e.preventDefault();const t=document.getElementById("login-username").value,n=document.getElementById("login-password").value,r=document.getElementById("login-error");try{await K.auth.login(t,n),_t(),await Sn(),await Ln(),await Ue(),await ze(),await et(),V("Logged in successfully")}catch(o){r.textContent=o.message,r.hidden=!1}}async function $l(e){e.preventDefault();const t=document.getElementById("register-email").value,n=document.getElementById("register-username").value,r=document.getElementById("register-display-name").value,o=document.getElementById("register-password").value,a=document.getElementById("register-confirm-password").value,i=document.getElementById("register-error");if(o!==a){i.textContent="Passwords do not match",i.hidden=!1;return}try{await K.auth.register({email:t,username:n,display_name:r||n,password:o}),await K.auth.login(n,o),_t(),await Sn(),await Ln(),await Ue(),await ze(),await et(),V("Account created and logged in")}catch(s){i.textContent=s.message,i.hidden=!1}}async function Al(){try{await K.auth.logout(),pe=null,Jn(),await Ue(),await ze(),await et(),ve("bibmaps"),V("Logged out successfully")}catch(e){V(`Logout failed: ${e.message}`)}}async function Tl(e){e.preventDefault();const t=document.getElementById("profile-email").value,n=document.getElementById("profile-display-name").value,r=document.getElementById("profile-error");try{await K.auth.updateProfile({email:t,display_name:n}),await Sn(),_t(),V("Profile updated")}catch(o){r.textContent=o.message,r.hidden=!1}}async function zl(e){e.preventDefault();const t=document.getElementById("current-password").value,n=document.getElementById("new-password").value,r=document.getElementById("confirm-new-password").value,o=document.getElementById("password-error");if(n!==r){o.textContent="New passwords do not match",o.hidden=!1;return}try{await K.auth.changePassword(t,n),document.getElementById("change-password-form").reset(),o.hidden=!0,V("Password changed successfully")}catch(a){o.textContent=a.message,o.hidden=!1}}let Lt=[],$t=null;async function bn(){var e;try{const t=((e=document.getElementById("user-search"))==null?void 0:e.value)||"";Lt=await K.auth.listUsers(0,100,t||null),Nl()}catch(t){V(`Error loading users: ${t.message}`)}}function Nl(){const e=document.getElementById("users-list");if(e){if(Lt.length===0){e.innerHTML='<p class="empty-message">No users found</p>';return}e.innerHTML=Lt.map(t=>`
    <div class="card user-card" role="listitem" data-user-id="${t.id}">
      <div class="card-header">
        <h3 class="card-title">${re(t.display_name||t.username)}</h3>
        <span class="badge ${t.role==="admin"?"badge-admin":"badge-user"}">${t.role}</span>
      </div>
      <p class="card-meta">@${re(t.username)}</p>
      <p class="card-meta">${re(t.email)}</p>
      <p class="card-meta ${t.is_active?"":"text-danger"}">${t.is_active?"Active":"Inactive"}</p>
      <div class="card-actions">
        <button class="btn-secondary btn-sm edit-user-btn">Edit</button>
        ${t.id!==(pe==null?void 0:pe.user_id)?'<button class="btn-danger btn-sm delete-user-btn">Delete</button>':""}
      </div>
    </div>
  `).join(""),e.querySelectorAll(".edit-user-btn").forEach(t=>{t.addEventListener("click",n=>{const r=n.target.closest(".user-card").dataset.userId;Dl(parseInt(r))})}),e.querySelectorAll(".delete-user-btn").forEach(t=>{t.addEventListener("click",async n=>{const r=n.target.closest(".user-card").dataset.userId,o=Lt.find(a=>a.id===parseInt(r));if(o&&await Ae(`Delete user "${o.username}"? This will also delete all their data.`))try{await K.auth.deleteUser(r),await bn(),V("User deleted")}catch(a){V(`Error deleting user: ${a.message}`)}})})}}function Ml(){$t=null,document.getElementById("user-modal-title").textContent="Create User",document.getElementById("user-submit-btn").textContent="Create",document.getElementById("user-form").reset(),document.getElementById("user-password").required=!0,document.getElementById("user-password-group").querySelector("label").textContent="Password:",document.getElementById("user-error").hidden=!0,document.getElementById("user-active").checked=!0,Be("user-modal")}function Dl(e){const t=Lt.find(n=>n.id===e);t&&($t=e,document.getElementById("user-modal-title").textContent="Edit User",document.getElementById("user-submit-btn").textContent="Save",document.getElementById("user-email").value=t.email,document.getElementById("user-username").value=t.username,document.getElementById("user-display-name").value=t.display_name||"",document.getElementById("user-password").value="",document.getElementById("user-password").required=!1,document.getElementById("user-password-group").querySelector("label").textContent="New Password (leave blank to keep):",document.getElementById("user-role").value=t.role,document.getElementById("user-active").checked=t.is_active,document.getElementById("user-error").hidden=!0,Be("user-modal"))}async function Ol(e){e.preventDefault();const t=document.getElementById("user-error"),n=document.getElementById("user-email").value,r=document.getElementById("user-username").value,o=document.getElementById("user-display-name").value,a=document.getElementById("user-password").value,i=document.getElementById("user-role").value,s=document.getElementById("user-active").checked;try{if($t){const l={email:n,username:r,display_name:o||r,role:i,is_active:s};await K.auth.updateUser($t,l),a&&await K.auth.resetPassword($t,a),V("User updated")}else await K.auth.createUser({email:n,username:r,display_name:o||r,password:a,role:i,is_active:s}),V("User created");_t(),await bn()}catch(l){t.textContent=l.message,t.hidden=!1}}let ye=null;async function Ln(){if(pe)try{ye=await K.settings.get(),dr(),xi()}catch(e){console.error("Failed to load settings:",e)}}function dr(){if(!ye)return;Pl(ye.theme),Qe=ye.default_refs_page_size||20,_n=ye.default_refs_sort||"imported-desc";const e=document.getElementById("ref-page-size");e&&(e.value=Qe);const t=document.getElementById("ref-sort");t&&(t.value=_n)}function Pl(e){const t=document.documentElement;e==="dark"?t.setAttribute("data-theme","dark"):e==="light"?t.setAttribute("data-theme","light"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?t.setAttribute("data-theme","dark"):t.removeAttribute("data-theme")}function xi(){ye&&(document.getElementById("setting-theme").value=ye.theme||"system",document.getElementById("setting-node-color").value=ye.default_node_color||"#3B82F6",document.getElementById("setting-text-color").value=ye.default_text_color||"#FFFFFF",document.getElementById("setting-node-shape").value=ye.default_node_shape||"rectangle",document.getElementById("setting-snap-grid").checked=ye.snap_to_grid||!1,document.getElementById("setting-grid-size").value=ye.grid_size||20,document.getElementById("setting-auto-save").checked=ye.auto_save!==!1,document.getElementById("setting-refs-page-size").value=ye.default_refs_page_size||20,document.getElementById("setting-refs-sort").value=ye.default_refs_sort||"imported-desc",document.getElementById("setting-email-notifications").checked=ye.email_notifications!==!1)}async function Pe(e,t){if(pe)try{ye=await K.settings.update({[e]:t}),dr(),V("Setting saved")}catch(n){V(`Error saving setting: ${n.message}`)}}async function Rl(){if(!pe)return;if(await Ae("Are you sure you want to reset all settings to defaults?","Reset Settings","Reset"))try{ye=await K.settings.reset(),dr(),xi(),V("Settings reset to defaults")}catch(t){V(`Error resetting settings: ${t.message}`)}}async function et(){try{ot=await K.taxonomies.list(),or=[...ot],Ul(),Vn()}catch(e){V(`Error loading taxonomies: ${e.message}`)}}function Vn(){let e=[...or];if(Ot){const t=Ot.toLowerCase();e=e.filter(n=>n.name.toLowerCase().includes(t))}e=Fl(e,bi),Yn=e,Hl()}function Fl(e,t){const n=[...e];switch(t){case"created-desc":n.sort((r,o)=>new Date(o.created_at)-new Date(r.created_at));break;case"created-asc":n.sort((r,o)=>new Date(r.created_at)-new Date(o.created_at));break;case"modified-desc":n.sort((r,o)=>new Date(o.updated_at||o.created_at)-new Date(r.updated_at||r.created_at));break;case"modified-asc":n.sort((r,o)=>new Date(r.updated_at||r.created_at)-new Date(o.updated_at||o.created_at));break;case"name-asc":n.sort((r,o)=>r.name.localeCompare(o.name));break;case"name-desc":n.sort((r,o)=>o.name.localeCompare(r.name));break}return n}function Ul(){[document.getElementById("prop-taxonomies"),document.getElementById("import-taxonomies"),document.getElementById("ref-taxonomy-filter"),document.getElementById("ref-edit-taxonomies")].forEach(t=>{if(!t)return;const n=t.id==="ref-taxonomy-filter",r=Array.from(t.selectedOptions).map(o=>o.value);t.innerHTML=n?'<option value="">All</option>':"",ot.forEach(o=>{const a=document.createElement("option");a.value=o.id,a.textContent=o.name,a.style.backgroundColor=o.color,r.includes(String(o.id))&&(a.selected=!0),t.appendChild(a)})})}function Hl(){const e=document.getElementById("taxonomies-list"),t=Yn.length>0||Ot?Yn:or;if(t.length===0){e.innerHTML=Ot?"<p>No tags match your filter.</p>":"<p>No tags yet. Create one to get started!</p>";return}e.innerHTML=t.map(n=>`
    <div class="card taxonomy-card taxonomy-card-compact" role="listitem" data-id="${n.id}">
      <div class="taxonomy-card-row">
        <h3><span class="tag-color-dot" style="background-color: ${n.color}"></span>${re(n.name)}</h3>
        <button class="btn-icon btn-danger-icon delete-taxonomy" data-id="${n.id}" data-name="${re(n.name)}" aria-label="Delete ${n.name}" title="Delete">
          <span aria-hidden="true">&#128465;</span>
        </button>
      </div>
    </div>
  `).join(""),e.querySelectorAll(".taxonomy-card").forEach(n=>{n.addEventListener("click",r=>{r.target.closest(".delete-taxonomy")||jl(parseInt(n.dataset.id))})}),e.querySelectorAll(".delete-taxonomy").forEach(n=>{n.addEventListener("click",async r=>{r.stopPropagation();const o=n.dataset.name;if(await Ae(`Are you sure you want to delete the tag "${o}"? This action cannot be undone.`,"Delete Tag","Delete"))try{await K.taxonomies.delete(n.dataset.id),await et(),V("Tag deleted")}catch(i){V(`Error: ${i.message}`)}})})}function jl(e){const t=ot.find(n=>n.id===e);t&&(yn=e,document.getElementById("create-tax-title").textContent="Edit Tag",document.getElementById("tax-name").value=t.name,document.getElementById("tax-description").value=t.description||"",document.getElementById("tax-color").value=t.color,document.getElementById("tax-submit-btn").textContent="Save",Be("create-taxonomy-modal"))}function Dr(){yn=null,document.getElementById("create-tax-title").textContent="Create Tag",document.getElementById("create-taxonomy-form").reset(),document.getElementById("tax-color").value="#6B7280",document.getElementById("tax-submit-btn").textContent="Create"}async function kt(e=null){try{kl=e||"",sr=await K.media.list(e||null),Kn()}catch(t){V(`Error loading media: ${t.message}`)}}function Kn(){let e=[...sr];if(Gn){const n=Gn.toLowerCase();e=e.filter(r=>r.title&&r.title.toLowerCase().includes(n)||r.description&&r.description.toLowerCase().includes(n))}e=Wl(e,vi),Pt=e;const t=Math.ceil(Pt.length/mt)||1;be>t&&(be=1),sn()}function Wl(e,t){const n=[...e];switch(t){case"created-desc":n.sort((r,o)=>new Date(o.created_at)-new Date(r.created_at));break;case"created-asc":n.sort((r,o)=>new Date(r.created_at)-new Date(o.created_at));break;case"title-asc":n.sort((r,o)=>(r.title||"").localeCompare(o.title||""));break;case"title-desc":n.sort((r,o)=>(o.title||"").localeCompare(r.title||""));break}return n}function sn(){const e=document.getElementById("media-list"),t=Pt.length,n=Math.ceil(t/mt)||1;be<1&&(be=1),be>n&&(be=n);const r=(be-1)*mt,o=Math.min(r+mt,t),a=Pt.slice(r,o);t===0?e.innerHTML='<p>No media found. Click "Add Media" to add your first link!</p>':(e.innerHTML=a.map(i=>{var s;return`
      <article class="reference-card media-card" role="listitem" data-id="${i.id}">
        <h3>${re(i.title)}</h3>
        <p class="meta"><a href="${re(i.url)}" target="_blank" rel="noopener noreferrer">${re(i.url)}</a></p>
        ${i.description?`<p class="description">${re(i.description)}</p>`:""}
        <div class="tags">
          ${((s=i.taxonomies)==null?void 0:s.map(l=>`
            <span class="tag" style="background: ${l.color}; color: white;">${re(l.name)}</span>
          `).join(""))||""}
        </div>
        <p class="meta">Added ${cr(i.created_at)}</p>
      </article>
    `}).join(""),e.querySelectorAll(".media-card").forEach(i=>{i.addEventListener("click",s=>{s.target.tagName!=="A"&&Ei(parseInt(i.dataset.id))})})),Zl(t,n,r,o)}function Zl(e,t,n,r){const o=document.getElementById("media-pagination-info"),a=document.getElementById("media-page-indicator"),i=document.getElementById("media-prev-page"),s=document.getElementById("media-next-page");e===0?o.textContent="No media":o.textContent=`Showing ${n+1}-${r} of ${e} media`,a.textContent=`Page ${be} of ${t}`,i.disabled=be<=1,s.disabled=be>=t}function Ei(e=null){if(document.getElementById("media-modal"),e){const t=sr.find(n=>n.id===e);if(!t)return;dt=e,document.getElementById("media-modal-title").textContent="Edit Media",document.getElementById("media-title").value=t.title,document.getElementById("media-url").value=t.url,document.getElementById("media-description").value=t.description||"",document.getElementById("media-submit-btn").textContent="Save",document.getElementById("delete-media-btn").hidden=!1,Rt=t.taxonomies?t.taxonomies.map(n=>({id:n.id,name:n.name,color:n.color})):[],vn("media-legend-category",t.legend_category)}else dt=null,document.getElementById("media-modal-title").textContent="Add Media",document.getElementById("media-form").reset(),document.getElementById("media-submit-btn").textContent="Add",document.getElementById("delete-media-btn").hidden=!0,Rt=[],vn("media-legend-category");st("media"),Be("media-modal")}function ql(){const e=document.getElementById("media-taxonomy-filter");if(!e)return;const t=e.value;e.innerHTML='<option value="">All</option>',ot.forEach(n=>{const r=document.createElement("option");r.value=n.id,r.textContent=n.name,r.style.backgroundColor=n.color,t===String(n.id)&&(r.selected=!0),e.appendChild(r)})}async function Ue(){try{const e=await K.bibmaps.list();Xl(e)}catch(e){V(`Error loading BibMaps: ${e.message}`)}}function Xl(e){const t=document.getElementById("bibmaps-list");if(e.length===0){t.innerHTML="<p>No BibMaps yet. Create one to get started!</p>";return}t.innerHTML=e.map(n=>`
    <div class="card" role="listitem" data-id="${n.id}">
      <h3>${re(n.title)}</h3>
      <p>${re(n.description||"No description")}</p>
      <div class="card-footer">
        <span>Updated ${cr(n.updated_at)}</span>
        <div class="card-actions">
          <button class="btn-download download-bibmap" data-id="${n.id}" aria-label="Download ${n.title}" title="Download .bibmap">
            <span aria-hidden="true">&#8595;</span>
          </button>
          <button class="btn-secondary delete-bibmap" data-id="${n.id}" aria-label="Delete ${n.title}">Delete</button>
        </div>
      </div>
    </div>
  `).join(""),t.querySelectorAll(".card").forEach(n=>{n.addEventListener("click",r=>{!r.target.classList.contains("delete-bibmap")&&!r.target.classList.contains("download-bibmap")&&!r.target.closest(".download-bibmap")&&ur(n.dataset.id)})}),t.querySelectorAll(".download-bibmap").forEach(n=>{n.addEventListener("click",async r=>{r.stopPropagation(),await Gl(n.dataset.id)})}),t.querySelectorAll(".delete-bibmap").forEach(n=>{n.addEventListener("click",async r=>{if(r.stopPropagation(),await Ae("Are you sure you want to delete this BibMap? All nodes and connections will be permanently deleted.","Delete BibMap","Delete"))try{await K.bibmaps.delete(n.dataset.id),await Ue(),V("BibMap deleted")}catch(a){V(`Error: ${a.message}`)}})})}async function Yl(e){try{const t=await yi.loadAsync(e),n=t.file("bibmap.json");if(!n)throw new Error("Invalid .bibmap file: missing bibmap.json");const r=JSON.parse(await n.async("text")),o=r.bibmap||r;let a=await K.bibmaps.create({title:(o.title||"Untitled")+" (imported)",description:o.description||""});o.settings_json&&(a=await K.bibmaps.update(a.id,{settings_json:o.settings_json}));const i=t.file("references.bib");if(i){const l=await i.async("text");if(l.trim())try{await K.references.import(l,[])}catch(u){console.warn("Some references may have already existed:",u.message)}}const s={};for(const l of r.nodes||[]){const u=await K.nodes.create({bibmap_id:a.id,label:l.label,description:l.description,x:l.x,y:l.y,background_color:l.background_color,text_color:l.text_color,border_color:l.border_color,font_size:l.font_size,font_family:l.font_family,font_bold:l.font_bold,font_italic:l.font_italic,font_underline:l.font_underline,width:l.width,height:l.height,shape:l.shape,node_style:l.node_style,link_to_references:l.link_to_references,wrap_text:l.wrap_text,taxonomy_ids:[]});s[l.id]=u.id}for(const l of r.connections||[]){const u=s[l.source_node_id],h=s[l.target_node_id];u&&h&&await K.connections.create({bibmap_id:a.id,source_node_id:u,target_node_id:h,line_color:l.line_color,line_width:l.line_width,line_style:l.line_style,arrow_type:l.arrow_type,label:l.label,show_label:l.show_label})}V("BibMap imported successfully!"),Ue(),ur(a.id)}catch(t){throw console.error("Import error:",t),t}}async function Gl(e){try{V("Preparing download...");const t=await K.bibmaps.get(e),n=await K.references.list(),r=bl(t,n),o=new yi,a=_l(t);o.file("bibmap.json",JSON.stringify(a,null,2));const i=vl(r);o.file("references.bib",i);const s=wl(t,r);o.file("tag-mappings.json",JSON.stringify(s,null,2));const l=await o.generateAsync({type:"blob"}),u=xl(t.title),h=URL.createObjectURL(l),g=document.createElement("a");g.href=h,g.download=u,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(h),V("Download started")}catch(t){V(`Error downloading: ${t.message}`),console.error("Download error:",t)}}async function ur(e){ve("editor"),de||(de=new pi("bibmap-container",{onNodeSelect:Vl,onConnectionSelect:Kl,onCanvasClick:ut,announce:V}));try{oe=await de.load(e),Il(oe),document.getElementById("editor-heading").textContent=oe.title;const t=document.getElementById("publish-toggle"),n=document.getElementById("copy-link");t.checked=oe.is_published||!1,n.disabled=!oe.is_published,ec(),document.getElementById("show-legend-toggle").checked=it,tt(),V(`Opened BibMap: ${oe.title}`)}catch(t){V(`Error loading BibMap: ${t.message}`)}}function Jl(){oe&&(ct=oe.id,document.getElementById("create-bm-title").textContent="Edit BibMap",document.getElementById("bm-title").value=oe.title,document.getElementById("bm-description").value=oe.description||"",document.getElementById("bm-submit-btn").textContent="Save",document.getElementById("delete-bibmap-btn").hidden=!1,Be("create-bibmap-modal"))}function en(){ct=null,document.getElementById("create-bm-title").textContent="Create BibMap",document.getElementById("create-bibmap-form").reset(),document.getElementById("bm-submit-btn").textContent="Create",document.getElementById("delete-bibmap-btn").hidden=!0}function Vl(e){wn(),Ye=null,Si(e),Ci(!0),$n()}function Kl(e){ut(),e?(Ye=e.id,rc(e)):(Ye=null,wn()),$n()}function $n(){const e=Ie!==null||Ye!==null;document.getElementById("duplicate-btn").disabled=!e,document.getElementById("delete-btn").disabled=!e}const Or=["stripes","dots","crosshatch","dashes","waves"];function ki(e){return Or[e%Or.length]}function tt(){const e=document.getElementById("legend-panel"),t=document.getElementById("legend-items");if(!it||!de){e.hidden=!0;return}const n=new Map;if((de.nodes||[]).forEach(i=>{const s=(i.background_color||"#3B82F6").toUpperCase();n.has(s)?n.get(s).count++:n.set(s,{color:s,count:1})}),n.size===0){e.hidden=!0;return}const o=Array.from(n.values()).sort((i,s)=>s.count-i.count);let a=1;o.forEach(i=>{xe[i.color]||(xe[i.color]=`Category ${a}`),a++}),t.innerHTML="",o.forEach((i,s)=>{const l=document.createElement("li");l.className="legend-item",l.dataset.color=i.color;const u=ki(s);l.innerHTML=`
      <span class="legend-color-indicator"
            style="background-color: ${i.color}"
            data-pattern="${u}"
            title="Pattern: ${u}"
            aria-label="Color indicator with ${u} pattern"></span>
      <span class="legend-label"
            tabindex="0"
            role="button"
            aria-label="${xe[i.color]}. Double-click to edit."
            title="Double-click to edit">${xe[i.color]}</span>
    `,t.appendChild(l)}),e.hidden=!1,Ii()}function Ii(){if(oe&&oe.id){const e=oe.settings_json?JSON.parse(oe.settings_json):{};e.legendLabels=xe,K.bibmaps.update(oe.id,{settings_json:JSON.stringify(e)}).catch(t=>console.error("Failed to save legend labels:",t))}}function Ql(){if(oe&&oe.id){const e=oe.settings_json?JSON.parse(oe.settings_json):{};e.showLegend=it,oe.settings_json=JSON.stringify(e),K.bibmaps.update(oe.id,{settings_json:oe.settings_json}).catch(t=>console.error("Failed to save legend visibility:",t))}}function ec(){if(oe&&oe.settings_json)try{const e=JSON.parse(oe.settings_json);xe=e.legendLabels||{},it=e.showLegend||!1}catch{xe={},it=!1}else xe={},it=!1}function vn(e,t=null){var a;const n=document.getElementById(e);if(!n)return;const r=(a=n.parentElement)==null?void 0:a.querySelector(".help-text"),o={"import-legend-category":"Assign all imported references to this legend category","ref-legend-category":"Assign to a legend category to link with nodes of the same color","media-legend-category":"Assign to a legend category to link with nodes of the same color"};if(!Xe){n.innerHTML='<option value="">None</option>',n.disabled=!0,r&&(r.textContent="Open a BibMap to assign legend categories");return}n.disabled=!1,r&&o[e]&&(r.textContent=o[e]),n.innerHTML='<option value="">None</option>',Object.entries(xe).forEach(([i,s])=>{const l=document.createElement("option");l.value=i,l.textContent=s,l.style.backgroundColor=i,n.appendChild(l)}),t&&(n.value=t.toUpperCase())}function Bi(e){const t=document.getElementById("existing-categories");if(!t)return;t.innerHTML="";const n=e?e.toUpperCase():null;Object.entries(xe).forEach(([r,o])=>{const a=document.createElement("button");a.type="button",a.className="category-option",n===r.toUpperCase()&&a.classList.add("selected"),a.dataset.color=r,a.innerHTML=`
      <span class="category-color-swatch" style="background-color: ${r}" title="${o}"></span>
    `,a.addEventListener("click",()=>tc(r)),t.appendChild(a)})}function tc(e){document.getElementById("prop-bg-color").value=e,document.querySelectorAll("#existing-categories .category-option").forEach(t=>{t.classList.toggle("selected",t.dataset.color.toUpperCase()===e.toUpperCase())}),ke("background_color",e),tt(),An(document.getElementById("prop-link-refs").checked)}async function nc(e){if(Te)try{await K.references.update(Te,{legend_category:e||null}),ze()}catch(t){V(`Error saving legend category: ${t.message}`)}}function Pr(e,t){const n=xe[t]||"Category",r=document.createElement("input");r.type="text",r.className="legend-label-input",r.value=n,r.setAttribute("aria-label","Edit legend label"),e.replaceWith(r),r.focus(),r.select();function o(){const a=r.value.trim()||n;xe[t]=a;const i=document.createElement("span");i.className="legend-label",i.tabIndex=0,i.role="button",i.setAttribute("aria-label",`${a}. Double-click to edit.`),i.title="Double-click to edit",i.textContent=a,r.replaceWith(i),Ii()}r.addEventListener("blur",o),r.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),r.blur()):a.key==="Escape"&&(r.value=n,r.blur())})}function rc(e){const t=document.getElementById("connection-panel");t.hidden=!1,t.dataset.connectionId=e.id,document.getElementById("conn-label").value=e.label||"",document.getElementById("conn-show-label").checked=e.show_label||!1,document.getElementById("conn-line-color").value=e.line_color||"#6B7280",document.getElementById("conn-line-width").value=e.line_width||4,document.getElementById("conn-line-style").value=e.line_style||"solid",document.getElementById("conn-arrow-type").value=e.arrow_type||"end"}function wn(){const e=document.getElementById("connection-panel");e.hidden=!0,delete e.dataset.connectionId,Ye=null,$n()}function Ci(e){const t=document.getElementById("connect-mode");t.disabled=!e}function Si(e){const t=document.getElementById("properties-panel");t.hidden=!1,Ie=e.id,document.getElementById("prop-label").value=e.label||"",document.getElementById("prop-description").value=e.description||"",document.getElementById("prop-bg-color").value=e.background_color||"#3B82F6",Bi(e.background_color);const n=e.text_color||"#FFFFFF";document.getElementById("prop-text-color").value=n,document.getElementById("text-color-bar").style.backgroundColor=n,document.getElementById("prop-shape").value=e.shape||"rectangle",document.getElementById("prop-node-style").value=e.node_style||"flat",document.getElementById("prop-link-refs").checked=e.link_to_references!==!1,document.getElementById("prop-wrap-text").checked=e.wrap_text!==!1,document.getElementById("prop-font-family").value=e.font_family||"system-ui",document.getElementById("prop-font-size").value=e.font_size||14,document.getElementById("prop-bold").classList.toggle("active",e.font_bold||!1),document.getElementById("prop-italic").classList.toggle("active",e.font_italic||!1),document.getElementById("prop-underline").classList.toggle("active",e.font_underline||!1),yt=e.taxonomies?e.taxonomies.map(r=>({id:r.id,name:r.name,color:r.color})):[],st("node"),An(e.link_to_references!==!1),Li(e.id,e.link_to_references!==!1),t.dataset.nodeId=e.id}function Ke(e,t){let n;return function(...o){const a=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(a,t)}}async function ke(e,t){const n=parseInt(document.getElementById("properties-panel").dataset.nodeId);if(!(!n||!de))try{const r={[e]:t};e==="taxonomy_ids"&&(r.taxonomy_ids=Array.from(document.getElementById("prop-taxonomies").selectedOptions).map(o=>parseInt(o.value))),await de.updateNode(n,r)}catch(r){V(`Error: ${r.message}`)}}const Rr=Ke(ke,300);async function lt(e,t){const n=parseInt(document.getElementById("connection-panel").dataset.connectionId);if(!(!n||!de))try{await de.updateConnection(n,{[e]:t})}catch(r){V(`Error: ${r.message}`)}}const ic=Ke(lt,300);function An(e=!0){const t=document.getElementById("prop-link-refs"),n=document.getElementById("link-refs-help"),r=yt.length>0,o=document.getElementById("prop-bg-color").value,a=o&&o.toUpperCase()!=="#3B82F6",i=r||a;t.disabled=!i,i?(t.checked=e,n.hidden=!0):(t.checked=!1,n.hidden=!1)}async function Li(e,t=!0){const n=document.getElementById("node-references"),r=document.getElementById("node-refs-count");try{const[o,a]=await Promise.all([K.nodes.getReferences(e),K.nodes.getMedia(e)]),i=o.length+a.length;r.textContent=i,n.hidden=!(i>0&&t)}catch(o){console.error("Failed to load node references:",o),n.hidden=!0}}function ac(e){const t=de?de.getNodeById(e):null,n=t?t.label:"Node",r=t&&t.description?t.description:"";document.getElementById("node-refs-node-name").textContent=n,document.getElementById("node-refs-description").textContent=r,document.getElementById("node-refs-description").hidden=!r,ve("nodeRefs"),oc(e)}async function oc(e){const t=document.getElementById("node-refs-page-content");t.innerHTML="<p>Loading references and media...</p>";try{const[n,r]=await Promise.all([K.nodes.getReferences(e),K.nodes.getMedia(e)]);if(n.length===0&&r.length===0){t.innerHTML="<p>No linked references or media found. Add tags to this node that match your references or media to see them here.</p>";return}let o="";const a=[...n.map(i=>({...i,itemType:"reference"})),...r.map(i=>({...i,itemType:"media"}))];a.sort((i,s)=>new Date(s.created_at)-new Date(i.created_at)),o+=a.map(i=>{var s,l;return i.itemType==="reference"?`
          <article class="reference-card" role="listitem" data-id="${i.id}" data-type="reference">
            <h3>${re(i.title||i.bibtex_key)}</h3>
            <p class="authors">${re(i.author||"Unknown author")}</p>
            <p class="meta">
              ${i.year?`(${i.year})`:""}
              ${i.journal?`<em>${re(i.journal)}</em>`:""}
              ${i.booktitle?`In <em>${re(i.booktitle)}</em>`:""}
            </p>
            <div class="tags">
              ${((s=i.taxonomies)==null?void 0:s.map(u=>`
                <span class="tag" style="background: ${u.color}; color: white;">${re(u.name)}</span>
              `).join(""))||""}
            </div>
            ${i.doi?`<p class="meta"><a href="https://doi.org/${i.doi}" target="_blank" rel="noopener noreferrer">DOI: ${i.doi}</a></p>`:""}
            ${i.abstract?`<p class="abstract">${re(i.abstract.substring(0,300))}${i.abstract.length>300?"...":""}</p>`:""}
            ${xn(i.match_reasons)}
          </article>
        `:`
          <article class="reference-card media-card" role="listitem" data-id="${i.id}" data-type="media">
            <h3>${re(i.title)}</h3>
            <p class="meta"><a href="${re(i.url)}" target="_blank" rel="noopener noreferrer">${re(i.url)}</a></p>
            ${i.description?`<p class="description">${re(i.description)}</p>`:""}
            <div class="tags">
              ${((l=i.taxonomies)==null?void 0:l.map(u=>`
                <span class="tag" style="background: ${u.color}; color: white;">${re(u.name)}</span>
              `).join(""))||""}
            </div>
            <p class="meta">Added ${cr(i.created_at)}</p>
            ${xn(i.match_reasons)}
          </article>
        `}).join(""),t.innerHTML=o,t.querySelectorAll('.reference-card[data-type="reference"]').forEach(i=>{i.addEventListener("click",()=>$i(i.dataset.id))})}catch(n){t.innerHTML=`<p>Error loading: ${n.message}</p>`}}function ut(){document.getElementById("properties-panel").hidden=!0,Ie=null,Ci(!1),$n();const e=document.getElementById("connect-mode");e.getAttribute("aria-pressed")==="true"&&(e.setAttribute("aria-pressed","false"),de&&de.setConnectMode(!1))}async function ze(e=null){try{El=e||"",_i=await K.references.list(e||null),Qn()}catch(t){V(`Error loading references: ${t.message}`)}}function Qn(){let e=[..._i];if(Xn){const n=Xn.toLowerCase();e=e.filter(r=>r.title&&r.title.toLowerCase().includes(n)||r.author&&r.author.toLowerCase().includes(n)||r.bibtex_key&&r.bibtex_key.toLowerCase().includes(n))}e=sc(e,_n),Dt=e;const t=Math.ceil(Dt.length/Qe)||1;_e>t&&(_e=1),ln()}function sc(e,t){const n=[...e];switch(t){case"imported-desc":n.sort((r,o)=>new Date(o.created_at)-new Date(r.created_at));break;case"imported-asc":n.sort((r,o)=>new Date(r.created_at)-new Date(o.created_at));break;case"year-desc":n.sort((r,o)=>(parseInt(o.year)||0)-(parseInt(r.year)||0));break;case"year-asc":n.sort((r,o)=>(parseInt(r.year)||0)-(parseInt(o.year)||0));break;case"title-asc":n.sort((r,o)=>(r.title||r.bibtex_key||"").localeCompare(o.title||o.bibtex_key||""));break;case"title-desc":n.sort((r,o)=>(o.title||o.bibtex_key||"").localeCompare(r.title||r.bibtex_key||""));break;case"author-asc":n.sort((r,o)=>(r.author||"").localeCompare(o.author||""));break;case"author-desc":n.sort((r,o)=>(o.author||"").localeCompare(r.author||""));break}return n}function ln(){const e=document.getElementById("references-list"),t=Dt.length,n=Math.ceil(t/Qe)||1;_e<1&&(_e=1),_e>n&&(_e=n);const r=(_e-1)*Qe,o=Math.min(r+Qe,t),a=Dt.slice(r,o);t===0?e.innerHTML="<p>No references found. Try adjusting your filters or import BibTeX to get started!</p>":(e.innerHTML=a.map(i=>{var l;const s=i.legend_category?Ai(i.legend_category):null;return`
      <article class="reference-card" role="listitem" data-id="${i.id}">
        ${i.legend_category?`
          <div class="reference-category" title="${re(s||"Category")}">
            <span class="category-color-block" style="background-color: ${i.legend_category}"></span>
            <span class="category-name">${re(s||"Category")}</span>
          </div>
        `:""}
        <h3>${re(i.title||i.bibtex_key)}</h3>
        <p class="authors">${re(i.author||"Unknown author")}</p>
        <p class="meta">
          ${i.year?`(${i.year})`:""}
          ${i.journal?`<em>${re(i.journal)}</em>`:""}
          ${i.booktitle?`In <em>${re(i.booktitle)}</em>`:""}
        </p>
        <div class="tags">
          ${((l=i.taxonomies)==null?void 0:l.map(u=>`
            <span class="tag" style="background: ${u.color}; color: white;">${re(u.name)}</span>
          `).join(""))||""}
        </div>
      </article>
    `}).join(""),e.querySelectorAll(".reference-card").forEach(i=>{i.addEventListener("click",()=>$i(i.dataset.id))})),lc(t,n,r,o)}function lc(e,t,n,r){const o=document.getElementById("ref-pagination-info"),a=document.getElementById("ref-page-indicator"),i=document.getElementById("ref-prev-page"),s=document.getElementById("ref-next-page");e===0?o.textContent="No references":o.textContent=`Showing ${n+1}-${r} of ${e} references`,a.textContent=`Page ${_e} of ${t}`,i.disabled=_e<=1,s.disabled=_e>=t}async function $i(e){try{const t=await K.references.get(e);Te=e;const n=document.getElementById("reference-detail-content");n.innerHTML=`
      <h3>${re(t.title||t.bibtex_key)}</h3>
      <p><strong>Authors:</strong> ${re(t.author||"Unknown")}</p>
      <p><strong>Year:</strong> ${t.year||"N/A"}</p>
      ${t.journal?`<p><strong>Journal:</strong> ${re(t.journal)}</p>`:""}
      ${t.booktitle?`<p><strong>Book/Proceedings:</strong> ${re(t.booktitle)}</p>`:""}
      ${t.doi?`<p><strong>DOI:</strong> <a href="https://doi.org/${t.doi}" target="_blank">${t.doi}</a></p>`:""}
      ${t.url?`<p><strong>URL:</strong> <a href="${t.url}" target="_blank">${t.url}</a></p>`:""}
      ${t.abstract?`<p><strong>Abstract:</strong> ${re(t.abstract)}</p>`:""}
    `,Cn=t.taxonomies?t.taxonomies.map(r=>({id:r.id,name:r.name,color:r.color})):[],st("ref"),vn("ref-legend-category",t.legend_category),document.getElementById("ref-edit-bibtex").value=t.raw_bibtex,document.getElementById("reference-detail-modal").dataset.refId=e,Be("reference-detail-modal")}catch(t){V(`Error: ${t.message}`)}}function re(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function xn(e){return!e||e.length===0?"":`<div class="match-indicators">${e.map(n=>{if(n.type==="taxonomy")return`
        <span class="match-indicator match-indicator--taxonomy">
          <span class="match-label">Tag:</span>
          <span class="color-dot" style="background: ${n.taxonomy_color||"#6B7280"}"></span>
          ${re(n.taxonomy_name)}
        </span>
      `;if(n.type==="legend_category"){const r=Ai(n.legend_category);return`
        <span class="match-indicator match-indicator--legend">
          <span class="match-label">Category:</span>
          <span class="color-dot" style="background: ${n.legend_category}"></span>
          ${re(r||"Legend")}
        </span>
      `}return""}).join("")}</div>`}function Ai(e){if(!e||!xe)return null;const t=e.toUpperCase();for(const[n,r]of Object.entries(xe))if(n.toUpperCase()===t)return r;return null}function Tn(e){return e==="ref"?Cn:e==="node"?yt:e==="media"?Rt:St}function Ti(e,t){e==="ref"?Cn=t:e==="node"?yt=t:e==="media"?Rt=t:St=t}function st(e){const t=document.getElementById(`${e}-selected-tags`),n=Tn(e);t.innerHTML=n.map(r=>`
    <span class="selected-tag" style="background-color: ${r.color}" data-id="${r.id}">
      ${re(r.name)}
      <button type="button" class="remove-tag" data-id="${r.id}" aria-label="Remove ${r.name}">&times;</button>
    </span>
  `).join(""),t.querySelectorAll(".remove-tag").forEach(r=>{r.addEventListener("click",o=>{o.stopPropagation();const a=parseInt(r.dataset.id);cc(e,a)})})}function cc(e,t){const n=Tn(e);Ti(e,n.filter(r=>r.id!==t)),st(e),zi(e)}function dc(e,t){const n=Tn(e);n.find(r=>r.id===t.id)||(Ti(e,[...n,t]),st(e),zi(e)),document.getElementById(`${e}-tag-search`).value="",cn(e)}async function zi(e){if(e==="ref"&&Te)try{const t=Cn.map(n=>n.id);await K.references.update(Te,{taxonomy_ids:t}),ze()}catch(t){V(`Error saving tags: ${t.message}`)}else if(e==="node"&&Ie&&de)try{const t=yt.map(i=>i.id),n=document.getElementById("prop-link-refs"),r=n.disabled,o=yt.length>0;An(n.checked||r&&o);const a=n.checked;await de.updateNode(Ie,{taxonomy_ids:t,link_to_references:a}),Li(Ie,a)}catch(t){V(`Error saving tags: ${t.message}`)}}function Pn(e,t){const n=document.getElementById(`${e}-tag-suggestions`),o=Tn(e).map(i=>i.id),a=ot.filter(i=>!o.includes(i.id)&&i.name.toLowerCase().includes(t.toLowerCase()));a.length===0?n.innerHTML='<div class="no-suggestions">No matching tags</div>':(n.innerHTML=a.map(i=>`
      <div class="tag-suggestion" data-id="${i.id}">
        <span class="tag-color-dot" style="background-color: ${i.color}"></span>
        <span class="tag-suggestion-name">${re(i.name)}</span>
      </div>
    `).join(""),n.querySelectorAll(".tag-suggestion").forEach(i=>{i.addEventListener("click",()=>{const s=parseInt(i.dataset.id),l=ot.find(u=>u.id===s);l&&dc(e,{id:l.id,name:l.name,color:l.color})})})),n.hidden=!1}function cn(e){document.getElementById(`${e}-tag-suggestions`).hidden=!0}function tn(e){const t=document.getElementById(`${e}-tag-search`),n=document.getElementById(`${e}-tag-suggestions`);t.addEventListener("input",r=>{const o=r.target.value.trim();o.length>0?Pn(e,o):cn(e)}),t.addEventListener("focus",()=>{t.value.trim().length>0?Pn(e,t.value.trim()):Pn(e,"")}),document.addEventListener("click",r=>{const o=document.getElementById(`${e}-tag-input-container`);o&&!o.contains(r.target)&&cn(e)}),t.addEventListener("keydown",r=>{var i,s;const o=n.querySelectorAll(".tag-suggestion"),a=n.querySelector(".tag-suggestion.highlighted");r.key==="ArrowDown"?(r.preventDefault(),!a&&o.length>0?o[0].classList.add("highlighted"):a&&((i=a.nextElementSibling)!=null&&i.classList.contains("tag-suggestion"))&&(a.classList.remove("highlighted"),a.nextElementSibling.classList.add("highlighted"))):r.key==="ArrowUp"?(r.preventDefault(),a&&((s=a.previousElementSibling)!=null&&s.classList.contains("tag-suggestion"))&&(a.classList.remove("highlighted"),a.previousElementSibling.classList.add("highlighted"))):r.key==="Enter"?(r.preventDefault(),a&&a.click()):r.key==="Escape"&&cn(e)})}function uc(){var i,s,l,u,h,g,b,m,w,p,v,y,E;Je.bibmaps.addEventListener("click",()=>{ve("bibmaps"),Ue()}),Je.references.addEventListener("click",()=>{ve("references"),ze()}),Je.media.addEventListener("click",()=>{ve("media"),kt(),ql()}),Je.taxonomies.addEventListener("click",()=>{ve("taxonomies"),et()}),Je.settings.addEventListener("click",()=>{ve("settings"),Ln()}),Je.admin.addEventListener("click",()=>{ve("admin"),bn()}),Je.about.addEventListener("click",()=>{ve("about")}),document.getElementById("auth-toggle-btn").addEventListener("click",()=>{pe?Al():Nr()}),document.getElementById("register-btn").addEventListener("click",Mr),document.getElementById("profile-btn").addEventListener("click",Sl),document.getElementById("login-form").addEventListener("submit",Ll),document.getElementById("register-form").addEventListener("submit",$l),document.getElementById("profile-form").addEventListener("submit",Tl),document.getElementById("change-password-form").addEventListener("submit",zl),document.getElementById("switch-to-register").addEventListener("click",f=>{f.preventDefault(),_t(),Mr()}),document.getElementById("switch-to-login").addEventListener("click",f=>{f.preventDefault(),_t(),Nr()}),document.getElementById("google-login-btn").addEventListener("click",()=>{K.auth.googleLogin()}),document.getElementById("google-register-btn").addEventListener("click",()=>{K.auth.googleLogin()}),(i=document.getElementById("create-user"))==null||i.addEventListener("click",Ml),document.getElementById("user-form").addEventListener("submit",Ol),(s=document.getElementById("user-search"))==null||s.addEventListener("input",Ke(()=>bn(),300)),(l=document.getElementById("reset-settings"))==null||l.addEventListener("click",Rl),(u=document.getElementById("setting-theme"))==null||u.addEventListener("change",f=>Pe("theme",f.target.value)),(h=document.getElementById("setting-node-color"))==null||h.addEventListener("input",Ke(f=>Pe("default_node_color",f.target.value),300)),(g=document.getElementById("setting-text-color"))==null||g.addEventListener("input",Ke(f=>Pe("default_text_color",f.target.value),300)),(b=document.getElementById("setting-node-shape"))==null||b.addEventListener("change",f=>Pe("default_node_shape",f.target.value)),(m=document.getElementById("setting-snap-grid"))==null||m.addEventListener("change",f=>Pe("snap_to_grid",f.target.checked)),(w=document.getElementById("setting-grid-size"))==null||w.addEventListener("change",f=>Pe("grid_size",parseInt(f.target.value)||20)),(p=document.getElementById("setting-auto-save"))==null||p.addEventListener("change",f=>Pe("auto_save",f.target.checked)),(v=document.getElementById("setting-refs-page-size"))==null||v.addEventListener("change",f=>Pe("default_refs_page_size",parseInt(f.target.value)||20)),(y=document.getElementById("setting-refs-sort"))==null||y.addEventListener("change",f=>Pe("default_refs_sort",f.target.value)),(E=document.getElementById("setting-email-notifications"))==null||E.addEventListener("change",f=>Pe("email_notifications",f.target.checked)),document.getElementById("create-bibmap").addEventListener("click",()=>{en(),Be("create-bibmap-modal")}),document.getElementById("import-bibmap").addEventListener("click",()=>{document.getElementById("bibmap-file-input").click()}),document.getElementById("bibmap-file-input").addEventListener("change",async f=>{const _=f.target.files[0];if(_)try{V("Importing BibMap..."),await Yl(_),f.target.value=""}catch(I){V(`Error importing: ${I.message}`)}}),document.getElementById("create-bibmap-form").addEventListener("submit",async f=>{f.preventDefault();try{const _={title:document.getElementById("bm-title").value,description:document.getElementById("bm-description").value};if(ct)oe=await K.bibmaps.update(ct,_),document.getElementById("editor-heading").textContent=oe.title,V("BibMap updated");else{const I=await K.bibmaps.create(_);V("BibMap created"),Ee(),en(),ur(I.id);return}Ee(),en()}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("delete-bibmap-btn").addEventListener("click",async()=>{if(!ct)return;if(Ee(),await Ae("Are you sure you want to delete this BibMap? All nodes and connections will be permanently deleted.","Delete BibMap","Delete"))try{await K.bibmaps.delete(ct),en(),ve("bibmaps"),Ue(),V("BibMap deleted")}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("back-to-list").addEventListener("click",()=>{ut(),ve("bibmaps"),Ue()}),document.getElementById("close-bibmap").addEventListener("click",()=>{ut(),Kt(),ve("bibmaps"),Ue()}),document.getElementById("close-active-bibmap-refs").addEventListener("click",()=>{Kt(),ze()}),document.getElementById("close-active-bibmap-media").addEventListener("click",()=>{Kt(),kt()}),document.getElementById("close-active-bibmap-tags").addEventListener("click",()=>{Kt(),et()}),document.getElementById("back-to-editor").addEventListener("click",()=>{ve("editor")}),document.getElementById("add-node").addEventListener("click",async()=>{if(de){const f=100+Math.random()*400,_=100+Math.random()*300;await de.addNode(f,_),tt()}}),document.getElementById("connect-mode").addEventListener("click",f=>{const _=f.currentTarget;if(_.disabled)return;const I=_.getAttribute("aria-pressed")!=="true";_.setAttribute("aria-pressed",I),de&&de.startDragConnection(I)}),document.getElementById("duplicate-btn").addEventListener("click",async()=>{if(de)try{if(Ie){const f=await de.duplicateNode(Ie);f&&(Ie=f.id,Si(f))}else Ye&&await de.duplicateConnection(Ye)}catch(f){V(`Error: ${f.message}`)}}),document.getElementById("delete-btn").addEventListener("click",async()=>{if(de){if(Ie){if(await Ae("Are you sure you want to delete this node?","Delete Node","Delete"))try{await de.deleteNode(Ie),ut(),tt()}catch(_){V(`Error: ${_.message}`)}}else if(Ye&&await Ae("Are you sure you want to delete this connection?","Delete Connection","Delete"))try{await de.deleteConnection(Ye),wn()}catch(_){V(`Error: ${_.message}`)}}}),document.getElementById("publish-toggle").addEventListener("change",async f=>{if(oe)try{f.target.checked?(oe=await K.bibmaps.publish(oe.id),V("BibMap published")):(oe=await K.bibmaps.unpublish(oe.id),V("BibMap unpublished")),document.getElementById("copy-link").disabled=!oe.is_published}catch(_){f.target.checked=!f.target.checked,V(`Error: ${_.message}`)}}),document.getElementById("copy-link").addEventListener("click",async()=>{if(!oe||!oe.is_published)return;const f=`${window.location.origin}/share/${oe.id}`;try{await navigator.clipboard.writeText(f),V("Link copied to clipboard")}catch{prompt("Copy this link:",f)}}),document.getElementById("edit-bibmap").addEventListener("click",()=>{Jl()}),document.getElementById("show-legend-toggle").addEventListener("change",f=>{it=f.target.checked,tt(),Ql()}),document.getElementById("legend-items").addEventListener("dblclick",f=>{const _=f.target.closest(".legend-label");if(_){const I=_.closest(".legend-item"),N=I==null?void 0:I.dataset.color;N&&Pr(_,N)}}),document.getElementById("legend-items").addEventListener("keydown",f=>{if(f.key==="Enter"||f.key===" "){const _=f.target.closest(".legend-label");if(_){f.preventDefault();const I=_.closest(".legend-item"),N=I==null?void 0:I.dataset.color;N&&Pr(_,N)}}}),document.getElementById("node-refs-link").addEventListener("click",f=>{f.preventDefault(),Ie&&ac(Ie)}),document.getElementById("prop-label").addEventListener("input",f=>{Rr("label",f.target.value)}),document.getElementById("prop-description").addEventListener("input",f=>{Rr("description",f.target.value)}),document.getElementById("prop-bg-color").addEventListener("input",f=>{ke("background_color",f.target.value),tt(),Bi(f.target.value);const _=document.getElementById("prop-link-refs");An(_.checked)}),document.getElementById("prop-text-color").addEventListener("input",f=>{document.getElementById("text-color-bar").style.backgroundColor=f.target.value,ke("text_color",f.target.value)}),document.getElementById("prop-shape").addEventListener("change",f=>{ke("shape",f.target.value)}),document.getElementById("prop-node-style").addEventListener("change",f=>{ke("node_style",f.target.value)}),document.getElementById("prop-link-refs").addEventListener("change",f=>{ke("link_to_references",f.target.checked)}),document.getElementById("prop-wrap-text").addEventListener("change",f=>{ke("wrap_text",f.target.checked)}),document.getElementById("snap-to-grid").addEventListener("change",f=>{de&&(de.snapToGrid=f.target.checked)}),document.getElementById("prop-font-family").addEventListener("change",f=>{ke("font_family",f.target.value)}),document.getElementById("prop-font-size").addEventListener("input",f=>{ke("font_size",parseInt(f.target.value)||14)}),document.getElementById("prop-bold").addEventListener("click",f=>{const _=f.currentTarget;_.classList.toggle("active"),ke("font_bold",_.classList.contains("active"))}),document.getElementById("prop-italic").addEventListener("click",f=>{const _=f.currentTarget;_.classList.toggle("active"),ke("font_italic",_.classList.contains("active"))}),document.getElementById("prop-underline").addEventListener("click",f=>{const _=f.currentTarget;_.classList.toggle("active"),ke("font_underline",_.classList.contains("active"))}),document.getElementById("delete-node").addEventListener("click",async()=>{const f=parseInt(document.getElementById("properties-panel").dataset.nodeId);if(!f)return;if(await Ae("Are you sure you want to delete this node?","Delete Node","Delete"))try{await de.deleteNode(f),ut(),tt()}catch(I){V(`Error: ${I.message}`)}}),document.getElementById("delete-connection").addEventListener("click",async()=>{const f=parseInt(document.getElementById("connection-panel").dataset.connectionId);if(!f)return;if(await Ae("Are you sure you want to delete this connection?","Delete Connection","Delete"))try{await de.deleteConnection(f),wn()}catch(I){V(`Error: ${I.message}`)}}),document.getElementById("conn-label").addEventListener("input",f=>{ic("label",f.target.value)}),document.getElementById("conn-show-label").addEventListener("change",f=>{lt("show_label",f.target.checked)}),document.getElementById("conn-line-color").addEventListener("input",f=>{lt("line_color",f.target.value)}),document.getElementById("conn-line-width").addEventListener("input",f=>{lt("line_width",parseInt(f.target.value)||2)}),document.getElementById("conn-line-style").addEventListener("change",f=>{lt("line_style",f.target.value)}),document.getElementById("conn-arrow-type").addEventListener("change",f=>{lt("arrow_type",f.target.value)}),document.getElementById("import-bibtex").addEventListener("click",()=>{St=[],st("import"),document.getElementById("import-result").hidden=!0,document.getElementById("import-duplicates").hidden=!0,document.getElementById("import-errors-container").hidden=!0,vn("import-legend-category"),Be("import-bibtex-modal")}),document.getElementById("bibtex-file").addEventListener("change",async f=>{const _=f.target.files[0];if(_)try{const I=await _.text();document.getElementById("bibtex-content").value=I,V(`Loaded ${_.name}`)}catch(I){V(`Error reading file: ${I.message}`)}}),document.getElementById("import-bibtex-form").addEventListener("submit",async f=>{f.preventDefault();const _=document.getElementById("bibtex-content").value;if(!_.trim()){V("Please provide BibTeX content");return}const I=St.map(A=>A.id),N=document.getElementById("import-legend-category").value||null;try{const A=await K.references.import(_,I,N);document.getElementById("import-result").hidden=!1;const U=A.errors.filter(c=>c.startsWith("Skipped duplicate:")),M=A.errors.filter(c=>!c.startsWith("Skipped duplicate:"));document.getElementById("import-summary").textContent=`Imported ${A.imported} reference${A.imported!==1?"s":""}.`;const W=document.getElementById("import-duplicates"),ee=document.getElementById("import-duplicates-list");U.length>0?(W.hidden=!1,ee.innerHTML=U.map(c=>{const S=c.replace("Skipped duplicate: ","");return`<li>${re(S)} (already exists)</li>`}).join("")):W.hidden=!0;const B=document.getElementById("import-errors-container"),R=document.getElementById("import-errors");M.length>0?(B.hidden=!1,R.innerHTML=M.map(c=>`<li>${re(c)}</li>`).join("")):B.hidden=!0,A.imported>0&&(document.getElementById("bibtex-content").value="",document.getElementById("bibtex-file").value="",St=[],st("import"),ze()),V(`Imported ${A.imported} references`)}catch(A){V(`Error: ${A.message}`)}}),document.getElementById("create-taxonomy").addEventListener("click",()=>{Dr(),Be("create-taxonomy-modal")}),document.getElementById("create-taxonomy-form").addEventListener("submit",async f=>{f.preventDefault();try{const _={name:document.getElementById("tax-name").value,description:document.getElementById("tax-description").value,color:document.getElementById("tax-color").value};yn?(await K.taxonomies.update(yn,_),V("Tag updated")):(await K.taxonomies.create(_),V("Tag created")),Ee(),Dr(),await et()}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("ref-taxonomy-filter").addEventListener("change",f=>{_e=1,ze(f.target.value||null)});const e=document.getElementById("ref-title-filter"),t=Ke(f=>{Xn=f,_e=1,Qn()},300);e.addEventListener("input",f=>{t(f.target.value)}),document.getElementById("ref-sort").addEventListener("change",f=>{_n=f.target.value,Qn()}),document.getElementById("ref-prev-page").addEventListener("click",()=>{_e>1&&(_e--,ln())}),document.getElementById("ref-next-page").addEventListener("click",()=>{const f=Math.ceil(Dt.length/Qe)||1;_e<f&&(_e++,ln())}),document.getElementById("ref-page-size").addEventListener("change",f=>{Qe=parseInt(f.target.value)||20,_e=1,ln()}),document.getElementById("add-media").addEventListener("click",()=>{Ei()}),document.getElementById("media-taxonomy-filter").addEventListener("change",f=>{be=1,kt(f.target.value||null)});const n=document.getElementById("media-title-filter"),r=Ke(f=>{Gn=f,be=1,Kn()},300);n.addEventListener("input",f=>{r(f.target.value)}),document.getElementById("media-sort").addEventListener("change",f=>{vi=f.target.value,Kn()}),document.getElementById("media-prev-page").addEventListener("click",()=>{be>1&&(be--,sn())}),document.getElementById("media-next-page").addEventListener("click",()=>{const f=Math.ceil(Pt.length/mt)||1;be<f&&(be++,sn())}),document.getElementById("media-page-size").addEventListener("change",f=>{mt=parseInt(f.target.value)||20,be=1,sn()}),document.getElementById("media-form").addEventListener("submit",async f=>{f.preventDefault();try{const _=document.getElementById("media-legend-category").value||null,I={title:document.getElementById("media-title").value,url:document.getElementById("media-url").value,description:document.getElementById("media-description").value||null,taxonomy_ids:Rt.map(N=>N.id),legend_category:_};dt?(await K.media.update(dt,I),V("Media updated")):(await K.media.create(I),V("Media added")),Ee(),await kt()}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("delete-media-btn").addEventListener("click",async()=>{if(!dt)return;if(Ee(),await Ae("Are you sure you want to delete this media entry?","Delete Media","Delete"))try{await K.media.delete(dt),await kt(),V("Media deleted")}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("update-bibtex-btn").addEventListener("click",async()=>{if(!Te)return;const f=document.getElementById("ref-edit-bibtex").value;if(!f.trim()){V("Please provide BibTeX content");return}try{await K.references.updateBibtex(Te,f),V("Reference updated from BibTeX");const _=await K.references.get(Te),I=document.getElementById("reference-detail-content");I.innerHTML=`
        <h3>${re(_.title||_.bibtex_key)}</h3>
        <p><strong>Authors:</strong> ${re(_.author||"Unknown")}</p>
        <p><strong>Year:</strong> ${_.year||"N/A"}</p>
        ${_.journal?`<p><strong>Journal:</strong> ${re(_.journal)}</p>`:""}
        ${_.booktitle?`<p><strong>Book/Proceedings:</strong> ${re(_.booktitle)}</p>`:""}
        ${_.doi?`<p><strong>DOI:</strong> <a href="https://doi.org/${_.doi}" target="_blank">${_.doi}</a></p>`:""}
        ${_.url?`<p><strong>URL:</strong> <a href="${_.url}" target="_blank">${_.url}</a></p>`:""}
        ${_.abstract?`<p><strong>Abstract:</strong> ${re(_.abstract)}</p>`:""}
      `,ze()}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("ref-legend-category").addEventListener("change",f=>{nc(f.target.value)}),document.getElementById("delete-reference-btn").addEventListener("click",async()=>{if(!Te)return;if(Ee(),await Ae("Are you sure you want to delete this reference? This action cannot be undone.","Delete Reference","Delete"))try{await K.references.delete(Te),Te=null,ze(),V("Reference deleted")}catch(_){V(`Error: ${_.message}`)}}),document.getElementById("confirm-yes").addEventListener("click",()=>{Fe&&(Fe(!0),Fe=null),Ee()}),document.getElementById("confirm-no").addEventListener("click",()=>{Fe&&(Fe(!1),Fe=null),Ee()});const o=document.getElementById("tax-name-filter"),a=Ke(f=>{Ot=f,Vn()},300);o.addEventListener("input",f=>{a(f.target.value)}),document.getElementById("tax-sort").addEventListener("change",f=>{bi=f.target.value,Vn()}),document.querySelectorAll(".modal-close").forEach(f=>{f.addEventListener("click",Ee)}),document.getElementById("modal-overlay").addEventListener("click",f=>{f.target.id==="modal-overlay"&&Ee()}),document.addEventListener("keydown",f=>{f.key==="Escape"&&Ee()})}function hc(){const e=window.location.pathname.match(/^\/share\/(\d+)$/);return e?parseInt(e[1]):null}async function fc(e){const t=document.querySelector("header");t&&(t.hidden=!0,t.style.display="none"),document.body.classList.add("share-view-mode"),document.querySelector("main").innerHTML=`
    <div id="share-view">
      <div id="share-header">
        <h1 id="share-title">Loading...</h1>
      </div>
      <div id="bibmap-container" role="application" aria-label="BibMap view">
        <svg id="bibmap-svg" aria-hidden="true">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280"/>
            </marker>
          </defs>
          <g id="connections-layer"></g>
          <g id="nodes-layer"></g>
        </svg>
        <div id="sr-node-list" class="sr-only" role="list" aria-label="BibMap nodes"></div>
        <!-- Legend Panel for share view (read-only) -->
        <div id="legend-panel" class="legend-panel" role="region" aria-label="BibMap categories" hidden>
          <h4 class="legend-title">Categories</h4>
          <ul id="legend-items" class="legend-items" role="list" aria-label="Category list"></ul>
        </div>
      </div>
      <!-- References panel for share view -->
      <div id="share-refs-panel" class="share-refs-panel" hidden>
        <div class="share-refs-header">
          <button id="share-refs-back" class="btn btn-secondary" aria-label="Back to map">&larr; Back</button>
          <h2 id="share-refs-node-name">References</h2>
        </div>
        <div id="share-refs-content" class="share-refs-content"></div>
      </div>
    </div>
  `;try{const n=await K.bibmaps.getPublic(e);document.getElementById("share-title").textContent=n.title,document.title=`${n.title} - BibMap`;const r=new pi("bibmap-container",{onNodeSelect:()=>{},onConnectionSelect:()=>{},announce:()=>{}});r.bibmapId=e,r.nodes=n.nodes||[],r.connections=n.connections||[],r.render(),r.zoomControlsSetup||(r.setupZoomControls(),r.zoomControlsSetup=!0),r.setReadOnly(!0,{enableLinkedReferences:!0,onNodeClick:o=>mc(o,e)}),r.fitToScreen(),pc(n),document.getElementById("share-refs-back").addEventListener("click",()=>{document.getElementById("share-refs-panel").hidden=!0,document.getElementById("bibmap-container").hidden=!1})}catch(n){document.getElementById("share-title").textContent="BibMap not found",document.getElementById("bibmap-container").innerHTML=`
      <div class="share-error">
        <p>${n.message==="This bib map is not published"?"This BibMap is not published or does not exist.":n.message}</p>
        <a href="/">Go to BibMap</a>
      </div>
    `}}async function mc(e,t){const n=document.getElementById("share-refs-panel"),r=document.getElementById("bibmap-container"),o=document.getElementById("share-refs-content"),a=document.getElementById("share-refs-node-name");a.textContent=`References for "${e.label}"`,o.innerHTML="<p>Loading references...</p>",n.hidden=!1,r.hidden=!0;try{const[i,s]=await Promise.all([K.nodes.getPublicReferences(e.id),K.nodes.getPublicMedia(e.id)]);if(i.length===0&&s.length===0){o.innerHTML="<p>No linked references or media found for this node.</p>";return}const l=[...i.map(h=>({...h,itemType:"reference"})),...s.map(h=>({...h,itemType:"media"}))];l.sort((h,g)=>new Date(g.created_at)-new Date(h.created_at));const u=l.map(h=>{var g,b;return h.itemType==="reference"?`
          <article class="reference-card" role="listitem">
            <h3>${re(h.title||h.bibtex_key)}</h3>
            <p class="authors">${re(h.author||"Unknown author")}</p>
            <p class="meta">
              ${h.year?`(${h.year})`:""}
              ${h.journal?`<em>${re(h.journal)}</em>`:""}
              ${h.booktitle?`In <em>${re(h.booktitle)}</em>`:""}
            </p>
            <div class="tags">
              ${((g=h.taxonomies)==null?void 0:g.map(m=>`
                <span class="tag" style="background: ${m.color}; color: white;">${re(m.name)}</span>
              `).join(""))||""}
            </div>
            ${h.doi?`<p class="meta"><a href="https://doi.org/${h.doi}" target="_blank" rel="noopener noreferrer">DOI: ${h.doi}</a></p>`:""}
            ${h.abstract?`<p class="abstract">${re(h.abstract.substring(0,300))}${h.abstract.length>300?"...":""}</p>`:""}
            ${xn(h.match_reasons)}
          </article>
        `:`
          <article class="reference-card media-card" role="listitem">
            <h3>${re(h.title)}</h3>
            <p class="meta"><a href="${re(h.url)}" target="_blank" rel="noopener noreferrer">${re(h.url)}</a></p>
            ${h.description?`<p class="description">${re(h.description)}</p>`:""}
            <div class="tags">
              ${((b=h.taxonomies)==null?void 0:b.map(m=>`
                <span class="tag" style="background: ${m.color}; color: white;">${re(m.name)}</span>
              `).join(""))||""}
            </div>
            ${xn(h.match_reasons)}
          </article>
        `}).join("");o.innerHTML=u}catch(i){o.innerHTML=`<p>Error loading references: ${i.message}</p>`}}function pc(e){let t={};if(e.settings_json)try{t=JSON.parse(e.settings_json)}catch{return}if(!t.showLegend)return;const n=t.legendLabels||{},r=e.nodes||[],o=new Map;if(r.forEach(l=>{const u=(l.background_color||"#3B82F6").toUpperCase();o.has(u)?o.get(u).count++:o.set(u,{color:u,count:1})}),o.size===0)return;const a=Array.from(o.values()).sort((l,u)=>u.count-l.count),i=document.getElementById("legend-items");i.innerHTML="";let s=1;a.forEach((l,u)=>{const h=n[l.color]||`Category ${s}`,g=ki(u),b=document.createElement("li");b.className="legend-item",b.innerHTML=`
      <span class="legend-color-indicator"
            style="background-color: ${l.color}"
            data-pattern="${g}"
            title="Pattern: ${g}"
            aria-label="Color indicator with ${g} pattern"></span>
      <span class="legend-label-readonly">${h}</span>
    `,i.appendChild(b),s++}),document.getElementById("legend-panel").hidden=!1}async function gc(){const e=hc();e?await fc(e):(uc(),tn("ref"),tn("import"),tn("node"),tn("media"),Cl(),await Bl(),await Sn(),await Ln(),await et(),await Ue(),ve("bibmaps"))}gc().catch(console.error);
